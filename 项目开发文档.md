# 驰达IT资产管理系统 (CDITAMS) 项目开发文档

## 一、项目背景与目标

### 1.1 项目背景

驰达IT资产管理系统（简称CDITAMS）是一款面向企业的IT资产全生命周期管理软件。该系统旨在帮助企业实现IT资产的规范化、信息化管理，解决传统资产管理中存在的账实不符、信息分散、管理效率低等问题。

随着企业规模的扩大和信息化程度的提高，IT设备数量急剧增长，传统的Excel表格或纸质台账管理方式已经无法满足现代企业的管理需求。CDITAMS系统通过数字化手段，实现了对IT资产的采购、入库、分配、使用、盘点、报废等全过程的跟踪管理。

### 1.2 项目目标

本系统的核心目标包括：

**资产管理目标**：
- 建立统一的IT资产台账，实现资产信息的集中管理
- 支持资产的分类管理，满足多级分类需求
- 提供灵活的字段自定义能力，适应不同企业的个性化需求
- 实现资产与使用人、部门、位置的关联管理

**组织管理目标**：
- 建立完整的组织架构管理体系
- 实现基于角色的权限控制
- 支持多级部门结构的树形展示和管理

**用户体验目标**：
- 提供响应式界面，支持PC端、移动端、平板端访问
- 界面友好，操作便捷，降低学习成本
- 功能模块化，易于扩展和维护

## 二、系统功能架构

### 2.1 功能模块总览

系统功能模块分为七大板块：

| 模块 | 功能描述 | 状态 |
|------|----------|------|
| 首页 | 欢迎页面、仪表盘展示 | 已完成 |
| 待办 | 待办事项管理、通知消息 | 规划中 |
| 资产 | 资产管理相关功能 | 已完成基础功能 |
| 盘点 | 资产盘点管理、微信扫码盘点 | 规划中 |
| 组织 | 组织架构管理（用户、部门、角色） | 已完成 |
| 设置 | 系统参数配置、企业信息 | 规划中 |
| 日志 | 操作日志记录、资产日志 | 规划中 |

### 2.2 资产模块详细功能

资产模块是系统的核心模块，包含以下子功能：

**设备管理**：
- 设备列表展示（支持分页、搜索、筛选）
- 设备新增、编辑、详情查看
- 设备删除（支持批量删除）
- 设备分配（批量分配给用户）
- 设备报障（批量标记故障）
- 设备报废（批量标记报废）
- 资产编号自动生成
- 打印资产标签
- 设备地图可视化展示

**软件管理**：
- 软件资产登记
- 软件授权管理
- 软件使用统计

**耗材管理**：
- 耗材库存管理
- 耗材领用记录

**服务管理**：
- IT服务请求管理
- 服务工单跟踪

**设备设置**：
- 资产分类管理（支持1-4级分类）
- 资产位置管理（支持1-4级位置）
- 设备字段自定义（系统字段+自定义字段）
- 字段显示顺序调整

### 2.3 组织模块详细功能

**用户管理**：
- 用户列表（支持搜索、按部门筛选、按角色筛选）
- 用户新增、编辑、删除
- 用户权限查看
- 用户状态管理（启用/禁用）
- 用户密码重置

**部门管理**：
- 部门树形结构展示
- 部门新增、编辑、删除
- 部门排序调整（拖拽）
- 部门编码管理

**角色管理**：
- 角色列表展示
- 角色新增、编辑、删除
- 角色权限分配（树形权限选择）

### 2.4 盘点模块详细功能

**盘点计划**：
- 创建盘点计划（支持全盘/抽盘/动态盘点）
- 设置盘点范围（按位置/分类/部门）
- 设置盘点时间

**盘点任务**：
- 自动生成盘点任务
- 任务分配给执行人
- 任务进度跟踪

**盘点执行**：
- PC端手工盘点
- 扫码盘点（微信小程序）
- 批量盘点

**盘点审核**：
- 审核盘点结果
- 差异处理（盘盈/盘亏/损毁）

**盘点报表**：
- 盘点统计报表
- 差异分析报表

### 2.5 待办模块详细功能

**我的待办**：
- 个人待办事项列表
- 待办创建/编辑/完成

**通知消息**：
- 系统通知接收
- 消息已读/未读状态

**任务提醒**：
- 到期提醒
- 逾期提醒

### 2.6 日志模块详细功能

**登录日志**：
- 登录/登出记录
- 登录失败记录

**操作日志**：
- 用户关键操作记录
- 多条件查询

**资产日志**：
- 资产变动历史
- 完整追溯链

### 2.7 设置模块详细功能

**基本信息**：
- 企业名称、Logo
- 联系方式

**系统参数**：
- 分页数量、文件大小
- 安全设置

**数据管理**：
- 数据备份
- 数据清理

### 2.8 认证模块

**登录功能**：
- 工号+密码登录
- 记住我功能
- 登录失败提示

**登出功能**：
- 安全退出
- 会话清理

## 三、数据模型设计

### 3.1 核心业务实体

**用户（User）**：
- 基本信息：工号、姓名、性别
- 联系方式：邮箱、电话
- 组织信息：所属部门、所属角色
- 状态信息：账户状态、创建时间、更新时间

**部门（Department）**：
- 基本信息：部门名称、部门编码
- 层级信息：上级部门（支持树形结构）
- 描述信息：部门描述、排序权重
- 时间信息：创建时间、更新时间

**角色（Role）**：
- 基本信息：角色名称、角色标识
- 描述信息：角色描述
- 关联信息：所拥有权限列表
- 时间信息：创建时间、更新时间

**权限（Permission）**：
- 基本信息：权限名称、权限标识
- 模块信息：所属业务模块
- 层级信息：父子权限关系
- 类型信息：页面权限/按钮权限

### 3.2 资产相关实体

**资产分类（AssetCategory）**：
- 基本信息：分类名称、分类编码
- 层级信息：分类级别（1-4级）、上级分类
- 描述信息：分类描述
- 时间信息：创建时间、更新时间

**设备（Device）**：
- 识别信息：资产编号（唯一）、设备编号、序列号
- 基本信息：设备名称、型号、状态、密级
- 归属信息：所属分类、使用人、所属部门、所在位置、工位
- 日期信息：购入日期、启用时间、安装时间
- 网络信息：MAC地址、IP地址、操作系统
- 扩展信息：硬盘序列号、用途、备注
- 财务信息：固资在账标识、卡片编号
- 保密信息：保密台账标识、台账分类
- 其他信息：二维码、位置文字描述
- 时间信息：创建时间、更新时间

**资产位置（AssetLocation）**：
- 基本信息：位置名称、位置编码
- 层级信息：位置级别（1-4级）、上级位置
- 编码信息：园区编码、设施编码、区域编码
- 描述信息：位置描述
- 地图信息：地图数据、X/Y坐标、是否有地图、画布尺寸
- 时间信息：创建时间、更新时间

**设备字段（DeviceField）**：
- 基本信息：字段名称、字段键名
- 类型信息：字段类型（文本、选择、日期、复选框等）
- 配置信息：是否必填、是否可见、下拉选项
- 排序信息：显示顺序

**设备字段值（DeviceFieldValue）**：
- 关联信息：设备ID、字段键名
- 值信息：字段值

### 3.3 实体关系图

```
用户 ←→ 部门    （多对一）
用户 ←→ 角色    （多对一）
角色 ←→ 权限    （多对多）

设备 ←→ 资产分类   （多对一）
设备 ←→ 用户      （多对一）
设备 ←→ 部门      （多对一）
设备 ←→ 资产位置  （多对一）
设备 ←→ 工位      （多对一）
设备 ←→ 设备字段值（一对多）

资产分类 ←→ 资产分类（自引用，树形结构）
资产位置 ←→ 资产位置（自引用，树形结构）
权限   ←→ 权限    （自引用，树形结构）
工位   ←→ 工位    （自引用，树形结构）
```

## 四、权限控制体系

### 4.1 权限类型

系统采用基于角色的访问控制（RBAC）模型，权限分为两种类型：

**页面权限**：
- 控制用户能否访问某个功能页面
- 例如：用户管理页面、部门管理页面

**按钮权限**：
- 控制用户能否执行某个操作
- 例如：新增按钮、编辑按钮、删除按钮

### 4.2 权限结构

权限采用树形结构组织，支持父子层级关系：

**组织模块权限树**：
```
组织
├── 用户管理
│   ├── 新增用户
│   ├── 编辑用户
│   ├── 删除用户
│   ├── 导入用户
│   └── 导出用户
├── 部门管理
│   ├── 新增部门
│   ├── 编辑部门
│   └── 删除部门
└── 角色管理
    ├── 新增角色
    ├── 编辑角色
    └── 删除角色
```

### 4.3 角色定义

**超级管理员**：
- 拥有系统所有权限
- 负责系统初始配置和用户管理
- 默认账号：工号86000001，密码password

### 4.4 权限控制流程

1. 用户登录时，系统根据用户关联的角色获取权限列表
2. 用户访问页面时，系统检查是否具有对应页面权限
3. 用户点击按钮时，系统检查是否具有对应操作权限
4. 无权限时拒绝访问并提示用户

## 五、界面设计

### 5.1 整体布局

系统采用侧边栏导航布局：

**侧边栏**：
- 系统Logo和名称
- 导航菜单（支持二级菜单展开/收起）
- 菜单项包括：首页、待办、资产、盘点、组织、设置、日志

**顶部栏**：
- 侧边栏折叠按钮
- 当前页面标题
- 用户下拉菜单（个人信息、修改密码、退出登录）

**内容区域**：
- 卡片式内容容器
- 功能操作区域
- 数据展示区域

### 5.2 响应式设计

系统支持三种设备类型的响应式显示：

**桌面端**：
- 完整侧边栏显示
- 表格多列显示
- 完整功能按钮

**平板端**：
- 侧边栏可折叠
- 表格自适应列宽
- 功能按钮精简

**移动端**：
- 侧边栏隐藏（hamburger菜单触发）
- 表格单列或卡片式展示
- 核心功能按钮

### 5.3 核心页面设计

**登录页面**：
- 系统Logo和名称
- 工号输入框
- 密码输入框
- 记住我复选框
- 登录按钮

**设备列表页面**：
- 搜索栏
- 批量操作按钮区（删除、分配、报障、报废）
- 功能按钮区（刷新、筛选、打印标签、设备地图、新增、导入、导出、设置）
- 数据表格（支持列动态显示、排序、分页）
- 复选框列（支持全选）

**设备表单页面**：
- 分类选择器
- 资产编号输入（支持自动生成）
- 动态字段表单（根据字段配置生成）
- 提交按钮

**组织管理页面**：
- 用户管理：表格列表+搜索筛选
- 部门管理：树形结构展示+拖拽排序
- 角色管理：表格列表+权限树选择

## 六、核心业务流程

### 6.1 资产新增流程

1. 用户点击"新增"按钮
2. 系统显示设备表单页面
3. 用户选择资产分类
4. 系统根据分类自动生成资产编号
5. 用户填写设备相关信息
6. 用户点击保存
7. 系统验证必填项
8. 系统保存设备信息
9. 返回成功提示

### 6.2 资产编号生成规则

资产编号采用"分类编码-序号"的格式：

例如：选择"台式机"分类（编码DJ-01）后，系统自动生成编号"DJ-01-001"

生成规则说明：
- 收集分类及其所有父级分类的编码
- 编码间用"-"连接
- 查找同前缀的最大编号，序号自动递增
- 序号不足3位前面补0

### 6.3 部门管理流程

1. 管理员进入部门管理页面
2. 查看部门树形结构
3. 可进行新增同级/下级部门
4. 可编辑部门信息
5. 可拖拽调整部门顺序和层级
6. 删除时检查是否有子部门和关联用户

### 6.4 权限分配流程

1. 管理员进入角色管理
2. 新增或编辑角色
3. 在权限树中选择需要的权限
4. 保存角色信息
5. 将角色分配给用户

## 七、设备地图可视化方案

### 7.1 位置层级重新设计

将现有"资产位置"扩展为4级层级结构：

| 级别 | 名称 | 示例 | 说明 |
|------|------|------|------|
| 1级 | 园区 | 产业园区 | 最高层级，每个园区有独立编码 |
| 2级 | 设施 | 办公楼A栋、生产车间 | 园区内的建筑物 |
| 3级 | 区域 | 3楼、B区 | 设施内的区域（楼层/区域） |
| 4级 | 房间 | A302室 | 区域内的具体房间/办公区 |

**位置编码规则**：
- 园区编码：2位，如"CY"（产业）、"CG"（草滩）
- 设施编码：2位，第1位设施类型(O=Office办公, P=Production生产, D=Dorm宿舍)，第2位序号(A、B、C...)
- 区域编码：2位，如"03"（3楼）、"B1"（B区1号）
- 房间编码：自定，如"A302"

### 7.2 新增数据模型

#### 7.2.1 工位表(Workstation)

```python
class Workstation(db.Model):
    __tablename__ = 'workstations'
    
    id = db.Column(db.Integer, primary_key=True)
    location_id = db.Column(db.Integer, db.ForeignKey('asset_locations.id'))  # 所属位置(4级)
    workstation_code = db.Column(db.String(10), unique=True)  # 工位编号 如:CYOA03001
    name = db.Column(db.String(64))  # 工位名称 如:A302-XGAA001
    x = db.Column(db.Float)           # 地图X坐标
    y = db.Column(db.Float)           # 地图Y坐标
    width = db.Column(db.Float, default=30)   # 工位宽度
    height = db.Column(db.Float, default=20)  # 工位高度
    status = db.Column(db.String(20), default='available')  # 状态: available/occupied/maintenance
    description = db.Column(db.Text)  # 描述
    created_at = db.Column(db.DateTime, default=datetime.utcnow)
    updated_at = db.Column(db.DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)
    
    devices = db.relationship('Device', back_populates='workstation')
    location = db.relationship('AssetLocation', backref='workstations')
```

#### 7.2.2 地图元素表(MapElement)

```python
class MapElement(db.Model):
    __tablename__ = 'map_elements'
    
    id = db.Column(db.Integer, primary_key=True)
    location_id = db.Column(db.Integer, db.ForeignKey('asset_locations.id'))  # 所属位置
    element_type = db.Column(db.String(20))  # 元素类型: wall/door/window/desk/equipment
    x = db.Column(db.Float)           # 起点X坐标
    y = db.Column(db.Float)           # 起点Y坐标
    x2 = db.Column(db.Float)          # 终点X坐标(墙用)
    y2 = db.Column(db.Float)          # 终点Y坐标(墙用)
    width = db.Column(db.Float)       # 宽度
    height = db.Column(db.Float)      # 高度
    rotation = db.Column(db.Float)    # 旋转角度
    color = db.Column(db.String(7))   # 颜色 (#RRGGBB)
    thickness = db.Column(db.Integer, default=2)  # 线条粗细
    points = db.Column(db.Text)       # 自定义点集(JSON)用于复杂图形
    properties = db.Column(db.Text)   # 其他属性(JSON)
    sort_order = db.Column(db.Integer, default=0)  # 渲染顺序
    created_at = db.Column(db.DateTime, default=datetime.utcnow)
    updated_at = db.Column(db.DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)
```

#### 7.2.3 底图表(MapBackground)

```python
class MapBackground(db.Model):
    __tablename__ = 'map_backgrounds'
    
    id = db.Column(db.Integer, primary_key=True)
    location_id = db.Column(db.Integer, db.ForeignKey('asset_locations.id'), unique=True)
    bg_type = db.Column(db.String(20))  # 类型: image/cad/svg
    file_path = db.Column(db.String(256))  # 文件路径
    file_data = db.Column(db.LargeBinary)  # 文件二进制数据(小图)
    scale = db.Column(db.Float, default=1.0)  # 缩放比例
    offset_x = db.Column(db.Float, default=0)  # X偏移
    offset_y = db.Column(db.Float, default=0)  # Y偏移
    opacity = db.Column(db.Float, default=1.0)  # 透明度
    created_at = db.Column(db.DateTime, default=datetime.utcnow)
    updated_at = db.Column(db.DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)
```

#### 7.2.4 扩展AssetLocation表

```python
class AssetLocation(db.Model):
    # ... 现有字段 ...
    level = db.Column(db.Integer, default=1)  # 1-4级位置
    park_code = db.Column(db.String(2))       # 园区编码
    building_code = db.Column(db.String(2))    # 设施编码  
    floor_code = db.Column(db.String(2))       # 区域编码
    has_map = db.Column(db.Boolean, default=False)  # 是否有地图
    map_width = db.Column(db.Integer, default=1200)  # 地图画布宽度
    map_height = db.Column(db.Integer, default=800)  # 地图画布高度
```

#### 7.2.5 扩展Device表

```python
class Device(db.Model):
    # ... 现有字段 ...
    workstation_id = db.Column(db.Integer, db.ForeignKey('workstations.id'))  # 工位ID
    location_text = db.Column(db.String(256))  # 位置文字描述 如:CY-OA-03-A302-XGAA001
```

### 7.3 地图编辑器功能设计

#### 7.3.1 编辑器工具栏

- **选择工具**：选中元素进行移动、缩放、旋转
- **绘图工具**：
  - 画墙（拖拽绘制直线）
  - 画门（点击放置，支持左开/右开）
  - 画窗（点击放置）
  - 画工位（拖拽绘制矩形）
- **辅助工具**：
  - 标尺/网格开关
  - 吸附对齐
  - 撤销/重做
  - 放大/缩小/适应画布
- **底图工具**：
  - 上传图片/CAD
  - 清除底图
  - 调整透明度

#### 7.3.2 门插入墙自动处理

- 画门时自动检测与墙的交叉
- 门两侧自动生成门垛
- 支持门开方向设置（左开/右开/推拉）

### 7.4 工位管理

#### 7.4.1 工位编号生成规则

```
工位编号 = 园区编码(2位) + 设施编码(2位) + 区域编码(2位) + 序号(3位)
例如：CY(产业园区) + OA(办公楼A) + 03(3楼) + 001 = CYXOA03001
```

#### 7.4.2 工位创建方式

- **手动绘制**：在地图编辑器中拖拽绘制
- **批量生成**：设置行列数和间距，自动生成规则排列的工位

#### 7.4.3 设备绑定

- 设备绑定工位后，自动生成位置文字描述
- 位置文字格式：`{园区名称}-{设施名称}-{区域名称}-{房间名称}-{工位编号}`

### 7.5 地图查看功能

- 位置导航树：园区 → 设施 → 区域 → 房间
- 鼠标悬停显示设备信息
- 点击工位弹出设备列表
- 设备状态颜色区分（绿色正常、黄色维修、红色故障）

## 八、盘点管理方案

### 8.1 数据模型设计

#### 8.1.1 盘点计划表

```python
class InventoryPlan(db.Model):
    __tablename__ = 'inventory_plans'
    
    id = db.Column(db.Integer, primary_key=True)
    name = db.Column(db.String(128), nullable=False)  # 计划名称
    plan_no = db.Column(db.String(32), unique=True)  # 计划编号
    plan_type = db.Column(db.String(20))  # 计划类型: 全盘/抽盘/动态盘点
    scope = db.Column(db.Text)  # 盘点范围描述
    location_ids = db.Column(db.Text)  # 涉及位置ID列表(JSON)
    category_ids = db.Column(db.Text)  # 涉及分类ID列表(JSON)
    status = db.Column(db.String(20), default='draft')  # 状态
    scheduled_start = db.Column(db.DateTime)  # 计划开始时间
    scheduled_end = db.Column(db.DateTime)  # 计划结束时间
    actual_start = db.Column(db.DateTime)  # 实际开始时间
    actual_end = db.Column(db.DateTime)  # 实际结束时间
    creator_id = db.Column(db.Integer, db.ForeignKey('users.id'))
    created_at = db.Column(db.DateTime, default=datetime.utcnow)
```

#### 8.1.2 盘点任务表

```python
class InventoryTask(db.Model):
    __tablename__ = 'inventory_tasks'
    
    id = db.Column(db.Integer, primary_key=True)
    plan_id = db.Column(db.Integer, db.ForeignKey('inventory_plans.id'), nullable=False)
    task_no = db.Column(db.String(32), unique=True)  # 任务编号
    location_id = db.Column(db.Integer, db.ForeignKey('asset_locations.id'))
    category_id = db.Column(db.Integer, db.ForeignKey('asset_categories.id'))
    device_count = db.Column(db.Integer, default=0)  # 应盘数量
    checked_count = db.Column(db.Integer, default=0)  # 已盘数量
    status = db.Column(db.String(20), default='pending')  # 状态
    assignee_id = db.Column(db.Integer, db.ForeignKey('users.id'))  # 负责人
    due_date = db.Column(db.DateTime)  # 截止时间
    completed_at = db.Column(db.DateTime)  # 完成时间
```

#### 8.1.3 盘点记录表

```python
class InventoryRecord(db.Model):
    __tablename__ = 'inventory_records'
    
    id = db.Column(db.Integer, primary_key=True)
    task_id = db.Column(db.Integer, db.ForeignKey('inventory_tasks.id'), nullable=False)
    device_id = db.Column(db.Integer, db.ForeignKey('devices.id'), nullable=False)
    device_status = db.Column(db.String(20))  # 盘点时设备状态
    location_status = db.Column(db.String(20))  # 位置状态: 在位/搬离/未找到
    asset_status = db.Column(db.String(20))  # 资产状态: 正常/损坏/丢失
    remarks = db.Column(db.Text)  # 备注
    photo_path = db.Column(db.String(256))  # 现场照片路径
    checked_at = db.Column(db.DateTime, default=datetime.utcnow)  # 盘点时间
    checked_by = db.Column(db.Integer, db.ForeignKey('users.id'))  # 盘点人
    source = db.Column(db.String(20), default='manual')  # 来源: manual/wechat
```

### 8.2 盘点流程

```
1. 创建盘点计划
   ↓
2. 设置盘点范围（位置/分类/时间）
   ↓
3. 生成盘点任务（按位置/按人分配）
   ↓
4. 执行盘点（微信扫码/手工录入）
   ↓
5. 审核盘点结果
   ↓
6. 处理差异（盘盈/盘亏/损毁）
   ↓
7. 盘点归档，生成报表
```

### 8.3 盘点类型

| 类型 | 说明 |
|------|------|
| 全盘 | 对所有资产进行全面盘点 |
| 抽盘 | 按比例随机抽取部分资产盘点 |
| 动态盘点 | 实时盘点，扫码即盘 |

## 九、微信小程序扫码盘点方案

### 9.1 二维码设计

```json
{
    "type": "device",
    "id": 12345,
    "code": "DJ-01-001",
    "verify": "md5hash"
}
```

二维码URL：`https://域名/device/scan/{device_id}?from=wechat`

### 9.2 微信小程序功能架构

```
┌─────────────────────────────────────────────┐
│              微信小程序                       │
├─────────────────────────────────────────────┤
│  首页          │  扫码       │  我的          │
│  - 盘点任务   │  - 扫码识别 │  - 待盘点     │
│  - 盘点记录   │  - 设备信息 │  - 已盘点     │
│  - 盘点统计   │  - 一键盘点 │  - 设置       │
└─────────────────────────────────────────────┘
```

### 9.3 核心API设计

| API | 说明 |
|-----|------|
| GET /api/inventory/tasks | 获取盘点任务列表 |
| GET /api/devices/qrcode/{qrcode_data} | 扫码识别设备 |
| POST /api/inventory/records | 提交盘点记录 |
| GET /api/devices/{id}/public | 获取设备信息网页 |

### 9.4 设备标签设计

- 尺寸：30mm x 30mm 或 40mm x 40mm
- 包含内容：二维码、资产编号、设备名称
- 支持批量打印、导出PDF

### 9.5 设备信息网页

扫描二维码打开的网页包含：
- 设备基本信息（名称、编号、型号、位置、使用人）
- 快速操作按钮（一键盘点、报障）
- 历史记录（盘点记录、维修记录）

## 十、待办系统方案

### 10.1 数据模型设计

```python
# 待办类型枚举
class TodoType:
    PERSONAL = 'personal'       # 个人待办
    ASSET_APPROVAL = 'asset_approval'   # 资产审批
    MAINTENANCE = 'maintenance'         # 维修审批
    INVENTORY = 'inventory'              # 盘点任务
    TRANSFER = 'transfer'                # 资产调拨审批

# 待办事项表
class Todo(db.Model):
    __tablename__ = 'todos'
    
    id = db.Column(db.Integer, primary_key=True)
    title = db.Column(db.String(256), nullable=False)  # 待办标题
    content = db.Column(db.Text)  # 待办内容
    todo_type = db.Column(db.String(32))  # 待办类型
    priority = db.Column(db.String(16), default='normal')  # 优先级
    status = db.Column(db.String(16), default='pending')  # 状态
    due_date = db.Column(db.DateTime)  # 截止时间
    remind_time = db.Column(db.DateTime)  # 提醒时间
    assignee_id = db.Column(db.Integer, db.ForeignKey('users.id'))
    creator_id = db.Column(db.Integer, db.ForeignKey('users.id'))
    related_type = db.Column(db.String(32))  # 关联类型
    related_id = db.Column(db.Integer)  # 关联ID
    completed_at = db.Column(db.DateTime)
    created_at = db.Column(db.DateTime, default=datetime.utcnow)

# 通知消息表
class Notification(db.Model):
    __tablename__ = 'notifications'
    
    id = db.Column(db.Integer, primary_key=True)
    user_id = db.Column(db.Integer, db.ForeignKey('users.id'), nullable=False)
    title = db.Column(db.String(256))  # 通知标题
    content = db.Column(db.Text)  # 通知内容
    notification_type = db.Column(db.String(32))  # 通知类型
    is_read = db.Column(db.Boolean, default=False)  # 是否已读
    read_at = db.Column(db.DateTime)  # 阅读时间
    related_type = db.Column(db.String(32))  # 关联类型
    related_id = db.Column(db.Integer)  # 关联ID
    created_at = db.Column(db.DateTime, default=datetime.utcnow)
```

### 10.2 触发场景

| 触发场景 | 生成待办 |
|----------|----------|
| 资产审批 | 审批人收到审批待办 |
| 盘点任务 | 盘点任务分配给执行人 |
| 设备报障 | 维修人员收到维修待办 |
| 资产调拨 | 调拨双方收到调拨待办 |
| 资产归还 | 资产归还到期提醒 |

## 十一、日志管理方案

### 11.1 数据模型设计

```python
# 日志类型枚举
class LogType:
    LOGIN = 'login'       # 登录日志
    LOGOUT = 'logout'     # 登出日志
    OPERATION = 'operation'  # 操作日志
    ERROR = 'error'       # 错误日志
    SECURITY = 'security' # 安全日志

# 系统日志表
class SystemLog(db.Model):
    __tablename__ = 'system_logs'
    
    id = db.Column(db.Integer, primary_key=True)
    user_id = db.Column(db.Integer, db.ForeignKey('users.id'))
    username = db.Column(db.String(64))  # 操作人账号（脱敏存储）
    log_type = db.Column(db.String(32))  # 日志类型
    action = db.Column(db.String(128))  # 操作动作
    module = db.Column(db.String(64))  # 操作模块
    method = db.Column(db.String(32))  # 请求方法
    ip_address = db.Column(db.String(45))  # IP地址
    user_agent = db.Column(db.String(512))  # 用户代理
    request_url = db.Column(db.String(512))  # 请求URL
    request_data = db.Column(db.Text)  # 请求参数（脱敏）
    response_status = db.Column(db.Integer)  # 响应状态码
    error_message = db.Column(db.Text)  # 错误信息
    created_at = db.Column(db.DateTime, default=datetime.utcnow, index=True)

# 资产变动日志表
class AssetLog(db.Model):
    __tablename__ = 'asset_logs'
    
    id = db.Column(db.Integer, primary_key=True)
    device_id = db.Column(db.Integer, db.ForeignKey('devices.id'), nullable=False)
    user_id = db.Column(db.Integer, db.ForeignKey('users.id'))
    action = db.Column(db.String(64))  # 变动类型
    field_name = db.Column(db.String(64))  # 变动字段
    old_value = db.Column(db.Text)  # 旧值
    new_value = db.Column(db.Text)  # 新值
    remarks = db.Column(db.Text)  # 备注
    created_at = db.Column(db.DateTime, default=datetime.utcnow, index=True)
```

### 11.2 记录的敏感操作

| 模块 | 记录的操作 |
|------|------------|
| 用户管理 | 登录、登出、密码修改、用户增删改 |
| 资产管理 | 资产增删改、分配、转移、报废 |
| 盘点管理 | 盘点任务创建、执行、审核 |
| 系统设置 | 参数修改、权限变更 |

## 十二、系统设置方案

### 12.1 数据模型设计

```python
# 系统配置表
class SystemConfig(db.Model):
    __tablename__ = 'system_configs'
    
    id = db.Column(db.Integer, primary_key=True)
    config_key = db.Column(db.String(64), unique=True, nullable=False, index=True)
    config_value = db.Column(db.Text)  # 配置值
    value_type = db.Column(db.String(16))  # 值类型: string/int/json/boolean
    config_group = db.Column(db.String(32))  # 配置分组
    description = db.Column(db.String(256))  # 说明
    is_system = db.Column(db.Boolean, default=False)  # 系统级配置不可修改
    created_at = db.Column(db.DateTime, default=datetime.utcnow)
    updated_at = db.Column(db.DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)

# 组织信息表（企业信息）
class Organization(db.Model):
    __tablename__ = 'organizations'
    
    id = db.Column(db.Integer, primary_key=True)
    name = db.Column(db.String(128), nullable=False)  # 企业名称
    short_name = db.Column(db.String(64))  # 简称
    code = db.Column(db.String(32), unique=True)  # 企业编码
    logo = db.Column(db.String(256))  # Logo路径
    contact_person = db.Column(db.String(64))  # 联系人
    contact_phone = db.Column(db.String(20))  # 联系电话
    contact_email = db.Column(db.String(120))  # 联系邮箱
    address = db.Column(db.String(256))  # 地址
    website = db.Column(db.String(128))  # 网站
    description = db.Column(db.Text)  # 简介
    created_at = db.Column(db.DateTime, default=datetime.utcnow)
```

### 12.2 系统配置项

| 配置项 | 说明 | 默认值 |
|--------|------|--------|
| company_name | 企业名称 | 驰达 |
| items_per_page | 默认分页数 | 10 |
| max_file_size | 上传文件大小限制(MB) | 10 |
| session_timeout | 会话超时时间(分钟) | 120 |
| password_min_length | 密码最小长度 | 6 |
| asset_code_prefix | 资产编号前缀 | DJ |
| enable_wechat | 启用微信功能 | false |
| wechat_appid | 微信AppID | - |

## 十三、软件管理方案

### 13.1 数据模型设计

```python
# 软件分类表
class SoftwareCategory(db.Model):
    __tablename__ = 'software_categories'
    
    id = db.Column(db.Integer, primary_key=True)
    name = db.Column(db.String(64), nullable=False)
    parent_id = db.Column(db.Integer, db.ForeignKey('software_categories.id'))
    description = db.Column(db.Text)
    created_at = db.Column(db.DateTime, default=datetime.utcnow)

# 软件资产表
class Software(db.Model):
    __tablename__ = 'software'
    
    id = db.Column(db.Integer, primary_key=True)
    name = db.Column(db.String(128), nullable=False)
    category_id = db.Column(db.Integer, db.ForeignKey('software_categories.id'))
    version = db.Column(db.String(32))  # 版本
    vendor = db.Column(db.String(128))  # 供应商
    license_type = db.Column(db.String(32))  # 授权类型
    license_count = db.Column(db.Integer)  # 授权数量
    license_used = db.Column(db.Integer, default=0)  # 已使用数量
    purchase_date = db.Column(db.Date)  # 购买日期
    expire_date = db.Column(db.Date)  # 到期日期
    price = db.Column(db.Numeric(10, 2))  # 价格

# 软件授权明细表
class SoftwareLicense(db.Model):
    __tablename__ = 'software_licenses'
    
    id = db.Column(db.Integer, primary_key=True)
    software_id = db.Column(db.Integer, db.ForeignKey('software.id'), nullable=False)
    device_id = db.Column(db.Integer, db.ForeignKey('devices.id'))
    user_id = db.Column(db.Integer, db.ForeignKey('users.id'))
    license_key = db.Column(db.String(256))  # 授权密钥
    install_count = db.Column(db.Integer, default=1)  # 已安装次数
    assigned_at = db.Column(db.DateTime, default=datetime.utcnow)
```

## 十四、耗材管理方案

### 14.1 数据模型设计

```python
# 耗材分类表
class ConsumableCategory(db.Model):
    __tablename__ = 'consumable_categories'
    
    id = db.Column(db.Integer, primary_key=True)
    name = db.Column(db.String(64), nullable=False)
    parent_id = db.Column(db.Integer, db.ForeignKey('consumable_categories.id'))
    description = db.Column(db.Text)

# 耗材物资表
class Consumable(db.Model):
    __tablename__ = 'consumables'
    
    id = db.Column(db.Integer, primary_key=True)
    name = db.Column(db.String(128), nullable=False)
    category_id = db.Column(db.Integer, db.ForeignKey('consumable_categories.id'))
    code = db.Column(db.String(32))  # 耗材编码
    specification = db.Column(db.String(128))  # 规格型号
    unit = db.Column(db.String(16))  # 单位
    stock_quantity = db.Column(db.Integer, default=0)  # 库存数量
    min_stock = db.Column(db.Integer, default=0)  # 最低库存预警
    price = db.Column(db.Numeric(10, 2))  # 单价

# 耗材领用记录表
class ConsumableRecord(db.Model):
    __tablename__ = 'consumable_records'
    
    id = db.Column(db.Integer, primary_key=True)
    consumable_id = db.Column(db.Integer, db.ForeignKeys('consumables.id'), nullable=False)
    user_id = db.Column(db.Integer, db.ForeignKey('users.id'))
    department_id = db.Column(db.Integer, db.ForeignKey('departments.id'))
    quantity = db.Column(db.Integer, nullable=False)  # 领用数量
    record_type = db.Column(db.String(16))  # 记录类型
    purpose = db.Column(db.String(256))  # 用途
    approved_by = db.Column(db.Integer, db.ForeignKey('users.id'))
    created_at = db.Column(db.DateTime, default=datetime.utcnow)
```

## 十五、服务管理方案

### 15.1 数据模型设计

```python
# 服务类型表
class ServiceType(db.Model):
    __tablename__ = 'service_types'
    
    id = db.Column(db.Integer, primary_key=True)
    name = db.Column(db.String(64), nullable=False)
    description = db.Column(db.Text)
    sla_hours = db.Column(db.Integer, default=24)  # SLA响应时限

# 服务请求表
class ServiceRequest(db.Model):
    __tablename__ = 'service_requests'
    
    id = db.Column(db.Integer, primary_key=True)
    request_no = db.Column(db.String(32), unique=True)  # 请求编号
    title = db.Column(db.String(256), nullable=False)
    service_type_id = db.Column(db.Integer, db.ForeignKey('service_types.id'))
    description = db.Column(db.Text)
    priority = db.Column(db.String(16), default='normal')
    status = db.Column(db.String(16), default='pending')
    requester_id = db.Column(db.Integer, db.ForeignKey('users.id'))
    assignee_id = db.Column(db.Integer, db.ForeignKey('users.id'))
    device_id = db.Column(db.Integer, db.ForeignKey('devices.id'))
    due_date = db.Column(db.DateTime)
    solved_at = db.Column(db.DateTime)
    rating = db.Column(db.Integer)  # 评价评分 1-5
    feedback = db.Column(db.Text)  # 评价反馈

# 服务处理记录表
class ServiceLog(db.Model):
    __tablename__ = 'service_logs'
    
    id = db.Column(db.Integer, primary_key=True)
    request_id = db.Column(db.Integer, db.ForeignKey('service_requests.id'), nullable=False)
    handler_id = db.Column(db.Integer, db.ForeignKey('users.id'))
    action = db.Column(db.String(64))  # 处理动作
    content = db.Column(db.Text)  # 处理内容
    created_at = db.Column(db.DateTime, default=datetime.utcnow)
```

## 十六、模块功能规划汇总

| 模块 | 子模块 | 功能状态 | 优先级 |
|------|--------|----------|--------|
| 首页 | 仪表盘 | 已完成 | P0 |
| 待办 | 待办管理 | 待开发 | P1 |
| 待办 | 通知消息 | 待开发 | P2 |
| 资产 | 设备管理 | 已完成基础 | P0 |
| 资产 | 软件管理 | 待开发 | P2 |
| 资产 | 耗材管理 | 待开发 | P2 |
| 资产 | 服务管理 | 待开发 | P2 |
| 资产 | 设备地图 | 待开发 | P1 |
| 盘点 | 盘点计划 | 待开发 | P1 |
| 盘点 | 盘点执行 | 待开发 | P1 |
| 盘点 | 盘点审核 | 待开发 | P1 |
| 盘点 | 微信盘点 | 待开发 | P1 |
| 组织 | 用户管理 | 已完成 | P0 |
| 组织 | 部门管理 | 已完成 | P0 |
| 组织 | 角色管理 | 已完成 | P0 |
| 设置 | 系统配置 | 待开发 | P2 |
| 设置 | 企业信息 | 待开发 | P2 |
| 日志 | 操作日志 | 待开发 | P2 |
| 日志 | 资产日志 | 待开发 | P2 |
| 日志 | 登录日志 | 待开发 | P2 |

## 十七、系统管理

### 17.1 默认数据

系统初始化时创建以下默认数据：

**权限数据**：
- 首页权限
- 组织模块完整权限树
- 资产模块基础权限（待完善）

**角色数据**：
- 超级管理员（拥有所有权限）

**用户数据**：
- 超级管理员用户（工号：86000001，密码：password）

### 17.2 数据初始化流程

系统启动时自动执行初始化：

1. 创建数据库表结构
2. 插入默认权限数据
3. 创建默认角色并分配权限
4. 创建超级管理员账户（如果不存在）

## 十八、系统特性总结

### 18.1 核心特性

1. **全生命周期管理**：从资产采购到报废的完整跟踪
2. **灵活的自定义能力**：支持自定义字段和字段排序
3. **树形结构支持**：部门和分类均支持多级树形结构
4. **权限精细控制**：支持页面级和按钮级权限控制
5. **响应式设计**：支持多设备访问
6. **自动化编号**：资产编号自动生成
7. **可视化地图**：支持工位地图绘制和设备定位
8. **移动盘点**：支持微信小程序扫码盘点

### 18.2 设计原则

1. **模块化设计**：功能模块独立，便于扩展
2. **配置优先**：重要功能可配置，适应不同企业需求
3. **安全优先**：服务器端验证，确保数据安全
4. **用户体验**：简洁直观的界面设计
5. **移动优先**：支持移动端扫码盘点

---

## 十九、位置层级与平面图绑定方案

### 19.1 需求概述

位置层级采用4级结构：
- 1级：园区
- 2级：设施（建筑）
- 3级：楼层/区域
- 4级：房间

**核心需求**：
- 新建4级房间区域时，无需开启平面图绘制
- 平面图仅在3级楼层绘制
- 4级房间/区域可在上级3级平面图内通过多边形画线绑定对应区域

### 19.2 数据模型设计

#### 19.2.1 区域绑定表（LocationAreaBinding）

用于存储4级房间在3级楼层平面图中的区域范围：

```python
class LocationAreaBinding(models.Model):
    id = models.AutoField(primary_key=True)
    location_id = models.IntegerField(verbose_name='4级位置ID')  # 绑定的4级房间位置
    parent_location_id = models.IntegerField(verbose_name='3级位置ID')  # 上级3级楼层位置
    area_points = models.TextField(verbose_name='区域坐标点(JSON)')  # 多边形坐标点集合
    area_color = models.CharField(max_length=7, default='#3498db', verbose_name='区域颜色')
    area_name = models.CharField(max_length=64, verbose_name='区域名称')
    description = models.TextField(blank=True, verbose_name='描述')
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        db_table = 'location_area_bindings'
        verbose_name = '位置区域绑定'
        verbose_name_plural = '位置区域绑定'
```

### 19.3 功能设计

#### 19.3.1 位置新建逻辑

| 级别 | 平面图选项 | 说明 |
|------|------------|------|
| 1级园区 | 不显示 | 无需平面图 |
| 2级设施 | 显示 | 可选择是否绘制平面图 |
| 3级楼层 | 显示（必选） | 必须绘制平面图，用于绑定下级4级房间区域 |
| 4级房间 | 不显示 | 无需新建平面图，通过多边形绑定方式关联 |

#### 19.3.2 4级房间区域绑定流程

1. 在3级楼层的平面图页面，增加"绑定房间区域"功能入口
2. 选择需要绑定的4级房间位置（从下级位置列表选择）
3. 使用多边形画线工具在平面图上绘制房间区域
4. 保存区域绑定信息
5. 绑定后的区域可显示在平面图上，点击可查看该区域内的设备

#### 19.3.3 多边形绑定UI设计

- **入口位置**：3级楼层平面图页面
- **操作流程**：
  1. 点击"绑定房间"按钮
  2. 弹出房间选择对话框（显示所有未绑定或已绑定的4级下级房间）
  3. 选择房间后，进入多边形绘制模式
  4. 用户点击画布绘制多边形顶点
  5. 双击完成绘制
  6. 保存绑定关系

#### 19.3.4 区域显示与交互

- 4级房间绑定的区域以半透明颜色显示在3级平面图上
- 鼠标悬停显示区域名称和位置信息
- 点击区域可跳转到对应4级房间的设备列表

### 19.4 技术实现要点

#### 19.4.1 前端实现

1. 在3级平面图页面增加房间绑定功能按钮
2. 实现多边形绘制组件（基于Canvas或SVG）
3. 保存区域坐标点为JSON格式

#### 19.4.2 后端实现

1. 新增LocationAreaBinding模型
2. 新增区域绑定API接口
3. 修改位置新建接口，4级不显示平面图选项
4. 修改平面图获取接口，返回绑定的区域数据

---

**文档版本**：1.2
**编制日期**：2026年2月13日
**所属公司**：西安驰达
