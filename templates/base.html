<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}驰达IT资产管理系统{% endblock %}</title>
    <link href="https://cdn.bootcdn.net/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --sidebar-width: 240px;
            --sidebar-collapsed-width: 70px;
            --header-height: 60px;
        }
        body { font-family: "Microsoft YaHei", Arial, sans-serif; }
        .sidebar { width: var(--sidebar-width); position: fixed; top: 0; left: 0; height: 100vh; background: #2c3e50; z-index: 1000; transition: width 0.3s; overflow-x: hidden; }
        .sidebar.collapsed { width: var(--sidebar-collapsed-width); }
        .sidebar .logo { height: var(--header-height); display: flex; align-items: center; padding: 0 20px; color: #fff; font-size: 18px; font-weight: bold; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .sidebar .logo i { margin-right: 10px; }
        .sidebar .nav-item { display: block; }
        .sidebar .nav-link { color: rgba(255,255,255,0.8); padding: 12px 20px; display: flex; align-items: center; text-decoration: none; transition: all 0.2s; }
        .sidebar .nav-link:hover { background: rgba(255,255,255,0.1); color: #fff; }
        .sidebar .nav-link i { width: 24px; margin-right: 12px; text-align: center; }
        .sidebar .nav-link .fa-chevron-down { transition: transform 0.3s; }
        .sidebar .nav-link span { white-space: nowrap; }
        .sidebar .submenu { background: rgba(0,0,0,0.2); display: none; }
        .sidebar .submenu.show { display: block; }
        .sidebar .submenu .nav-link { padding-left: 56px; font-size: 14px; }
        
        .main-content { margin-left: var(--sidebar-width); transition: margin-left 0.3s; min-height: 100vh; }
        .main-content.expanded { margin-left: var(--sidebar-collapsed-width); }
        
        .header { height: var(--header-height); background: #fff; border-bottom: 1px solid #e0e0e0; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; }
        .header .toggle-btn { background: none; border: none; font-size: 20px; cursor: pointer; }
        .header .user-menu { display: flex; align-items: center; gap: 15px; }
        
        .content { padding: 20px; }
        
        .card { border: none; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .card .card-header { background: #fff; border-bottom: 1px solid #f0f0f0; font-weight: 600; }
        
        .stat-card { border-radius: 8px; padding: 20px; color: #fff; }
        .stat-card i { font-size: 32px; opacity: 0.8; }
        .stat-card .stat-value { font-size: 28px; font-weight: bold; margin: 10px 0; }
        .stat-card .stat-label { font-size: 14px; opacity: 0.9; }
        
        .table th { font-weight: 600; background: #f8f9fa; }
        
        .btn-group-xs .btn { padding: 2px 8px; font-size: 12px; }
        
        .tree-node { padding-left: 20px; }
        .tree-node .tree-item { padding: 8px 12px; border-radius: 4px; cursor: pointer; }
        .tree-node .tree-item:hover { background: #f5f5f5; }
        
        .form-label { font-weight: 500; }
        
        .page-item.active .page-link { background-color: #3498db; border-color: #3498db; }
        .page-link { color: #3498db; }
        
        @media (max-width: 768px) {
            .sidebar { width: var(--sidebar-collapsed-width); }
            .sidebar .logo span, .sidebar .nav-link span { display: none; }
            .main-content { margin-left: var(--sidebar-collapsed-width); }
        }
    </style>
    {% block extra_css %}{% endblock %}
</head>
<body>
    {% if user.is_authenticated %}
    <div class="sidebar" id="sidebar">
        <div class="logo">
            <i class="fas fa-server"></i>
            <span>CDITAMS</span>
        </div>
        <nav class="mt-3">
            <a href="{% url 'dashboard' %}" class="nav-link {% if request.path == '/dashboard/' %}active{% endif %}">
                <i class="fas fa-home"></i>
                <span>首页</span>
            </a>
            
            <div class="nav-item">
                <a class="nav-link" href="javascript:void(0)" data-bs-toggle="collapse" data-bs-target="#assetMenu">
                    <i class="fas fa-desktop"></i>
                    <span>资产管理</span>
                    <i class="fas fa-chevron-down ms-auto"></i>
                </a>
                <div class="submenu collapse" id="assetMenu">
                    <a href="{% url 'device_list' %}" class="nav-link">设备管理</a>
                    <a href="{% url 'category_list' %}" class="nav-link">分类管理</a>
                    <a href="{% url 'location_list' %}" class="nav-link">位置管理</a>
                    <a href="{% url 'device_map' %}" class="nav-link"><i class="fas fa-map-marked-alt me-1"></i>设备地图</a>
                    <a href="{% url 'field_list' %}" class="nav-link">字段设置</a>
                    <a href="{% url 'software_list' %}" class="nav-link">软件管理</a>
                    <a href="{% url 'consumable_list' %}" class="nav-link">耗材管理</a>
                    <a href="{% url 'service_list' %}" class="nav-link">服务管理</a>
                </div>
            </div>
            
            <div class="nav-item">
                <a class="nav-link" href="javascript:void(0)" data-bs-toggle="collapse" data-bs-target="#inventoryMenu">
                    <i class="fas fa-clipboard-list"></i>
                    <span>盘点管理</span>
                    <i class="fas fa-chevron-down ms-auto"></i>
                </a>
                <div class="submenu collapse" id="inventoryMenu">
                    <a href="{% url 'plan_list' %}" class="nav-link">盘点计划</a>
                    <a href="{% url 'task_list' %}" class="nav-link">盘点任务</a>
                    <a href="{% url 'inventory_report' %}" class="nav-link">盘点报表</a>
                </div>
            </div>
            
            <div class="nav-item">
                <a class="nav-link" href="javascript:void(0)" data-bs-toggle="collapse" data-bs-target="#orgMenu">
                    <i class="fas fa-sitemap"></i>
                    <span>组织管理</span>
                    <i class="fas fa-chevron-down ms-auto"></i>
                </a>
                <div class="submenu collapse" id="orgMenu">
                    <a href="{% url 'user_list' %}" class="nav-link">用户管理</a>
                    <a href="{% url 'department_list' %}" class="nav-link">部门管理</a>
                    <a href="{% url 'role_list' %}" class="nav-link">角色管理</a>
                </div>
            </div>
            
            <div class="nav-item">
                <a class="nav-link" href="javascript:void(0)" data-bs-toggle="collapse" data-bs-target="#todoMenu">
                    <i class="fas fa-tasks"></i>
                    <span>待办</span>
                    <i class="fas fa-chevron-down ms-auto"></i>
                </a>
                <div class="submenu collapse" id="todoMenu">
                    <a href="{% url 'todo_list' %}" class="nav-link">我的待办</a>
                    <a href="{% url 'notification_list' %}" class="nav-link">通知消息</a>
                </div>
            </div>
            
            <div class="nav-item">
                <a class="nav-link" href="javascript:void(0)" data-bs-toggle="collapse" data-bs-target="#logMenu">
                    <i class="fas fa-history"></i>
                    <span>日志</span>
                    <i class="fas fa-chevron-down ms-auto"></i>
                </a>
                <div class="submenu collapse" id="logMenu">
                    <a href="{% url 'login_log_list' %}" class="nav-link">登录日志</a>
                    <a href="{% url 'operation_log_list' %}" class="nav-link">操作日志</a>
                    <a href="{% url 'asset_log_list' %}" class="nav-link">资产日志</a>
                </div>
            </div>
            
            <div class="nav-item">
                <a class="nav-link" href="javascript:void(0)" data-bs-toggle="collapse" data-bs-target="#settingMenu">
                    <i class="fas fa-cog"></i>
                    <span>设置</span>
                    <i class="fas fa-chevron-down ms-auto"></i>
                </a>
                <div class="submenu collapse" id="settingMenu">
                    <a href="{% url 'config_list' %}" class="nav-link">系统配置</a>
                    <a href="{% url 'org_info' %}" class="nav-link">企业信息</a>
                    <a href="{% url 'data_management' %}" class="nav-link">数据管理</a>
                    <a href="{% url 'profile' %}" class="nav-link">个人设置</a>
                </div>
            </div>
        </nav>
    </div>
    
    <div class="main-content" id="mainContent">
        <header class="header">
            <button class="toggle-btn" onclick="toggleSidebar()">
                <i class="fas fa-bars"></i>
            </button>
            <div class="user-menu">
                <span>{{ user.realname }}</span>
                <div class="dropdown">
                    <a class="btn btn-sm btn-outline-secondary dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                        <i class="fas fa-user-circle"></i>
                    </a>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="{% url 'profile' %}">个人设置</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="{% url 'logout' %}">退出登录</a></li>
                    </ul>
                </div>
            </div>
        </header>
        
        <main class="content">
            {% if messages %}
                {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
                {% endfor %}
            {% endif %}
            
            {% block content %}{% endblock %}
        </main>
    </div>
    {% else %}
    <main class="content">
        {% block login_content %}{% endblock %}
    </main>
    {% endif %}
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.0/dist/jquery.min.js"></script>
    <script>
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('collapsed');
            document.getElementById('mainContent').classList.toggle('expanded');
        }
        
        // 折叠菜单箭头旋转
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('[data-bs-toggle="collapse"]').forEach(function(toggle) {
                toggle.addEventListener('click', function() {
                    const icon = this.querySelector('.fa-chevron-down');
                    if (icon) {
                        const targetId = this.getAttribute('data-bs-target');
                        const target = document.querySelector(targetId);
                        if (target.classList.contains('show')) {
                            icon.style.transform = 'rotate(0deg)';
                        } else {
                            icon.style.transform = 'rotate(180deg)';
                        }
                    }
                });
            });
            
            // 监听折叠完成事件
            document.querySelectorAll('.collapse').forEach(function(collapse) {
                collapse.addEventListener('shown.bs.collapse', function() {
                    const toggle = document.querySelector('[data-bs-target="#' + this.id + '"]');
                    if (toggle) {
                        const icon = toggle.querySelector('.fa-chevron-down');
                        if (icon) icon.style.transform = 'rotate(180deg)';
                    }
                });
                collapse.addEventListener('hidden.bs.collapse', function() {
                    const toggle = document.querySelector('[data-bs-target="#' + this.id + '"]');
                    if (toggle) {
                        const icon = toggle.querySelector('.fa-chevron-down');
                        if (icon) icon.style.transform = 'rotate(0deg)';
                    }
                });
            });
        });
    </script>
    {% block extra_js %}{% endblock %}
</body>
</html>
