{% extends 'base.html' %}
{% block title %}{% if location %}编辑{% else %}新增{% endif %}位置 - 驰达IT资产管理系统{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
<h4>{% if location %}编辑{% else %}新增{% endif %}位置</h4>
</div>
<div class="card"><div class="card-body">
<form method="post">{% csrf_token %}
<div class="row mb-3">
<div class="col-md-6"><label class="form-label">位置名称 <span class="text-danger">*</span></label><input type="text" name="name" class="form-control" value="{{ location.name|default:'' }}" required></div>
<div class="col-md-6"><label class="form-label">位置编码</label><input type="text" name="code" class="form-control" value="{{ location.code|default:'' }}" placeholder="自动生成" readonly><small class="text-muted">自动生成，无需填写</small></div>
</div>

<div class="row mb-3">
<div class="col-md-6"><label class="form-label">位置级别 <span class="text-danger">*</span></label><select name="level" class="form-select" id="levelSelect"><option value="">请选择级别</option><option value="1" {% if location.level == 1 or not location %}selected{% endif %}>1级 - 园区</option><option value="2" {% if location.level == 2 %}selected{% endif %}>2级 - 设施</option><option value="3" {% if location.level == 3 %}selected{% endif %}>3级 - 楼层</option><option value="4" {% if location.level == 4 %}selected{% endif %}>4级 - 房间/区域</option></select></div>
<div class="col-md-6"><label class="form-label">上级位置</label><select name="parent" class="form-select" id="parentSelect" disabled><option value="">请先选择位置级别</option></select></div>
</div>

<div id="level1Fields" style="display:none;">
<div class="row mb-3">
<div class="col-md-6"><label class="form-label">园区编码 <span class="text-danger">*</span></label><input type="text" name="park_code" id="parkCodeInput" class="form-control" value="{{ location.park_code|default:'' }}" placeholder="如:CY" maxlength="2"><small class="text-muted">2位英文字母，如CY（产业）、CG（草滩）</small></div>
</div>
</div>

<div id="level2Fields" style="display:none;">
<div class="row mb-3">
<div class="col-md-6"><label class="form-label">设施编码 <span class="text-danger">*</span></label><input type="text" name="building_code" class="form-control" value="{{ location.building_code|default:'' }}" placeholder="如:OA" maxlength="2"><small class="text-muted">设施类型+序号，如OA（办公A）、PB（生产B）</small></div>
</div>
<div class="row mb-3">
<div class="col-md-6"><label class="form-label">地下层数</label><input type="number" name="basement_count" class="form-control" value="{{ location.basement_count|default:0 }}" min="0" max="10"><small class="text-muted">如：2 表示B1、B2</small></div>
<div class="col-md-6"><label class="form-label">地上层数</label><input type="number" name="floor_count" class="form-control" value="{{ location.floor_count|default:1 }}" min="0" max="100"><small class="text-muted">如：6 表示1-6楼</small></div>
</div>
<div class="row mb-3">
<div class="col-md-6">
<div class="form-check">
<input type="checkbox" class="form-check-input" id="hasRooftopCheck" name="has_rooftop" {% if location.has_rooftop %}checked{% endif %}>
<label class="form-check-label" for="hasRooftopCheck">包含天台</label>
</div>
</div>
</div>
</div>

<div id="level3Fields" style="display:none;">
<div class="row mb-3">
<div class="col-md-6"><label class="form-label">楼层编码</label><input type="text" name="floor_code" class="form-control" value="{{ location.floor_code|default:'' }}" placeholder="如:03"><small class="text-muted">2位数字，如01、02、03</small></div>
</div>
</div>

<div id="level4Fields" style="display:none;">
<div class="row mb-3">
<div class="col-md-6"><label class="form-label">房间/区域编码</label><input type="text" name="room_code" class="form-control" value="{{ location.room_code|default:'' }}" placeholder="如:A301"><small class="text-muted">在3级平面图中用多边形工具绘制区域</small></div>
</div>
</div>
</div>

<div id="mapFields" style="display:none;">
<div class="row mb-3">
<div class="col-md-3"><label class="form-label">地图宽度</label><input type="number" name="map_width" class="form-control" value="{{ location.map_width|default:1200 }}"></div>
<div class="col-md-3"><label class="form-label">地图高度</label><input type="number" name="map_height" class="form-control" value="{{ location.map_height|default:800 }}"></div>
<div class="col-md-3"><label class="form-label">网格大小</label><input type="number" name="grid_size" class="form-control" value="{{ location.grid_size|default:50 }}"></div>
<div class="col-md-3"><label class="form-label">启用平面图</label><div class="form-check mt-2"><input type="checkbox" name="has_map" class="form-check-input" id="hasMapCheck" {% if location.has_map %}checked{% endif %}><label class="form-check-label" for="hasMapCheck">启用</label></div></div>
</div>
<div class="row mb-3">
<div class="col-md-4"><label class="form-label">默认门垛宽度</label><input type="number" name="default_doorstop_width" class="form-control" value="{{ location.default_doorstop_width|default:15 }}" step="1"></div>
<div class="col-md-4"><label class="form-label">默认吸附阈值</label><input type="number" name="default_snap_threshold" class="form-control" value="{{ location.default_snap_threshold|default:10 }}" step="1"></div>
<div class="col-md-4"><label class="form-label">默认启用吸附</label><div class="form-check mt-2"><input type="checkbox" name="default_snap_enabled" class="form-check-input" id="defaultSnapCheck" {% if location.default_snap_enabled %}checked{% else %}checked{% endif %}><label class="form-check-label" for="defaultSnapCheck">启用</label></div></div>
</div>
</div>

<div class="mb-3"><label class="form-label">描述</label><textarea name="description" class="form-control" rows="2">{{ location.description|default:'' }}</textarea></div>
<div class="mt-4">
    <button type="submit" class="btn btn-primary">保存</button>
    <a href="{% url 'location_list' %}" class="btn btn-outline-secondary">返回</a>
    {% if location %}
    {% if location.level == 3 %}
        {% if location.has_map %}
        <a href="{% url 'location_map' location.id %}" class="btn btn-success"><i class="fas fa-map"></i> 查看平面图</a>
        <a href="{% url 'location_map_edit' location.id %}" class="btn btn-primary"><i class="fas fa-edit"></i> 编辑平面图</a>
        <a href="{% url 'location_area_binding' location.id %}" class="btn btn-warning"><i class="fas fa-draw-polygon"></i> 绑定房间区域</a>
        {% endif %}
        <a href="{% url 'workstation_list' location.id %}" class="btn btn-info"><i class="fas fa-th"></i> 工位管理</a>
    {% elif location.level == 4 %}
        <a href="{% url 'location_map' location.parent.id %}" class="btn btn-success"><i class="fas fa-map"></i> 查看平面图</a>
    {% endif %}
    {% endif %}
</div>
</form>
</div></div>
{% if location %}
<div class="card mt-3">
<div class="card-header"><i class="fas fa-info-circle"></i> {% if location.level == 2 %}楼层信息{% else %}操作说明{% endif %}</div>
<div class="card-body">
{% if location.level == 2 %}
    <p><strong>已生成楼层：</strong></p>
    {% with location.children.all as floors %}
    {% if floors %}
    <table class="table table-sm">
    <thead><tr><th>楼层名称</th><th>编码</th><th>平面图</th><th>工位数</th></tr></thead>
    <tbody>
    {% for floor in floors %}
    <tr>
        <td>{{ floor.name }}</td>
        <td><code>{{ floor.code }}</code></td>
        <td>{% if floor.has_map %}<span class="badge bg-success">有</span>{% else %}<span class="badge bg-secondary">无</span>{% endif %}</td>
        <td>{{ floor.workstations.count }}</td>
    </tr>
    {% endfor %}
    </tbody>
    </table>
    {% else %}
    <p class="text-muted">尚未生成楼层</p>
    {% endif %}
    {% endwith %}
{% elif location.level == 3 %}
    <p><strong>下一步操作：</strong></p>
    <ol class="text-muted">
        {% if location.has_map %}
        <li>点击 <strong>查看平面图</strong> - 查看设备分布</li>
        <li>点击 <strong>编辑平面图</strong> - 绘制楼层平面图</li>
        <li>点击 <strong>工位管理</strong> - 创建工位</li>
        {% else %}
        <li>勾选 <strong>启用平面图</strong> 并保存</li>
        {% endif %}
    </ol>
{% elif location.level == 4 %}
    <p><strong>下一步操作：</strong></p>
    <ol class="text-muted">
        <li>点击 <strong>查看平面图</strong> - 在父楼层的平面图内查看此房间位置</li>
        <li>进入父楼层的 <strong>绑定房间区域</strong> 功能为此房间绘制区域</li>
    </ol>
{% else %}
    <p><strong>层级说明：</strong></p>
    <ul class="text-muted">
        <li>1级 - 园区（如：产业园区），填写园区编码</li>
        <li>2级 - 设施（如：办公楼A栋），填写设施编码，自动生成楼层</li>
        <li>3级 - 楼层（如：3楼），在此绘制平面图</li>
        <li>4级 - 房间/区域（如：A301室），绑定到平面图</li>
    </ul>
{% endif %}
</div>
</div>
{% endif %}
<script>
const locationOptions = [
{% for loc in locations %}{id:{{ loc.id }},name:'{{ loc.name }}',level:{{ loc.level }},code:'{{ loc.code|default:'' }}'},{% endfor %}
];
document.addEventListener('DOMContentLoaded', function() {
    function updateParentOptions(selectedLevel) {
        var parentSelect = document.getElementById('parentSelect');
        parentSelect.innerHTML = '<option value="">请选择上级位置</option>';
        
        if (!selectedLevel || selectedLevel == 1) {
            parentSelect.disabled = true;
            return;
        }
        
        var targetLevel = selectedLevel - 1;
        locationOptions.forEach(function(loc) {
            if (loc.level == targetLevel) {
                var opt = document.createElement('option');
                opt.value = loc.id;
                opt.textContent = loc.name + ' (' + loc.level + '级 - ' + (loc.code || '无编码') + ')';
                parentSelect.appendChild(opt);
            }
        });
        
        parentSelect.disabled = false;
    }
    
    function updateFields() {
        var level = parseInt(document.getElementById('levelSelect').value) || 0;
        
        document.getElementById('level1Fields').style.display = level === 1 ? 'block' : 'none';
        document.getElementById('level2Fields').style.display = level === 2 ? 'block' : 'none';
        document.getElementById('level3Fields').style.display = level === 3 ? 'block' : 'none';
        document.getElementById('level4Fields').style.display = level === 4 ? 'block' : 'none';
        document.getElementById('mapFields').style.display = level === 3 ? 'block' : 'none';
        
        updateParentOptions(level);
        
        if (level === 1) {
            var parkInput = document.getElementById('parkCodeInput');
            if (parkInput) {
                parkInput.value = '';
                parkInput.readOnly = false;
            }
        }
    }
    
    document.getElementById('levelSelect').addEventListener('change', updateFields);
    updateFields();
});
</script>
{% endblock %}
