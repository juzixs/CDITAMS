{% load asset_tags %}
{% get_location_children root as children %}
<tr class="parent-row child-of-{% if root.parent %}{{ root.parent.id }}{% else %}0{% endif %}" data-level="{{ root.level }}" data-id="{{ root.id }}">
<td>
{% if children %}
<span class="tree-toggle expanded" data-id="{{ root.id }}"><i class="fas fa-minus-square"></i></span>
{% else %}
<span style="display:inline-block;width:20px;"></span>
{% endif %}
</td>
<td style="padding-left: {% if root.level == 1 %}12{% else %}{{ root.level | add:1 }}0{% endif %}px;">
{% if root.level == 1 %}<i class="fas fa-city text-warning me-1"></i>
{% elif root.level == 2 %}<i class="fas fa-building text-primary me-1"></i>
{% elif root.level == 3 %}<i class="fas fa-layer-group text-info me-1"></i>
{% else %}<i class="fas fa-door-open text-success me-1"></i>{% endif %}
<strong>{{ root.name }}</strong>
</td>
<td><code>{{ root.code|default:'-' }}</code></td>
<td><span class="badge bg-{% if root.level == 1 %}warning text-dark{% elif root.level == 2 %}primary{% elif root.level == 3 %}info{% else %}success{% endif %} level-badge">{{ root.level }}级</span></td>
<td>{% if root.has_map %}<span class="badge bg-success"><i class="fas fa-check"></i> 有地图</span>{% else %}<span class="badge bg-secondary">无</span>{% endif %}</td>
<td>{{ root.workstations.count }}</td>
<td>{{ root.devices.count }}</td>
<td>
{% if root.level == 3 %}
    {% if root.has_map %}
    <a href="{% url 'location_map' root.id %}" class="btn btn-sm btn-outline-success btn-map" title="查看平面图"><i class="fas fa-map"></i></a>
    <a href="{% url 'location_map_edit' root.id %}" class="btn btn-sm btn-outline-primary btn-map" title="编辑平面图"><i class="fas fa-edit"></i></a>
    {% endif %}
    <a href="{% url 'workstation_list' root.id %}" class="btn btn-sm btn-outline-info btn-map" title="工位管理"><i class="fas fa-th"></i></a>
{% elif root.level == 4 %}
    <a href="{% url 'location_map' root.parent.id %}" class="btn btn-sm btn-outline-success btn-map" title="查看平面图"><i class="fas fa-map"></i></a>
{% endif %}
<a href="{% url 'location_edit' root.id %}" class="btn btn-sm btn-outline-secondary btn-map" title="编辑"><i class="fas fa-edit"></i></a>
<form method="post" action="{% url 'location_delete' root.id %}" style="display:inline;" onsubmit="return confirm('确定要删除位置「{{ root.name }}」吗？{% if root.children.exists %}该位置下有子位置，无法删除{% elif root.devices.exists %}该位置下有设备，无法删除{% endif %}');">
    {% csrf_token %}
    <button type="submit" class="btn btn-sm btn-outline-danger btn-map" title="删除" {% if root.children.exists or root.devices.exists %}disabled{% endif %}><i class="fas fa-trash"></i></button>
</form>
</td>
</tr>
{% if children %}
{% for child in children %}
{% include 'assets/location_tree_rows.html' with root=child %}
{% endfor %}
{% endif %}
