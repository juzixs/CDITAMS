{% extends "base.html" %}
{% block title %}设备位置管理{% endblock %}

{% block content %}
<div class="container-fluid" id="locationApp">
    <div class="card shadow mb-4">
        <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
            <h6 class="m-0 font-weight-bold text-primary">设备位置管理</h6>
            <div>
                <a href="/devices/settings" class="btn btn-sm btn-light">
                    <i class="fas fa-arrow-left"></i> 返回设置
                </a>
            </div>
        </div>
        <div class="card-body">
            <div class="mb-4">
                <h4>园区管理</h4>
                <div id="parkCardContainer" class="park-cards d-flex flex-row flex-wrap mb-3">
                    <!-- 使用draggable实现拖拽排序 -->
                    <div v-for="(park, index) in parks" :key="park.id" class="park-card mr-3 mb-3" :data-id="park.id" draggable="true" 
                         @dragstart="dragStart($event, index)" @dragover.prevent @dragenter.prevent 
                         @drop="onDrop($event, index)" @dragend="saveParksOrder">
                        <div class="card" style="width: 200px; cursor: move;" :class="{'border-primary': selectedPark && selectedPark.id === park.id}">
                            <div class="card-img-top bg-light d-flex align-items-center justify-content-center" style="height: 120px;" @click="selectPark(park)">
                                <i class="fas fa-map-marked-alt fa-3x text-primary" v-if="!park.map_data"></i>
                                <img v-else :src="park.map_data" style="max-width: 100%; max-height: 100%;" alt="">
                            </div>
                            <div class="card-body" @click="selectPark(park)">
                                <h5 class="card-title">[[ park.name ]]</h5>
                                <p class="card-text text-muted small">[[ park.code ]]</p>
                            </div>
                            <div class="card-footer p-2 bg-light">
                                <div class="btn-group btn-group-sm w-100">
                                    <button type="button" class="btn btn-outline-primary" @click.stop="editPark(park)">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button type="button" class="btn btn-outline-danger" @click.stop="confirmDeletePark(park)">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 添加园区卡片 -->
                    <div class="park-card mr-3 mb-3">
                        <div class="card" style="width: 200px; cursor: pointer;" @click="showAddParkModal()">
                            <div class="card-img-top bg-light d-flex align-items-center justify-content-center" style="height: 120px;">
                                <i class="fas fa-plus fa-3x text-secondary"></i>
                            </div>
                            <div class="card-body text-center">
                                <h5 class="card-title">添加园区</h5>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 园区详情视图 -->
            <div v-if="selectedPark" class="park-detail mb-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4>[[ selectedPark.name ]] 平面图</h4>
                    <div>
                        <button class="btn btn-primary mr-2" @click="editParkMap()">
                            <i class="fas fa-edit"></i> 编辑平面图
                        </button>
                        <button class="btn btn-success" @click="showAddBuildingModal()">
                            <i class="fas fa-plus"></i> 添加建筑
                        </button>
                    </div>
                </div>
                
                <!-- 园区平面图 -->
                <div class="park-map-container border p-2 mb-3" style="position: relative; min-height: 400px;">
                    <div v-if="!selectedPark.map_data" class="d-flex align-items-center justify-content-center h-100" style="min-height: 400px;">
                        <div class="text-center">
                            <i class="fas fa-draw-polygon fa-3x mb-3 text-muted"></i>
                            <p>暂无平面图，请点击"编辑平面图"进行绘制</p>
                        </div>
                    </div>
                    <div v-else id="parkMapCanvas" style="width: 100%; height: 100%; min-height: 400px;">
                        <!-- 平面图将在JS中渲染 -->
                    </div>
                </div>
            </div>
            
            <!-- 建筑详情视图 -->
            <div v-if="selectedBuilding" class="building-detail">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4>[[ selectedBuilding.name ]] 平面图</h4>
                    <div>
                        <button class="btn btn-primary mr-2" @click="editBuildingMap()">
                            <i class="fas fa-edit"></i> 编辑平面图
                        </button>
                        <button v-if="selectedBuilding.is_multi_floor" class="btn btn-info mr-2" @click="manageFloors()">
                            <i class="fas fa-layer-group"></i> 管理楼层
                        </button>
                        <button class="btn btn-success mr-2" @click="showAddSubBuildingModal()">
                            <i class="fas fa-plus"></i> 添加子建筑
                        </button>
                        <button class="btn btn-warning" @click="addLocationMarker()">
                            <i class="fas fa-map-marker-alt"></i> 添加位置
                        </button>
                    </div>
                </div>
                
                <!-- 建筑平面图 -->
                <div class="building-map-container border p-2" style="position: relative; min-height: 400px;">
                    <div v-if="!selectedBuilding.map_data" class="d-flex align-items-center justify-content-center h-100" style="min-height: 400px;">
                        <div class="text-center">
                            <i class="fas fa-draw-polygon fa-3x mb-3 text-muted"></i>
                            <p>暂无平面图，请点击"编辑平面图"进行绘制</p>
                        </div>
                    </div>
                    <div v-else id="buildingMapCanvas" style="width: 100%; height: 100%; min-height: 400px;">
                        <!-- 平面图将在JS中渲染 -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 添加园区模态框 -->
    <div class="modal fade" id="addParkModal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">添加园区</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form>
                        <div class="form-group">
                            <label>园区名称 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" v-model="parkForm.name" required>
                        </div>
                        <div class="form-group">
                            <label>园区编码 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" v-model="parkForm.code" required>
                        </div>
                        <div class="form-group">
                            <label>描述</label>
                            <textarea class="form-control" v-model="parkForm.description" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" @click="savePark()">保存</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 编辑园区模态框 -->
    <div class="modal fade" id="editParkModal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">编辑园区</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form>
                        <div class="form-group">
                            <label>园区名称 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" v-model="editParkForm.name" required>
                        </div>
                        <div class="form-group">
                            <label>园区编码 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" v-model="editParkForm.code" required>
                        </div>
                        <div class="form-group">
                            <label>描述</label>
                            <textarea class="form-control" v-model="editParkForm.description" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" @click="updatePark()">保存修改</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 删除园区确认模态框 -->
    <div class="modal fade" id="deleteParkModal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">确认删除</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p>您确定要删除园区 <strong>"[[parkToDelete.name]]"</strong> 吗？</p>
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i> 警告：此操作将删除该园区下的所有建筑和位置信息，且无法恢复！
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-danger" @click="deletePark()">确认删除</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 添加建筑模态框 -->
    <div class="modal fade" id="addBuildingModal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">添加建筑</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form>
                        <div class="form-group">
                            <label>建筑名称 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" v-model="buildingForm.name" required>
                        </div>
                        <div class="form-group">
                            <label>建筑编码 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" v-model="buildingForm.code" required>
                        </div>
                        <div class="form-group">
                            <div class="custom-control custom-checkbox">
                                <input type="checkbox" class="custom-control-input" id="isMultiFloor" v-model="buildingForm.is_multi_floor">
                                <label class="custom-control-label" for="isMultiFloor">多层建筑</label>
                            </div>
                        </div>
                        <div class="form-group" v-if="buildingForm.is_multi_floor">
                            <label>楼层数</label>
                            <input type="number" class="form-control" v-model="buildingForm.floor_count" min="1">
                        </div>
                        <div class="form-group">
                            <label>描述</label>
                            <textarea class="form-control" v-model="buildingForm.description" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" @click="saveBuilding()">保存</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 管理楼层模态框 -->
    <div class="modal fade" id="manageFloorsModal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">管理楼层</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>楼层数</label>
                        <input type="number" class="form-control" v-model="floorCount" min="1">
                    </div>
                    <div v-for="(floor, index) in floors" :key="index" class="form-group">
                        <label>楼层 #[[ index + 1 ]] 名称</label>
                        <input type="text" class="form-control" v-model="floor.name">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" @click="saveFloors()">保存</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 添加位置模态框 -->
    <div class="modal fade" id="addLocationModal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">添加位置</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form>
                        <div class="form-group">
                            <label>位置编码 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" v-model="locationForm.code" required>
                        </div>
                        <div class="form-group">
                            <label>描述</label>
                            <textarea class="form-control" v-model="locationForm.description" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" @click="saveLocation()">保存</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 绑定设备模态框 -->
    <div class="modal fade" id="bindDeviceModal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">绑定设备</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <input type="text" class="form-control" v-model="deviceSearchQuery" placeholder="输入设备资产编号或名称搜索..." @input="searchDevices">
                    </div>
                    <div class="device-list mb-3">
                        <table class="table table-bordered table-hover">
                            <thead>
                                <tr>
                                    <th>资产编号</th>
                                    <th>名称</th>
                                    <th>型号</th>
                                    <th>当前位置</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="device in filteredDevices" :key="device.id">
                                    <td>[[ device.asset_number ]]</td>
                                    <td>[[ device.name ]]</td>
                                    <td>[[ device.model ]]</td>
                                    <td>[[ device.location ? device.location.name : '未设置' ]]</td>
                                    <td>
                                        <button class="btn btn-sm btn-primary" @click="bindDevice(device)">选择</button>
                                    </td>
                                </tr>
                                <tr v-if="filteredDevices.length === 0">
                                    <td colspan="5" class="text-center">无匹配设备</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- 引入绘图相关的库 -->
<script src="https://cdn.jsdelivr.net/npm/konva@8.4.2/konva.min.js"></script>
<script>
    new Vue({
        el: '#locationApp',
        delimiters: ['[[', ']]'],
        data: {
            parks: [], // 园区列表
            selectedPark: null, // 当前选中的园区
            selectedBuilding: null, // 当前选中的建筑
            selectedFloor: null, // 当前选中的楼层
            selectedLocation: null, // 当前选中的位置
            
            // 表单数据
            parkForm: {
                name: '',
                code: '',
                description: ''
            },
            editParkForm: {
                id: null,
                name: '',
                code: '',
                description: ''
            },
            parkToDelete: {},
            draggedParkIndex: null,
            buildingForm: {
                name: '',
                code: '',
                description: '',
                is_multi_floor: false,
                floor_count: 1
            },
            locationForm: {
                code: '',
                description: ''
            },
            
            // 楼层管理
            floorCount: 1,
            floors: [{name: 'F1'}],
            
            // 设备绑定
            deviceSearchQuery: '',
            devices: [],
            filteredDevices: []
        },
        methods: {
            // 加载园区列表
            loadParks() {
                // 这里应该调用API获取园区列表
                // 暂时使用模拟数据
                this.parks = [
                    {
                        id: 1,
                        name: '总部园区',
                        code: 'HQ-PARK',
                        description: '公司总部园区',
                        map_data: null,
                        sort_order: 1
                    },
                    {
                        id: 2,
                        name: '生产园区',
                        code: 'PROD-PARK',
                        description: '公司生产园区',
                        map_data: null,
                        sort_order: 2
                    }
                ];
            },
            
            // 选择园区
            selectPark(park) {
                this.selectedPark = park;
                this.selectedBuilding = null;
                this.selectedFloor = null;
                this.selectedLocation = null;
                this.loadParkMap();
            },
            
            // 加载园区平面图
            loadParkMap() {
                // 这里应该渲染园区平面图
                if (this.selectedPark && this.selectedPark.map_data) {
                    // TODO: 使用Konva渲染平面图
                }
            },
            
            // 拖拽相关方法 - 开始拖拽
            dragStart(event, index) {
                this.draggedParkIndex = index;
                event.dataTransfer.effectAllowed = 'move';
                // 开始拖拽时设置一个半透明的效果
                event.target.style.opacity = '0.6';
            },
            
            // 在另一个项上放下
            onDrop(event, index) {
                event.preventDefault();
                // 确保不是拖到同一个位置
                if (this.draggedParkIndex !== index) {
                    // 得到要移动的项
                    const itemToMove = this.parks.splice(this.draggedParkIndex, 1)[0];
                    // 将其插入到新位置
                    this.parks.splice(index, 0, itemToMove);
                    // 更新每个园区的排序订单
                    this.parks.forEach((park, idx) => {
                        park.sort_order = idx + 1;
                    });
                }
                // 重置透明度
                event.target.closest('.park-card').style.opacity = '1';
            },
            
            // 保存园区排序
            saveParksOrder() {
                // 这里调用API保存排序结果
                console.log('保存园区排序：', this.parks.map(p => ({ id: p.id, sort_order: p.sort_order })));
                // TODO: 实现API调用保存排序
            },
            
            // 显示添加园区模态框
            showAddParkModal() {
                this.parkForm = {
                    name: '',
                    code: '',
                    description: ''
                };
                $('#addParkModal').modal('show');
            },
            
            // 保存园区
            savePark() {
                // 表单验证
                if (!this.parkForm.name || !this.parkForm.code) {
                    alert('请填写园区名称和编码');
                    return;
                }
                
                // TODO: 调用API保存园区
                
                // 暂时使用模拟数据
                const newPark = {
                    id: Date.now(),
                    name: this.parkForm.name,
                    code: this.parkForm.code,
                    description: this.parkForm.description,
                    map_data: null,
                    sort_order: this.parks.length + 1
                };
                
                this.parks.push(newPark);
                this.selectedPark = newPark;
                $('#addParkModal').modal('hide');
            },
            
            // 编辑园区
            editPark(park) {
                this.editParkForm = {
                    id: park.id,
                    name: park.name,
                    code: park.code,
                    description: park.description || ''
                };
                $('#editParkModal').modal('show');
            },
            
            // 更新园区
            updatePark() {
                // 表单验证
                if (!this.editParkForm.name || !this.editParkForm.code) {
                    alert('请填写园区名称和编码');
                    return;
                }
                
                // TODO: 调用API更新园区
                
                // 在前端更新园区数据
                const parkIndex = this.parks.findIndex(p => p.id === this.editParkForm.id);
                if (parkIndex !== -1) {
                    // 保持原有属性不变
                    const updatedPark = {
                        ...this.parks[parkIndex],
                        name: this.editParkForm.name,
                        code: this.editParkForm.code,
                        description: this.editParkForm.description
                    };
                    
                    this.$set(this.parks, parkIndex, updatedPark);
                    
                    // 如果当前选中的园区就是被编辑的园区，也需要更新 selectedPark
                    if (this.selectedPark && this.selectedPark.id === updatedPark.id) {
                        this.selectedPark = updatedPark;
                    }
                }
                
                $('#editParkModal').modal('hide');
            },
            
            // 确认删除园区
            confirmDeletePark(park) {
                this.parkToDelete = park;
                $('#deleteParkModal').modal('show');
            },
            
            // 删除园区
            deletePark() {
                if (!this.parkToDelete || !this.parkToDelete.id) {
                    return;
                }
                
                // TODO: 调用API删除园区
                
                // 前端删除园区
                const parkIndex = this.parks.findIndex(p => p.id === this.parkToDelete.id);
                if (parkIndex !== -1) {
                    this.parks.splice(parkIndex, 1);
                    
                    // 重新排序
                    this.parks.forEach((park, idx) => {
                        park.sort_order = idx + 1;
                    });
                    
                    // 如果当前选中的园区是被删除的园区，清除选中状态
                    if (this.selectedPark && this.selectedPark.id === this.parkToDelete.id) {
                        this.selectedPark = null;
                    }
                }
                
                $('#deleteParkModal').modal('hide');
            },
            
            // 编辑园区平面图
            editParkMap() {
                // TODO: 实现平面图编辑器
                alert('平面图编辑功能即将开发');
            },
            
            // 显示添加建筑模态框
            showAddBuildingModal() {
                this.buildingForm = {
                    name: '',
                    code: '',
                    description: '',
                    is_multi_floor: false,
                    floor_count: 1
                };
                $('#addBuildingModal').modal('show');
            },
            
            // 保存建筑
            saveBuilding() {
                // TODO: 验证表单
                // TODO: 调用API保存建筑
                
                // 暂时使用模拟数据
                const newBuilding = {
                    id: Date.now(),
                    name: this.buildingForm.name,
                    code: this.buildingForm.code,
                    description: this.buildingForm.description,
                    is_multi_floor: this.buildingForm.is_multi_floor,
                    floor_count: this.buildingForm.floor_count,
                    map_data: null,
                    floors: []
                };
                
                // 如果是多层建筑，初始化楼层
                if (newBuilding.is_multi_floor) {
                    for (let i = 0; i < newBuilding.floor_count; i++) {
                        newBuilding.floors.push({
                            id: Date.now() + i,
                            name: `F${i+1}`,
                            map_data: null
                        });
                    }
                }
                
                // 添加到园区的建筑列表
                if (!this.selectedPark.buildings) {
                    this.selectedPark.buildings = [];
                }
                this.selectedPark.buildings.push(newBuilding);
                
                // 选中新建筑
                this.selectedBuilding = newBuilding;
                $('#addBuildingModal').modal('hide');
            },
            
            // 编辑建筑平面图
            editBuildingMap() {
                // TODO: 实现平面图编辑器
                alert('建筑平面图编辑功能即将开发');
            },
            
            // 管理楼层
            manageFloors() {
                if (this.selectedBuilding && this.selectedBuilding.is_multi_floor) {
                    this.floorCount = this.selectedBuilding.floor_count || 1;
                    this.floors = [];
                    
                    // 如果已有楼层数据，则加载
                    if (this.selectedBuilding.floors && this.selectedBuilding.floors.length > 0) {
                        this.floors = [...this.selectedBuilding.floors];
                    } else {
                        // 否则创建默认楼层
                        for (let i = 0; i < this.floorCount; i++) {
                            this.floors.push({
                                name: `F${i+1}`
                            });
                        }
                    }
                    
                    $('#manageFloorsModal').modal('show');
                }
            },
            
            // 监听楼层数量变化
            watchFloorCount() {
                // 当楼层数量变化时，动态调整楼层列表
                const newCount = parseInt(this.floorCount) || 1;
                const currentCount = this.floors.length;
                
                if (newCount > currentCount) {
                    // 增加楼层
                    for (let i = currentCount; i < newCount; i++) {
                        this.floors.push({
                            name: `F${i+1}`
                        });
                    }
                } else if (newCount < currentCount) {
                    // 减少楼层
                    this.floors = this.floors.slice(0, newCount);
                }
            },
            
            // 保存楼层设置
            saveFloors() {
                if (this.selectedBuilding) {
                    this.selectedBuilding.floor_count = this.floorCount;
                    this.selectedBuilding.floors = [...this.floors];
                    $('#manageFloorsModal').modal('hide');
                }
            },
            
            // 显示添加子建筑模态框
            showAddSubBuildingModal() {
                // 与添加建筑类似，但父级为当前选中的建筑
                this.buildingForm = {
                    name: '',
                    code: '',
                    description: '',
                    is_multi_floor: false,
                    floor_count: 1
                };
                $('#addBuildingModal').modal('show');
            },
            
            // 添加位置标记
            addLocationMarker() {
                this.locationForm = {
                    code: '',
                    description: ''
                };
                $('#addLocationModal').modal('show');
            },
            
            // 保存位置
            saveLocation() {
                // TODO: 验证表单
                // TODO: 调用API保存位置
                
                // 暂时使用模拟数据
                const newLocation = {
                    id: Date.now(),
                    code: this.locationForm.code,
                    description: this.locationForm.description,
                    x: 100, // 默认位置
                    y: 100,
                    width: 50,
                    height: 50
                };
                
                // 添加到当前容器的位置列表
                let container = this.selectedFloor || this.selectedBuilding;
                if (!container.locations) {
                    container.locations = [];
                }
                container.locations.push(newLocation);
                
                $('#addLocationModal').modal('hide');
                
                // TODO: 在平面图上添加位置方块
            },
            
            // 搜索设备
            searchDevices() {
                // 筛选设备列表
                if (this.deviceSearchQuery) {
                    const query = this.deviceSearchQuery.toLowerCase();
                    this.filteredDevices = this.devices.filter(device => {
                        return device.asset_number.toLowerCase().includes(query) || 
                               (device.name && device.name.toLowerCase().includes(query));
                    });
                } else {
                    this.filteredDevices = [...this.devices];
                }
            },
            
            // 绑定设备
            bindDevice(device) {
                // TODO: 调用API绑定设备到位置
                
                // 暂时模拟绑定逻辑
                if (this.selectedLocation) {
                    this.selectedLocation.device_id = device.id;
                    this.selectedLocation.device = {
                        asset_number: device.asset_number,
                        name: device.name
                    };
                }
                
                $('#bindDeviceModal').modal('hide');
            }
        },
        watch: {
            floorCount: function() {
                this.watchFloorCount();
            }
        },
        mounted() {
            // 加载园区列表
            this.loadParks();
            
            // 加载设备列表（用于绑定设备）
            // TODO: 调用API加载设备列表
        }
    });
</script>
{% endblock %}
