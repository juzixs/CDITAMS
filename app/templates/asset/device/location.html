{% extends "base.html" %}
{% block title %}设备位置管理{% endblock %}

{% block content %}
<div class="container-fluid" id="locationApp">
    <div class="card shadow mb-4">
        <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
            <h6 class="m-0 font-weight-bold text-primary">设备位置管理</h6>
            <div>
                <a href="/devices/settings" class="btn btn-sm btn-light">
                    <i class="fas fa-arrow-left"></i> 返回设置
                </a>
            </div>
        </div>
        <div class="card-body">
            <div class="mb-4">
                <h4>园区管理</h4>
                <div id="parkCardContainer" class="park-cards d-flex flex-row flex-wrap mb-3">
                    <!-- 使用draggable实现拖拽排序 -->
                    <div v-for="(park, index) in parks" :key="park.id" class="park-card mr-3 mb-3" :data-id="park.id" draggable="true" 
                         @dragstart="dragStart($event, index)" @dragover.prevent @dragenter.prevent 
                         @drop="onDrop($event, index)" @dragend="saveParksOrder">
                        <div class="card" style="width: 200px; cursor: move;" :class="{'border-primary': selectedPark && selectedPark.id === park.id}">
                            <div class="card-img-top bg-light d-flex align-items-center justify-content-center" style="height: 120px;" @click="selectPark(park)">
                                <i class="fas fa-map-marked-alt fa-3x text-primary" v-if="!park.map_data || (park.map_data && !park.map_data.startsWith('data:image'))"></i>
                                <img v-else-if="park.map_data && park.map_data.startsWith('data:image')" :src="park.map_data" style="max-width: 100%; max-height: 100%;" alt="">
                            </div>
                            <div class="card-body" @click="selectPark(park)">
                                <h5 class="card-title">[[ park.name ]]</h5>
                                <p class="card-text text-muted small">[[ park.code ]]</p>
                            </div>
                            <div class="card-footer p-2 bg-light">
                                <div class="btn-group btn-group-sm w-100">
                                    <button type="button" class="btn btn-outline-primary" @click.stop="editPark(park)">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button type="button" class="btn btn-outline-danger" @click.stop="confirmDeletePark(park)">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 添加园区卡片 -->
                    <div class="park-card mr-3 mb-3">
                        <div class="card" style="width: 200px; cursor: pointer;" @click="showAddParkModal()">
                            <div class="card-img-top bg-light d-flex align-items-center justify-content-center" style="height: 120px;">
                                <i class="fas fa-plus fa-3x text-secondary"></i>
                            </div>
                            <div class="card-body text-center">
                                <h5 class="card-title">添加园区</h5>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 园区详情视图 -->
            <div v-if="selectedPark" class="park-detail mb-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4>[[ selectedPark.name ]] 平面图</h4>
                    <div>
                        <button class="btn btn-primary mr-2" @click="editParkMap()">
                            <i class="fas fa-edit"></i> 编辑平面图
                        </button>
                        <button class="btn btn-success" @click="showAddBuildingModal()">
                            <i class="fas fa-plus"></i> 添加建筑
                        </button>
                    </div>
                </div>
                
                <!-- 园区平面图 -->
                <div class="park-map-container border p-2 mb-3" style="position: relative; min-height: 400px;">
                    <div v-if="!selectedPark.map_data && !selectedPark.mapJson" class="d-flex align-items-center justify-content-center h-100" style="min-height: 400px;">
                        <div class="text-center">
                            <i class="fas fa-draw-polygon fa-3x mb-3 text-muted"></i>
                            <p>暂无平面图，请点击"编辑平面图"进行绘制</p>
                        </div>
                    </div>
                    <canvas v-else id="parkMapCanvas" style="width: 100%; height: 100%; min-height: 400px;">
                        <!-- 平面图将在JS中渲染 -->
                    </canvas>
                </div>
            </div>
            
            <!-- 建筑详情视图 -->
            <div v-if="selectedBuilding" class="building-detail">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4>[[ selectedBuilding.name ]] 平面图</h4>
                    <div>
                        <button class="btn btn-primary mr-2" @click="editBuildingMap()">
                            <i class="fas fa-edit"></i> 编辑平面图
                        </button>
                        <button v-if="selectedBuilding.is_multi_floor" class="btn btn-info mr-2" @click="manageFloors()">
                            <i class="fas fa-layer-group"></i> 管理楼层
                        </button>
                        <button class="btn btn-success mr-2" @click="showAddSubBuildingModal()">
                            <i class="fas fa-plus"></i> 添加子建筑
                        </button>
                        <button class="btn btn-warning" @click="addLocationMarker()">
                            <i class="fas fa-map-marker-alt"></i> 添加位置
                        </button>
                    </div>
                </div>
                
                <!-- 建筑平面图 -->
                <div class="building-map-container border p-2" style="position: relative; min-height: 400px;">
                    <div v-if="!selectedBuilding.map_data" class="d-flex align-items-center justify-content-center h-100" style="min-height: 400px;">
                        <div class="text-center">
                            <i class="fas fa-draw-polygon fa-3x mb-3 text-muted"></i>
                            <p>暂无平面图，请点击"编辑平面图"进行绘制</p>
                        </div>
                    </div>
                    <div v-else id="buildingMapCanvas" style="width: 100%; height: 100%; min-height: 400px;">
                        <!-- 平面图将在JS中渲染 -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 添加园区模态框 -->
    <div class="modal fade" id="addParkModal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">添加园区</h5>
                    <button type="button" class="close" @click="closeAddParkModal()" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form>
                        <div class="form-group">
                            <label>园区名称 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" v-model="parkForm.name" required>
                        </div>
                        <div class="form-group">
                            <label>园区编码 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" v-model="parkForm.code" required>
                        </div>
                        <div class="form-group">
                            <label>描述</label>
                            <textarea class="form-control" v-model="parkForm.description" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @click="closeAddParkModal()">取消</button>
                    <button type="button" class="btn btn-primary" @click="savePark()">保存</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 编辑园区模态框 -->
    <div class="modal fade" id="editParkModal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-xl" role="document" style="max-width: 95%; max-height: 95vh; margin: 10px auto;">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">编辑园区</h5>
                    <button type="button" class="close" @click="closeEditParkModal()">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" style="height: 90vh; max-height: 1000px; overflow-y: auto; padding: 10px;">
                    <div class="row">
                        <div class="col-md-3">
                            <form>
                                <div class="form-group">
                                    <label>园区名称 <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" v-model="editParkForm.name" required>
                                </div>
                                <div class="form-group">
                                    <label>园区编码 <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" v-model="editParkForm.code" required>
                                </div>
                                <div class="form-group">
                                    <label>描述</label>
                                    <textarea class="form-control" v-model="editParkForm.description" rows="3"></textarea>
                                </div>
                            </form>
                        </div>
                        <div class="col-md-9">
                            <h6 class="mb-3">园区平面图</h6>
                            <div class="map-editor-container border p-2 mb-3 resizable" style="position: relative; width: 100%; height: 60vh; min-height: 400px; max-height: 1200px; background-color: #f8f9fa;">
                                <div class="resize-handle-vertical" style="position: absolute; bottom: 0; left: 0; right: 0; height: 10px; background-color: #aaa; cursor: ns-resize; border-top: 1px solid #999; z-index: 1000; opacity: 0.8;" @mousedown="onResizeMouseDown($event, 'vertical')">
                                    <div style="width: 40px; height: 4px; background-color: #333; margin: 3px auto; border-radius: 2px;"></div>
                                </div>
                                <div class="resize-handle-horizontal" style="position: absolute; top: 0; bottom: 0; right: 0; width: 10px; background-color: #aaa; cursor: ew-resize; border-left: 1px solid #999; z-index: 1000; opacity: 0.8;" @mousedown="onResizeMouseDown($event, 'horizontal')">
                                    <div style="width: 4px; height: 40px; background-color: #333; margin: auto; position: relative; top: 50%; transform: translateY(-50%); border-radius: 2px;"></div>
                                </div>
                                <canvas id="editParkMapEditor" style="width: 100%; height: calc(100% - 10px);">
                                    <!-- 平面图编辑器将在JS中初始化 -->
                                </canvas>
                                <div class="map-tools position-absolute" style="top: 10px; right: 10px; z-index: 100;">
                                    <div class="btn-group-vertical">
                                        <button type="button" class="btn btn-sm btn-light" title="移动工具" @click="activateMoveTool()">
                                            <i class="fas fa-arrows-alt"></i>
                                        </button>
                                        <button type="button" class="btn btn-sm btn-light" title="删除选中对象" @click="deleteSelectedObjects()">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                        <button type="button" class="btn btn-sm btn-light" title="线段工具" @click="activateLineTool()">
                                            <i class="fas fa-slash"></i>
                                        </button>
                                        <button type="button" class="btn btn-sm btn-light" title="矩形工具" @click="activateRectangleTool()">
                                            <i class="fas fa-square"></i>
                                        </button>
                                        <button type="button" class="btn btn-sm btn-light" title="多边形工具" @click="activatePolygonTool()">
                                            <i class="fas fa-draw-polygon"></i>
                                        </button>
                                        <button type="button" class="btn btn-sm btn-light" title="缩放工具" @click="activateZoomTool()">
                                            <i class="fas fa-search-plus"></i>
                                        </button>
                                        <button type="button" class="btn btn-sm btn-light" title="清除画布" @click="clearCanvas()">
                                            <i class="fas fa-trash-alt"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="style-tools position-absolute" style="top: 10px; left: 10px; z-index: 100; background-color: rgba(255,255,255,0.8); padding: 10px; border-radius: 5px; border: 1px solid #ddd;">
                                    <div class="mb-2">
                                        <label class="d-block mb-1 small">填充:</label>
                                        <div class="custom-control custom-switch">
                                            <input type="checkbox" class="custom-control-input" id="fillEnabledSwitch" v-model="fillEnabled" @change="updateSelectedObjectStyles">
                                            <label class="custom-control-label small" for="fillEnabledSwitch">[[fillEnabled ? '开启' : '关闭']]</label>
                                        </div>
                                    </div>
                                    <div class="mb-2" v-if="fillEnabled">
                                        <label class="d-block mb-1 small">填充颜色:</label>
                                        <input type="color" class="form-control form-control-sm" v-model="fillColor" @input="updateSelectedObjectStyles" style="width: 40px; height: 25px;">
                                    </div>
                                    <div class="mb-2">
                                        <label class="d-block mb-1 small">线条颜色:</label>
                                        <input type="color" class="form-control form-control-sm" v-model="strokeColor" @input="updateSelectedObjectStyles" style="width: 40px; height: 25px;">
                                    </div>
                                    <div>
                                        <label class="d-block mb-1 small">线条宽度:</label>
                                        <select class="form-control form-control-sm" v-model="strokeWidth" @change="updateSelectedObjectStyles" style="width: 60px;">
                                            <option value="1">1px</option>
                                            <option value="2">2px</option>
                                            <option value="3">3px</option>
                                            <option value="4">4px</option>
                                            <option value="5">5px</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="editParkCancel" @click="closeEditParkModal()">取消</button>
                    <button type="button" class="btn btn-primary" @click="updatePark()">保存</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 删除园区确认模态框 -->
    <div class="modal fade" id="deleteParkModal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">确认删除</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p v-if="parkToDelete">您确定要删除园区 "[[ parkToDelete.name ]]" 吗？</p>
                    <p v-else>您确定要删除所选园区吗？</p>
                    <p class="text-danger">此操作不可逆，请谨慎操作。</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-danger" @click="deletePark()">确认删除</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 添加建筑模态框 -->
    <div class="modal fade" id="addBuildingModal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">添加建筑</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form>
                        <div class="form-group">
                            <label>建筑名称 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" v-model="buildingForm.name" required>
                        </div>
                        <div class="form-group">
                            <label>建筑编码 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" v-model="buildingForm.code" required>
                        </div>
                        <div class="form-group">
                            <div class="custom-control custom-checkbox">
                                <input type="checkbox" class="custom-control-input" id="isMultiFloor" v-model="buildingForm.is_multi_floor">
                                <label class="custom-control-label" for="isMultiFloor">多层建筑</label>
                            </div>
                        </div>
                        <div class="form-group" v-if="buildingForm.is_multi_floor">
                            <label>楼层数</label>
                            <input type="number" class="form-control" v-model="buildingForm.floor_count" min="1">
                        </div>
                        <div class="form-group">
                            <label>描述</label>
                            <textarea class="form-control" v-model="buildingForm.description" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" @click="saveBuilding()">保存</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 管理楼层模态框 -->
    <div class="modal fade" id="manageFloorsModal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">管理楼层</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>楼层数</label>
                        <input type="number" class="form-control" v-model="floorCount" min="1">
                    </div>
                    <div v-for="(floor, index) in floors" :key="index" class="form-group">
                        <label>楼层 #[[ index + 1 ]] 名称</label>
                        <input type="text" class="form-control" v-model="floor.name">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" @click="saveFloors()">保存</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 添加位置模态框 -->
    <div class="modal fade" id="addLocationModal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">添加位置</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form>
                        <div class="form-group">
                            <label>位置编码 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" v-model="locationForm.code" required>
                        </div>
                        <div class="form-group">
                            <label>描述</label>
                            <textarea class="form-control" v-model="locationForm.description" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" @click="saveLocation()">保存</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 绑定设备模态框 -->
    <div class="modal fade" id="bindDeviceModal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">绑定设备</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <input type="text" class="form-control" v-model="deviceSearchQuery" placeholder="输入设备资产编号或名称搜索..." @input="searchDevices">
                    </div>
                    <div class="device-list mb-3">
                        <table class="table table-bordered table-hover">
                            <thead>
                                <tr>
                                    <th>资产编号</th>
                                    <th>名称</th>
                                    <th>型号</th>
                                    <th>当前位置</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="device in filteredDevices" :key="device.id">
                                    <td>[[ device.asset_number ]]</td>
                                    <td>[[ device.name ]]</td>
                                    <td>[[ device.model ]]</td>
                                    <td>[[ device.location ? device.location.name : '未设置' ]]</td>
                                    <td>
                                        <button class="btn btn-sm btn-primary" @click="bindDevice(device)">选择</button>
                                    </td>
                                </tr>
                                <tr v-if="filteredDevices.length === 0">
                                    <td colspan="5" class="text-center">无匹配设备</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- 引入绘图相关的库 -->
<script src="https://cdn.jsdelivr.net/npm/fabric@5.3.0/dist/fabric.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/konva@9.3.0/konva.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/interactjs@1.10.19/dist/interact.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.14.0/Sortable.min.js"></script>

<script>
    const locationApp = new Vue({
        el: '#locationApp',
        delimiters: ['[[', ']]'],
        data: {
            parks: [], // 园区列表
            selectedPark: null, // 当前选中的园区
            selectedBuilding: null, // 当前选中的建筑
            selectedFloor: null, // 当前选中的楼层
            selectedLocation: null, // 当前选中的位置
            selectedObjects: [], // 当前选中的对象
            
            // 园区画布
            parkCanvas: null,
            
            // 绘图相关
            canvas: null, // fabric.js 画布对象
            currentTool: 'move', // 当前选中的工具: move, rectangle, polygon, line, zoom
            isDrawing: false, // 是否正在绘制
            startPosition: null, // 绘制开始位置
            drawingShape: null, // 当前绘制的形状
            drawingPoints: [], // 当前绘制多边形的点
            shapes: [], // 已绘制的形状列表
            
            // 样式设置
            fillEnabled: true, // 是否启用填充
            fillColor: '#aed7ff', // 填充颜色
            strokeColor: '#007bff', // 线条颜色
            strokeWidth: 2, // 线条宽度
            
            // 拖动相关
            isPanning: false, // 是否正在拖动平移
            lastX: 0, // 上次鼠标X位置
            lastY: 0, // 上次鼠标Y位置
            currentZoom: 1, // 当前缩放比例
            
            // 编辑器尺寸调整
            resizing: null,
            boundResizeMouseMove: null,
            boundResizeMouseUp: null,
            
            // 表单数据
            parkForm: {
                name: '',
                code: '',
                description: '',
                type: 'park',
                level: 1,
                parent_id: null,
                map_data: null
            },
            editParkForm: {
                id: null,
                name: '',
                code: '',
                description: '',
                map_data: null
            },
            parkToDelete: null,
            
            buildingForm: {
                name: '',
                code: '',
                description: '',
                is_multi_floor: false,
                floor_count: 1
            },
            floorCount: 1,
            floors: [],
            
            locationForm: {
                code: '',
                description: ''
            },
            
            // 设备相关
            devices: [],
            filteredDevices: [],
            deviceSearchQuery: ''
        },
        methods: {            
            // 初始化拖拽功能
            initDraggable() {
                this.$nextTick(() => {
                    const parkCardContainer = document.getElementById('parkCardContainer');
                    if (parkCardContainer) {
                        new Sortable(parkCardContainer, {
                            animation: 150,
                            draggable: ".park-card",
                            handle: ".card",
                            ghostClass: "sortable-ghost",
                            chosenClass: "sortable-chosen",
                            dragClass: "sortable-drag",
                            onEnd: (evt) => {
                                // 拖拽结束后更新顺序
                                this.saveParksOrder();
                            }
                        });
                    }
                });
            },
            
            // 初始化地图编辑器
            initMapEditor() {
                try {
                    console.log('开始初始化地图编辑器');
                    const container = document.getElementById('editParkMapEditor');
                    if (!container) {
                        console.error('找不到编辑器容器元素');
                        return;
                    }
                    
                    // 计算容器尺寸
                    const containerWidth = container.parentElement.clientWidth;
                    // 直接获取容器高度，而不是父元素高度
                    const containerHeight = container.parentElement.offsetHeight - 10; // 减去拖动手柄的高度

                    // 设置canvas元素的宽高
                    container.width = containerWidth;
                    container.height = containerHeight;
                    
                    console.log('Canvas元素尺寸设置为:', containerWidth, 'x', containerHeight);
                    
                    // 如果已存在画布，先清理
                    if (this.canvas) {
                        console.log('清理现有画布');
                        this.canvas.dispose();
                    }
                    
                    // 初始化或重置shapes数组
                    this.shapes = [];
                    this.isDrawing = false;
                    this.drawingShape = null;
                    this.drawingPoints = [];
                    
                    // 创建画布对象
                    this.canvas = new fabric.Canvas('editParkMapEditor', {
                        width: containerWidth,
                        height: containerHeight,
                        selection: true,
                        backgroundColor: '#f5f5f5'
                    });
                    
                    // 设置画布事件
                    this.setupCanvasEvents();
                    
                    console.log('Canvas初始化成功');
                    
                    // 绘制网格
                    this.drawGrid();
                    
                    // 重置默认工具
                    this.currentTool = 'move';
                    this.canvas.defaultCursor = 'grab';
                    this.canvas.renderAll();
                } catch (error) {
                    console.error('初始化地图编辑器失败:', error);
                    alert('初始化编辑器失败: ' + error.message);
                }
            },
            
            // 绘制网格
            drawGrid(canvasToUse, gridSize = 20, gridColor = '#e0e0e0') {
                try {
                    console.log('开始绘制网格');
                    // 使用提供的画布或默认使用this.canvas
                    const canvas = canvasToUse || this.canvas;
                    if (!canvas) {
                        console.error('无法绘制网格，画布对象不存在');
                        return;
                    }
                    
                    // 清除现有的网格线
                    const existingGridLines = canvas.getObjects().filter(obj => obj.isGridLine);
                    existingGridLines.forEach(line => {
                        canvas.remove(line);
                    });
                    
                    const width = canvas.width;
                    const height = canvas.height;
                    console.log('绘制网格，画布尺寸:', width, 'x', height);
                    
                    // 创建水平线
                    for (let i = 0; i <= height; i += gridSize) {
                        const line = new fabric.Line([0, i, width, i], {
                            stroke: gridColor,
                            selectable: false,
                            evented: false,
                            isGridLine: true,
                            excludeFromExport: true
                        });
                        canvas.add(line);
                    }
                    
                    // 创建垂直线
                    for (let i = 0; i <= width; i += gridSize) {
                        const line = new fabric.Line([i, 0, i, height], {
                            stroke: gridColor,
                            selectable: false,
                            evented: false,
                            isGridLine: true,
                            excludeFromExport: true
                        });
                        canvas.add(line);
                    }
                    
                    // 将网格线移动到底层
                    canvas.getObjects().filter(obj => obj.isGridLine).forEach(line => {
                        canvas.sendToBack(line);
                    });
                    
                    canvas.renderAll();
                    console.log('网格绘制完成，共绘制', 
                        Math.ceil(width/gridSize) + Math.ceil(height/gridSize), '条网格线');
                    
                } catch (error) {
                    console.error('绘制网格失败:', error);
                }
            },
            
            // 设置画布事件
            setupCanvasEvents() {
                // 如果canvas未初始化，直接返回
                if (!this.canvas) {
                    console.error('无法设置画布事件：canvas未初始化');
                    return;
                }
                
                // 移除可能存在的事件监听器，避免重复绑定
                this.canvas.off('mouse:wheel');
                this.canvas.off('mouse:down');
                this.canvas.off('mouse:move');
                this.canvas.off('mouse:up');
                this.canvas.off('mouse:dblclick');
                this.canvas.off('selection:created');
                this.canvas.off('selection:updated');
                this.canvas.off('selection:cleared');
                
                console.log('设置画布事件监听器');
                
                // 鼠标滚轮事件 - 缩放
                this.canvas.on('mouse:wheel', (opt) => {
                    if (this.currentTool === 'zoom') {
                        const delta = opt.e.deltaY;
                        let zoom = this.canvas.getZoom();
                        
                        // 向下滚动缩小，向上滚动放大
                        if (delta > 0) {
                            zoom = zoom * 0.9; // 缩小10%
                        } else {
                            zoom = zoom * 1.1; // 放大10%
                        }
                        
                        // 限制缩放范围
                        if (zoom > 20) zoom = 20;
                        if (zoom < 0.1) zoom = 0.1;
                        
                        // 缩放到鼠标位置
                        const point = {
                            x: opt.e.offsetX,
                            y: opt.e.offsetY,
                        };
                        
                        this.canvas.zoomToPoint(point, zoom);
                        this.currentZoom = zoom;
                        
                        // 阻止浏览器默认滚动行为
                        opt.e.preventDefault();
                        opt.e.stopPropagation();
                        
                        console.log('缩放级别:', zoom.toFixed(2));
                    }
                });
                
                // 选择事件 - 当对象被选中时
                this.canvas.on('selection:created', (opt) => {
                    console.log('对象被选中', opt.selected);
                    this.selectedObjects = opt.selected;
                });
                
                this.canvas.on('selection:updated', (opt) => {
                    console.log('选择更新', opt.selected);
                    this.selectedObjects = opt.selected;
                });
                
                this.canvas.on('selection:cleared', () => {
                    console.log('选择清除');
                    this.selectedObjects = [];
                });
                
                // 键盘事件 - 删除选中的对象
                document.addEventListener('keydown', (e) => {
                    if ((e.key === 'Delete' || e.key === 'Backspace') && this.canvas) {
                        const activeObject = this.canvas.getActiveObject();
                        if (activeObject) {
                            if (activeObject.type === 'activeSelection') {
                                // 删除多个选中的对象
                                activeObject.forEachObject((obj) => {
                                    this.canvas.remove(obj);
                                    // 从shapes数组中移除
                                    const index = this.shapes.indexOf(obj);
                                    if (index !== -1) {
                                        this.shapes.splice(index, 1);
                                    }
                                });
                                this.canvas.discardActiveObject();
                            } else {
                                // 删除单个选中对象
                                this.canvas.remove(activeObject);
                                // 从shapes数组中移除
                                const index = this.shapes.indexOf(activeObject);
                                if (index !== -1) {
                                    this.shapes.splice(index, 1);
                                }
                            }
                            this.canvas.renderAll();
                            console.log('删除选中对象');
                        }
                    }
                });
                
                // 鼠标按下事件
                this.canvas.on('mouse:down', (opt) => {
                    const pointer = this.canvas.getPointer(opt.e);
                    
                    if (this.currentTool === 'move') {
                        // 如果点击到了对象，就不进行平移操作
                        if (!opt.target) {
                            this.isPanning = true;
                            this.lastX = opt.e.clientX;
                            this.lastY = opt.e.clientY;
                            this.canvas.selection = true;
                            this.canvas.setCursor('grabbing');
                        }
                    } else if (this.currentTool === 'rectangle' && !this.isDrawing) {
                        this.startRectangleDrawing(pointer);
                    } else if (this.currentTool === 'polygon') {
                        this.handlePolygonDrawing(pointer);
                    } else if (this.currentTool === 'line' && !this.isDrawing) {
                        this.startLineDrawing(pointer);
                    }
                });
                
                // 鼠标移动事件
                this.canvas.on('mouse:move', (opt) => {
                    const pointer = this.canvas.getPointer(opt.e);
                    
                    if (this.isPanning && this.currentTool === 'move') {
                        this.handlePanning(opt);
                    } else if (this.isDrawing && this.currentTool === 'rectangle') {
                        this.continueRectangleDrawing(pointer);
                    } else if (this.isDrawing && this.currentTool === 'polygon') {
                        this.updateDrawingPolygon(pointer);
                    } else if (this.isDrawing && this.currentTool === 'line') {
                        this.continueLineDrawing(pointer);
                    }
                });
                
                // 鼠标释放事件
                this.canvas.on('mouse:up', () => {
                    if (this.currentTool === 'move') {
                        this.isPanning = false;
                        this.canvas.selection = true;
                        this.canvas.setCursor('default');
                    } else if (this.isDrawing && this.currentTool === 'rectangle') {
                        this.finishRectangleDrawing();
                    } else if (this.isDrawing && this.currentTool === 'line') {
                        this.finishLineDrawing();
                    }
                });
                
                // 双击事件 - 用于完成多边形绘制
                this.canvas.on('mouse:dblclick', (opt) => {
                    if (this.currentTool === 'polygon' && this.isDrawing && this.drawingPoints.length >= 6) { // 至少3个点(每个点两个坐标)
                        this.finishPolygonDrawing();
                    }
                });
                
                console.log('画布事件监听器设置完成');
            },
            // 加载园区列表
            loadParks() {
                console.log('正在加载园区列表...');
                // 加载园区列表数据
                axios.get('/api/asset/locations', { 
                    params: { type: 'park', parent_id: 'root' },
                    // 添加时间戳防止缓存
                    _t: new Date().getTime()
                })
                .then(response => {
                    if (response.data.success) {
                        console.log('加载园区列表成功，获取到', response.data.data.length, '个园区');
                        // 保存园区数据
                        this.parks = response.data.data;
                        
                        // 如果当前选中了园区，更新选中的园区数据
                        if (this.selectedPark) {
                            const updatedPark = this.parks.find(p => p.id === this.selectedPark.id);
                            if (updatedPark) {
                                console.log('更新选中的园区数据', updatedPark.name, 
                                          '有mapJson:', !!updatedPark.mapJson, 
                                          '有map_data:', !!updatedPark.map_data);
                                this.selectedPark = { ...updatedPark };
                            }
                        }
                    } else {
                        console.error('加载园区列表失败:', response.data.message);
                    }
                })
                .catch(error => {
                    console.error('加载园区列表失败:', error);
                });       
            },
            
            // 选择园区
            selectPark(park) {
                console.log('选择园区:', park.name, '有mapJson:', !!park.mapJson, '有map_data:', !!park.map_data);
                
                // 确保复制园区数据而不是引用
                this.selectedPark = JSON.parse(JSON.stringify(park));
                this.selectedBuilding = null;
                
                // 加载园区平面图
                this.$nextTick(() => {
                    // 确保DOM已更新
                    setTimeout(() => {
                        this.loadParkMap();
                    }, 100);
                });
            },
            
            // 加载园区平面图
            loadParkMap() {
                if (!this.selectedPark) {
                    console.error('没有选中的园区，无法加载平面图');
                    return;
                }
                
                console.log('加载园区平面图', this.selectedPark.name, 
                          '有mapJson:', !!this.selectedPark.mapJson, 
                          '有map_data:', !!this.selectedPark.map_data);
                
                if (!this.selectedPark.map_data && !this.selectedPark.mapJson) {
                    console.warn('园区没有平面图数据');
                    return;
                }
                
                const container = document.getElementById('parkMapCanvas');
                if (!container) {
                    console.error('找不到parkMapCanvas元素');
                    return;
                }
                
                // 设置canvas元素的宽高
                const width = container.parentElement.clientWidth;
                const height = Math.max(container.parentElement.clientHeight, 400);
                container.width = width;
                container.height = height;
                
                try {
                    // 如果已存在画布，先清理
                    if (this.parkCanvas) {
                        this.parkCanvas.dispose();
                    }
                    
                    // 创建画布对象
                    this.parkCanvas = new fabric.Canvas('parkMapCanvas', {
                        width: width,
                        height: height,
                        selection: false
                    });
                    
                    console.log('园区画布初始化成功，尺寸:', width, 'x', height);
                    
                    // 直接优先使用图像数据，更可靠
                    if (this.selectedPark.map_data && this.selectedPark.map_data.startsWith('data:image')) {
                        this.loadMapImage();
                        return;
                    }
                    
                    // 如果没有图像数据，尝试使用JSON数据
                    if (this.selectedPark.mapJson) {
                        try {
                            // 尝试简单加载JSON数据（不使用自定义reviver）
                            // 这种方法可能无法恢复自定义对象，但能保留基本形状
                            console.log('尝试加载JSON数据');
                            
                            // 检查mapJson是否为字符串，如果已经是对象则不需要解析
                            let mapData;
                            if (typeof this.selectedPark.mapJson === 'string') {
                                console.log('解析mapJson字符串');
                                mapData = JSON.parse(this.selectedPark.mapJson);
                            } else {
                                console.log('mapJson已经是对象');
                                mapData = this.selectedPark.mapJson;
                            }
                            
                            // 检查mapData格式
                            if (mapData && typeof mapData === 'object' && Array.isArray(mapData.objects)) {
                                console.log('可用的JSON对象, 创建基本形状');
                                
                                // 手动创建基本形状
                                mapData.objects.forEach(obj => {
                                    // 为所有对象应用通用属性
                                    const commonProps = {
                                        left: obj.left || 0,
                                        top: obj.top || 0,
                                        fill: (obj._fillEnabled === false) ? 'transparent' : (obj._fillColor || obj.fill || 'rgba(0, 123, 255, 0.2)'),
                                        stroke: obj._strokeColor || obj.stroke || '#007bff',
                                        strokeWidth: obj._strokeWidth || obj.strokeWidth || 2,
                                        scaleX: obj.scaleX || 1,
                                        scaleY: obj.scaleY || 1,
                                        angle: obj.angle || 0,
                                        selectable: false,
                                        _fillEnabled: obj._fillEnabled,
                                        _fillColor: obj._fillColor,
                                        _strokeColor: obj._strokeColor,
                                        _strokeWidth: obj._strokeWidth
                                    };
                                    
                                    let shape = null;
                                    
                                    if (obj._fftype === 'rect') {
                                        // 创建矩形
                                        shape = new fabric.Rect({
                                            ...commonProps,
                                            width: obj.width || 100,
                                            height: obj.height || 100,
                                            _fftype: 'rect'
                                        });
                                        this.parkCanvas.add(shape);
                                    } else if (obj._fftype === 'polygon' && obj.points) {
                                        // 创建多边形
                                        const points = obj.points.map(p => ({ x: p.x, y: p.y }));
                                        shape = new fabric.Polygon(points, {
                                            ...commonProps,
                                            _fftype: 'polygon'
                                        });
                                        this.parkCanvas.add(shape);
                                    } else if (obj._fftype === 'line') {
                                        // 创建线段
                                        shape = new fabric.Line(
                                            [obj.x1 || 0, obj.y1 || 0, obj.x2 || 100, obj.y2 || 100], 
                                            {
                                                ...commonProps,
                                                _fftype: 'line'
                                            }
                                        );
                                        this.parkCanvas.add(shape);
                                    }
                                });
                                
                                this.parkCanvas.renderAll();
                                console.log('从JSON数据手动重建园区地图成功');
                                
                                // 同步样式设置 - 从第一个对象中恢复全局样式设置
                                this.updateGlobalStylesFromObjects(mapData.objects);
                                
                                // 加载建筑物
                                this.loadBuildings();
                            } else {
                                throw new Error('无效的地图JSON数据格式');
                            }
                        } catch (e) {
                            console.error('解析JSON地图数据失败:', e);
                            console.log('尝试使用图像数据作为备选');
                            
                            // 尝试使用图像数据作为备选
                            if (this.selectedPark.map_data && this.selectedPark.map_data.startsWith('data:image')) {
                                this.loadMapImage();
                            } else {
                                // 创建空白画布
                                console.log('无法加载地图数据，创建空白画布');
                                this.parkCanvas.renderAll();
                            }
                        }
                    } else {
                        // 创建空白画布
                        console.log('没有可用的地图数据，创建空白画布');
                        this.parkCanvas.renderAll();
                    }
                } catch (error) {
                    console.error('初始化园区地图Canvas失败:', error);
                    
                    // 尝试创建基本画布
                    if (this.parkCanvas) {
                        this.parkCanvas.renderAll();
                    }
                }
            },
            
            // 加载地图图像
            loadMapImage() {
                if (!this.parkCanvas || !this.selectedPark.map_data) return;
                
                // 确保map_data是图像数据
                if (!this.selectedPark.map_data.startsWith('data:image')) {
                    console.error('非图像数据无法加载:', this.selectedPark.map_data.substring(0, 50) + '...');
                    return;
                }
                
                fabric.Image.fromURL(this.selectedPark.map_data, (img) => {
                    // 调整图像大小以适应画布
                    const canvasWidth = this.parkCanvas.width;
                    const canvasHeight = this.parkCanvas.height;
                    
                    // 保持图像比例
                    const scale = Math.min(
                        canvasWidth / img.width,
                        canvasHeight / img.height
                    );
                    
                    img.scale(scale);
                    
                    // 居中放置
                    img.set({
                        left: (canvasWidth - img.width * scale) / 2,
                        top: (canvasHeight - img.height * scale) / 2
                    });
                    
                    this.parkCanvas.add(img);
                    this.parkCanvas.renderAll();
                    console.log('从图像加载园区地图成功');
                    
                    // 加载建筑物
                    this.loadBuildings();
                });
            },
            
            // 加载建筑物
            loadBuildings() {
                if (!this.selectedPark) return;
                
                axios.get('/api/asset/locations', { params: { type: 'building', parent_id: this.selectedPark.id } })
                    .then(response => {
                        if (response.data.success) {
                            const buildings = response.data.data;
                            
                            // 在园区平面图上显示建筑物
                            buildings.forEach(building => {
                                if (building.coordinate_x !== null && building.coordinate_y !== null) {
                                    this.renderBuildingOnParkMap(building);
                                }
                            });
                        }
                    })
                    .catch(error => {
                        console.error('加载建筑物失败:', error);
                    });
            },
            
            // 渲染建筑物到园区平面图
            renderBuildingOnParkMap(building) {
                if (!this.parkCanvas) return;
                
                // 创建建筑物表示
                const buildingRect = new fabric.Rect({
                    left: building.coordinate_x,
                    top: building.coordinate_y,
                    width: building.width || 100,
                    height: building.height || 100,
                    fill: '#b3e5fc',
                    stroke: '#29b6f6',
                    strokeWidth: 2,
                    rx: 5,
                    ry: 5,
                    objectCaching: false,
                    buildingId: building.id
                });
                
                // 添加建筑物名称标签
                const buildingLabel = new fabric.Text(building.name, {
                    left: building.coordinate_x + 5,
                    top: building.coordinate_y + 5,
                    fontSize: 14,
                    fill: '#01579b'
                });
                
                // 添加到画布
                this.parkCanvas.add(buildingRect, buildingLabel);
                
                // 点击事件
                buildingRect.on('mousedown', () => {
                    // 打开该建筑物
                    axios.get(`/api/asset/locations/${building.id}`)
                        .then(response => {
                            if (response.data.success) {
                                this.selectedBuilding = response.data.data;
                                this.selectedPark = null;
                                this.loadBuildingMap();
                            }
                        })
                        .catch(error => {
                            console.error('加载建筑物详情失败:', error);
                        });
                });
            },
            
            // 拖拽相关方法 - 开始拖拽
            dragStart(event, index) {
                event.dataTransfer.effectAllowed = 'move';
                event.dataTransfer.setData('parkId', this.parks[index].id);
            },
            
            // 在另一个项上放下
            onDrop(event, index) {
                const draggedParkId = event.dataTransfer.getData('parkId');
                const draggedIndex = this.parks.findIndex(p => p.id.toString() === draggedParkId);
                
                if (draggedIndex === -1 || draggedIndex === index) {
                    return;
                }
                
                // 移动元素
                const movedItem = this.parks.splice(draggedIndex, 1)[0];
                this.parks.splice(index, 0, movedItem);
            },
            
            // 保存园区排序
            saveParksOrder() {
                const orderedIds = this.parks.map(park => park.id);
                
                axios.post('/api/asset/locations/update-order', { ordered_ids: orderedIds })
                    .then(response => {
                        if (!response.data.success) {
                            console.error('保存排序失败:', response.data.message);
                        }
                    })
                    .catch(error => {
                        console.error('保存排序失败:', error);
                    });
            },
            
            // 确认删除园区
            confirmDeletePark(park) {
                this.parkToDelete = park;
                $('#deleteParkModal').modal('show');
            },
            
            // 删除园区
            deletePark() {
                if (!this.parkToDelete || !this.parkToDelete.id) {
                    console.error('需要删除的园区不存在');
                    return;
                }
                
                axios.delete(`/api/asset/locations/${this.parkToDelete.id}`)
                    .then(response => {
                        if (response.data.success) {
                            // 关闭模态框
                            $('#deleteParkModal').modal('hide');
                            
                            // 重新加载园区列表
                            this.loadParks();
                            
                            // 如果当前选中的是要删除的园区，则清除选中状态
                            if (this.selectedPark && this.selectedPark.id === this.parkToDelete.id) {
                                this.selectedPark = null;
                            }
                            
                            // 清除待删除对象
                            this.parkToDelete = null;
                        } else {
                            alert('删除失败: ' + response.data.message);
                        }
                    })
                    .catch(error => {
                        console.error('删除园区失败:', error);
                        alert('删除失败: ' + error.response?.data?.message || error.message);
                    });
            },
            
            // 编辑园区
            editPark(park) {
                // 重命名函数以避免缓存问题
                this.editParkWithMapData(park);
            },
            
            // 新的编辑园区功能（包含地图加载）
            editParkWithMapData(park) {
                console.log('编辑园区(新方法):', park.name);
                
                // 先重新加载最新的园区数据
                axios.get(`/api/asset/locations/${park.id}`, {
                    _t: new Date().getTime() // 防止缓存
                })
                .then(response => {
                    if (response.data.success) {
                        console.log('获取最新园区数据成功');
                        const freshParkData = response.data.data;
                        
                        // 将编辑表单数据设置为最新数据
                        this.editParkForm = {
                            id: freshParkData.id,
                            name: freshParkData.name,
                            code: freshParkData.code,
                            description: freshParkData.description || '',
                            map_data: freshParkData.map_data,
                            mapJson: freshParkData.mapJson
                        };
                        
                        console.log('准备加载园区平面图数据:',
                            '有mapJson:', !!freshParkData.mapJson,
                            '有map_data:', !!freshParkData.map_data);
                        
                        // 每次重新添加modal事件前先移除之前的事件监听器
                        $('#editParkModal').off('shown.bs.modal');
                        
                        // 显示编辑模态框
                        $('#editParkModal').modal('show');
                        
                        // 初始化绘图画布 - 在模态框完全显示后
                        $('#editParkModal').on('shown.bs.modal', () => {
                            console.log('模态框显示完成，初始化画布');
                            this.initMapEditor();
                            
                            // 如果有地图数据，加载到画布
                            if (freshParkData.mapJson && this.canvas) {
                                console.log('在编辑模式下尝试加载现有平面图数据');
                                try {
                                    // 尝试解析mapJson
                                    let mapData;
                                    if (typeof freshParkData.mapJson === 'string') {
                                        console.log('解析mapJson字符串');
                                        mapData = JSON.parse(freshParkData.mapJson);
                                    } else {
                                        console.log('mapJson已经是对象');
                                        mapData = freshParkData.mapJson;
                                    }
                                    
                                    // 手动创建对象
                                    if (mapData && typeof mapData === 'object' && Array.isArray(mapData.objects)) {
                                        console.log('创建对象: 发现', mapData.objects.length, '个形状');
                                        
                                        // 为所有对象应用通用属性
                                        mapData.objects.forEach(obj => {
                                            const commonProps = {
                                                left: obj.left || 0,
                                                top: obj.top || 0,
                                                fill: (obj._fillEnabled === false) ? 'transparent' : (obj._fillColor || obj.fill || 'rgba(0, 123, 255, 0.2)'),
                                                stroke: obj._strokeColor || obj.stroke || '#007bff',
                                                strokeWidth: obj._strokeWidth || obj.strokeWidth || 2,
                                                scaleX: obj.scaleX || 1,
                                                scaleY: obj.scaleY || 1,
                                                angle: obj.angle || 0,
                                                selectable: true,
                                                _fillEnabled: obj._fillEnabled,
                                                _fillColor: obj._fillColor,
                                                _strokeColor: obj._strokeColor,
                                                _strokeWidth: obj._strokeWidth
                                            };
                                            
                                            let shape = null;
                                        
                                            if (obj._fftype === 'rect') {
                                                // 创建矩形
                                                shape = new fabric.Rect({
                                                    ...commonProps,
                                                    width: obj.width || 100,
                                                    height: obj.height || 100,
                                                    _fftype: 'rect'
                                                });
                                                this.canvas.add(shape);
                                                
                                                // 添加到shapes数组，方便以后引用
                                                this.shapes.push(shape);
                                            } else if (obj._fftype === 'polygon' && obj.points) {
                                                // 创建多边形
                                                const points = obj.points.map(p => ({ x: p.x, y: p.y }));
                                                shape = new fabric.Polygon(points, {
                                                    ...commonProps,
                                                    _fftype: 'polygon'
                                                });
                                                this.canvas.add(shape);
                                                
                                                // 添加到shapes数组
                                                this.shapes.push(shape);
                                            } else if (obj._fftype === 'line') {
                                                // 创建线段
                                                shape = new fabric.Line(
                                                    [obj.x1 || 0, obj.y1 || 0, obj.x2 || 100, obj.y2 || 100], 
                                                    {
                                                        ...commonProps,
                                                        _fftype: 'line'
                                                    }
                                                );
                                                this.canvas.add(shape);
                                                
                                                // 添加到shapes数组
                                                this.shapes.push(shape);
                                            }
                                        });
                                        
                                        this.canvas.renderAll();
                                        console.log('编辑模式: 成功加载', this.shapes.length, '个形状到画布');
                                        
                                        // 同步样式设置 - 从第一个对象中恢复全局样式设置
                                        this.updateGlobalStylesFromObjects(mapData.objects);
                                    } else {
                                        console.warn('无法解析JSON数据或数据格式不正确');
                                        this.drawGrid();
                                    }
                                } catch (error) {
                                    console.error('编辑模式下加载园区地图数据失败:', error);
                                    console.log('尝试使用图像作为背景');
                                    
                                    // 尝试加载图像作为背景
                                    if (freshParkData.map_data && freshParkData.map_data.startsWith('data:image')) {
                                        fabric.Image.fromURL(freshParkData.map_data, (img) => {
                                            img.set({
                                                scaleX: this.canvas.width / img.width,
                                                scaleY: this.canvas.height / img.height,
                                                selectable: false
                                            });
                                            this.canvas.setBackgroundImage(img, this.canvas.renderAll.bind(this.canvas));
                                            console.log('加载图像作为编辑背景');
                                        });
                                    } else {
                                        // 如果JSON加载失败，重新绘制网格
                                        this.drawGrid();
                                    }
                                }
                            } else {
                                console.log('没有现有平面图数据，绘制空白网格');
                                // 没有地图数据，只绘制网格
                                this.shapes = [];
                                this.drawGrid();
                            }
                        });
                        
                        console.log('编辑园区事件设置完成');
                    } else {
                        console.error('获取园区数据失败:', response.data.message);
                        alert('获取园区数据失败，无法编辑园区');
                    }
                })
                .catch(error => {
                    console.error('获取园区数据失败:', error);
                    alert('获取园区数据失败，无法编辑园区');
                });
            },
            
            // 更新园区
            updatePark() {
                // 表单验证
                if (!this.editParkForm.name || !this.editParkForm.code) {
                    alert('请填写必填项！');
                    return;
                }
                
                // 保存绘图数据
                if (this.canvas) {
                    try {
                        // 确保所有对象都有正确的类型属性和样式属性
                        this.canvas.getObjects().forEach(obj => {
                            if (obj.type === 'rect' && !obj.hasOwnProperty('_fftype')) {
                                obj.set('_fftype', 'rect');
                            } else if (obj.type === 'polygon' && !obj.hasOwnProperty('_fftype')) {
                                obj.set('_fftype', 'polygon');
                            } else if (obj.type === 'circle' && !obj.hasOwnProperty('_fftype')) {
                                obj.set('_fftype', 'circle');
                            } else if (obj.type === 'line' && !obj.isGridLine) {
                                obj.set('_fftype', 'line');
                            }
                            
                            // 确保保存填充和线条样式属性
                            if (!obj.isGridLine) {
                                // 为每个对象添加自定义样式属性，确保能重新加载时恢复
                                obj.set('_fillEnabled', this.fillEnabled);
                                obj.set('_fillColor', this.fillColor);
                                obj.set('_strokeColor', this.strokeColor);
                                obj.set('_strokeWidth', this.strokeWidth);
                            }
                        });
                        
                        // 创建包含必要数据的JSON对象，包括我们添加的自定义属性
                        const canvasJSON = this.canvas.toJSON([
                            'type', 'selectable', '_fftype', 
                            '_fillEnabled', '_fillColor', '_strokeColor', '_strokeWidth'
                        ]);
                        
                        // 验证JSON对象格式是否正确
                        if (!canvasJSON || !canvasJSON.objects) {
                            console.error('无法获取有效的画布JSON数据');
                            canvasJSON.objects = [];
                        }
                        
                        // 输出完整的JSON数据用于调试
                        console.log('保存的canvasJSON数据:', JSON.stringify(canvasJSON));
                        
                        // 保存为JSON字符串
                        this.editParkForm.mapJson = JSON.stringify(canvasJSON);
                        
                        // 保存为图像数据（可选但必要，确保在没有JSON数据时有备用）
                        this.editParkForm.map_data = this.canvas.toDataURL({
                            format: 'png',
                            quality: 0.8
                        });
                        
                        console.log('保存平面图数据:',
                            'JSON对象格式:', !!canvasJSON,
                            'objects数组:', Array.isArray(canvasJSON.objects),
                            'objects长度:', canvasJSON.objects.length,
                            '有图像数据:', !!this.editParkForm.map_data);
                    } catch (e) {
                        console.error('生成画布JSON数据失败:', e);
                        alert('保存平面图数据时出错: ' + e.message);
                        return;
                    }
                }
                
                // 调用API更新园区
                axios.post('/api/asset/locations', this.editParkForm)
                    .then(response => {
                        if (response.data.success) {
                            // 更新本地数据
                            const index = this.parks.findIndex(p => p.id === this.editParkForm.id);
                            if (index !== -1) {
                                // 更新园区数据
                                this.parks[index].name = this.editParkForm.name;
                                this.parks[index].code = this.editParkForm.code;
                                this.parks[index].description = this.editParkForm.description;
                                
                                // 更新平面图数据
                                this.parks[index].map_data = this.editParkForm.map_data;
                                this.parks[index].mapJson = this.editParkForm.mapJson;
                                
                                // 更新selectedPark
                                if (this.selectedPark && this.selectedPark.id === this.editParkForm.id) {
                                    this.selectedPark = { ...this.parks[index] };
                                    
                                    // 关闭模态框后重新加载园区地图
                                    setTimeout(() => {
                                        this.loadParkMap();
                                    }, 500);
                                }
                            }
                            
                            // 关闭模态框
                            $('#editParkModal').modal('hide');
                            console.log('更新园区成功');
                            
                            // 保存成功后重新加载园区列表，确保获取最新数据
                            this.loadParks();
                        } else {
                            alert('更新园区失败: ' + response.data.message);
                        }
                    })
                    .catch(error => {
                        console.error('更新园区失败:', error);
                        alert('更新园区失败: ' + (error.response?.data?.message || error.message));
                    });
            },
            
            // 初始化园区编辑器 (编辑现有园区时使用)
            initParkMapEditor() {
                // 初始化园区编辑器
                const container = document.getElementById('editParkMapEditor');
                if (!container) return;
                
                this.parkCanvas = new fabric.Canvas('editParkMapEditor', {
                    width: container.offsetWidth,
                    height: container.offsetHeight,
                    selection: false,
                    backgroundColor: '#f8f9fa'
                });
                
                // 添加网格背景
                this.drawGrid(this.parkCanvas, 20, '#e0e0e0');
            },
            
            // 激活矩形工具
            activateRectangleTool() {
                this.currentTool = 'rectangle';
                if (this.canvas) {
                    this.canvas.defaultCursor = 'crosshair';
                    this.canvas.selection = false;
                    this.canvas.discardActiveObject();
                    
                    // 禁用对象选择和移动功能
                    this.canvas.getObjects().forEach(obj => {
                        if (!obj.isGridLine) {
                            obj.selectable = false;
                            obj.evented = false;
                        }
                    });
                    
                    this.canvas.renderAll();
                }
                this.isDrawing = false;
                console.log('激活矩形工具');
            },
            
            // 激活多边形工具
            activatePolygonTool() {
                this.currentTool = 'polygon';
                if (this.canvas) {
                    this.canvas.defaultCursor = 'crosshair';
                    this.canvas.selection = false;
                    this.canvas.discardActiveObject();
                    
                    // 禁用对象选择和移动功能
                    this.canvas.getObjects().forEach(obj => {
                        if (!obj.isGridLine) {
                            obj.selectable = false;
                            obj.evented = false;
                        }
                    });
                    
                    this.canvas.renderAll();
                }
                this.drawingPoints = [];
                this.isDrawing = false;
                console.log('激活多边形工具');
            },
            
            // 激活缩放工具
            activateZoomTool() {
                this.currentTool = 'zoom';
                if (this.canvas) {
                    this.canvas.defaultCursor = 'zoom-in';
                    this.canvas.selection = false;
                    this.canvas.discardActiveObject();
                    
                    // 禁用对象选择和移动功能
                    this.canvas.getObjects().forEach(obj => {
                        if (!obj.isGridLine) {
                            obj.selectable = false;
                            obj.evented = false;
                        }
                    });
                    
                    this.canvas.renderAll();
                }
                console.log('激活缩放工具');
            },
            
            // 激活移动工具
            activateMoveTool() {
                this.currentTool = 'move';
                if (this.canvas) {
                    this.canvas.defaultCursor = 'grab';
                    this.canvas.selection = true;
                    
                    // 启用所有对象的选择和移动功能
                    this.canvas.getObjects().forEach(obj => {
                        if (!obj.isGridLine) {
                            obj.selectable = true;
                            obj.evented = true;
                        }
                    });
                    
                    this.canvas.renderAll();
                }
                console.log('激活移动工具');
            },
            
            // 激活线段工具
            activateLineTool() {
                this.currentTool = 'line';
                if (this.canvas) {
                    this.canvas.defaultCursor = 'crosshair';
                    this.canvas.selection = false;
                    this.canvas.discardActiveObject();
                    
                    // 禁用对象选择和移动功能
                    this.canvas.getObjects().forEach(obj => {
                        if (!obj.isGridLine) {
                            obj.selectable = false;
                            obj.evented = false;
                        }
                    });
                    
                    this.canvas.renderAll();
                }
                this.isDrawing = false;
                console.log('激活线段工具');
            },
            
            // 开始矩形绘制
            startRectangleDrawing(pointer) {
                this.isDrawing = true;
                this.startPosition = pointer;
                
                // 创建新矩形，根据是否启用填充来设置填充颜色
                this.drawingShape = new fabric.Rect({
                    left: pointer.x,
                    top: pointer.y,
                    width: 0,
                    height: 0,
                    fill: this.fillEnabled ? this.fillColor : 'transparent',
                    stroke: this.strokeColor,
                    strokeWidth: parseInt(this.strokeWidth),
                    selectable: true,
                    type: 'park_shape',
                    _fftype: 'rect'  // 添加自定义类型标记
                });
                
                this.canvas.add(this.drawingShape);
            },
            
            // 继续矩形绘制
            continueRectangleDrawing(pointer) {
                if (!this.startPosition) return;
                
                let width = pointer.x - this.startPosition.x;
                let height = pointer.y - this.startPosition.y;
                
                // 处理负数情况
                if (width < 0) {
                    this.drawingShape.set('left', pointer.x);
                    width = Math.abs(width);
                } else {
                    this.drawingShape.set('left', this.startPosition.x);
                }
                
                if (height < 0) {
                    this.drawingShape.set('top', pointer.y);
                    height = Math.abs(height);
                } else {
                    this.drawingShape.set('top', this.startPosition.y);
                }
                
                this.drawingShape.set({
                    width: width,
                    height: height
                });
                
                this.canvas.renderAll();
            },
            
            // 完成矩形绘制
            finishRectangleDrawing() {
                this.isDrawing = false;
                this.startPosition = null;
                
                // 将绘制的形状添加到shapes数组
                if (this.drawingShape && this.drawingShape.width > 5 && this.drawingShape.height > 5) {
                    this.drawingShape.setCoords();
                    this.shapes.push(this.drawingShape);
                } else if (this.drawingShape) {
                    // 如果太小，移除它
                    this.canvas.remove(this.drawingShape);
                }
                
                this.drawingShape = null;
                this.canvas.renderAll();
            },
            
            // 处理多边形绘制
            handlePolygonDrawing(pointer) {
                if (!this.isDrawing) {
                    // 开始新的多边形
                    this.isDrawing = true;
                    this.drawingPoints = [pointer.x, pointer.y];
                    
                    // 创建初始点
                    const circle = new fabric.Circle({
                        left: pointer.x,
                        top: pointer.y,
                        radius: 5,
                        fill: this.strokeColor,
                        originX: 'center',
                        originY: 'center',
                        selectable: false,
                        type: 'polygon_point'
                    });
                    
                    this.canvas.add(circle);
                    
                    // 创建初始多边形线
                    this.drawingShape = new fabric.Polyline([{
                        x: pointer.x,
                        y: pointer.y
                    }], {
                        fill: 'transparent',
                        stroke: this.strokeColor,
                        strokeWidth: parseInt(this.strokeWidth),
                        selectable: false,
                        type: 'drawing_polygon'
                    });
                    
                    this.canvas.add(this.drawingShape);
                } else {
                    // 检查是否点击了起始点以完成多边形
                    const startPoint = {
                        x: this.drawingPoints[0],
                        y: this.drawingPoints[1]
                    };
                    
                    const distance = Math.sqrt(Math.pow(pointer.x - startPoint.x, 2) + Math.pow(pointer.y - startPoint.y, 2));
                    
                    if (distance < 20 && this.drawingPoints.length > 4) {
                        // 关闭多边形
                        this.finishPolygonDrawing();
                    } else {
                        // 添加新点
                        this.drawingPoints.push(pointer.x, pointer.y);
                        
                        // 添加点标记
                        const circle = new fabric.Circle({
                            left: pointer.x,
                            top: pointer.y,
                            radius: 5,
                            fill: this.strokeColor,
                            originX: 'center',
                            originY: 'center',
                            selectable: false,
                            type: 'polygon_point'
                        });
                        
                        this.canvas.add(circle);
                        
                        // 更新多边形线
                        this.updateDrawingPolygon(pointer);
                    }
                }
            },
            
            // 更新绘制中的多边形
            updateDrawingPolygon(pointer) {
                if (!this.isDrawing || !this.drawingShape) return;
                
                // 创建多边形点数组
                const points = [];
                for (let i = 0; i < this.drawingPoints.length; i += 2) {
                    points.push({
                        x: this.drawingPoints[i],
                        y: this.drawingPoints[i + 1]
                    });
                }
                
                // 添加当前鼠标位置作为临时点
                points.push({
                    x: pointer.x,
                    y: pointer.y
                });
                
                // 更新多边形线
                this.drawingShape.set('points', points);
                this.canvas.renderAll();
            },
            
            // 完成多边形绘制
            finishPolygonDrawing() {
                if (!this.isDrawing || !this.drawingShape) return;
                
                // 移除临时多边形线和点
                this.canvas.remove(this.drawingShape);
                this.canvas.getObjects().filter(obj => obj.type === 'polygon_point').forEach(obj => {
                    this.canvas.remove(obj);
                });
                
                // 创建多边形点数组
                const points = [];
                for (let i = 0; i < this.drawingPoints.length; i += 2) {
                    points.push({
                        x: this.drawingPoints[i],
                        y: this.drawingPoints[i + 1]
                    });
                }
                
                // 创建最终多边形，根据是否启用填充来设置填充颜色
                const polygon = new fabric.Polygon(points, {
                    fill: this.fillEnabled ? this.fillColor : 'transparent',
                    stroke: this.strokeColor,
                    strokeWidth: parseInt(this.strokeWidth),
                    selectable: true,
                    type: 'park_shape',
                    _fftype: 'polygon'  // 添加自定义类型标记
                });
                
                this.canvas.add(polygon);
                this.shapes.push(polygon);
                
                // 重置绘制状态
                this.isDrawing = false;
                this.drawingShape = null;
                this.drawingPoints = [];
                
                this.canvas.renderAll();
            },
            
            // 清除画布
            clearCanvas() {
                if (confirm('确定要清除当前绘图吗？')) {
                    this.canvas.clear();
                    this.drawGrid();
                    
                    // 重置状态
                    this.shapes = [];
                    this.isDrawing = false;
                    this.drawingShape = null;
                    this.drawingPoints = [];
                }
            },
            
            // 显示添加园区模态框
            showAddParkModal() {
                // 重置表单
                this.parkForm = {
                    name: '',
                    code: '',
                    description: '',
                    type: 'park',
                    level: 1,
                    parent_id: null,
                    map_data: null
                };
                
                $('#addParkModal').modal('show');
                console.log('显示添加园区模态框');
            },
            
            // 保存园区
            savePark() {
                // 校验
                if (!this.parkForm.name) {
                    alert('请输入园区名称');
                    return;
                }
                
                if (!this.parkForm.code) {
                    alert('请输入园区编码');
                    return;
                }
                
                // 发送请求
                axios.post('/api/asset/locations', this.parkForm)
                    .then(response => {
                        if (response.data.success) {
                            // 关闭模态框
                            $('#addParkModal').modal('hide');
                            
                            // 重新加载园区列表
                            this.loadParks();
                        } else {
                            alert('保存失败: ' + response.data.message);
                        }
                    })
                    .catch(error => {
                        console.error('保存园区失败:', error);
                        alert('保存失败: ' + error.response?.data?.message || error.message);
                    });
            },
            
            // 关闭添加园区模态框
            closeAddParkModal() {
                $('#addParkModal').modal('hide');
                console.log('关闭添加园区模态框');
            },
            
            // 编辑园区平面图
            editParkMap() {
                if (!this.selectedPark) return;
                
                console.log('开始编辑园区平面图:', this.selectedPark.name);
                
                // 先重新加载最新的园区数据
                axios.get(`/api/asset/locations/${this.selectedPark.id}`, {
                    _t: new Date().getTime() // 防止缓存
                })
                .then(response => {
                    if (response.data.success) {
                        console.log('获取最新园区数据成功');
                        const freshParkData = response.data.data;
                        
                        // 更新本地selectedPark数据
                        this.selectedPark = { ...freshParkData };
                        
                        // 将编辑表单数据设置为最新数据
                        this.editParkForm = {
                            id: freshParkData.id,
                            name: freshParkData.name,
                            code: freshParkData.code,
                            description: freshParkData.description || '',
                            map_data: freshParkData.map_data,
                            mapJson: freshParkData.mapJson
                        };
                        
                        console.log('准备加载园区平面图数据:',
                            '有mapJson:', !!freshParkData.mapJson,
                            '有map_data:', !!freshParkData.map_data);
                        
                        // 每次重新添加modal事件前先移除之前的事件监听器
                        $('#editParkModal').off('shown.bs.modal');
                        
                        // 显示编辑模态框
                        $('#editParkModal').modal('show');
                        
                        // 初始化绘图画布 - 在模态框完全显示后
                        $('#editParkModal').on('shown.bs.modal', () => {
                            console.log('模态框显示完成，初始化画布');
                            this.initMapEditor();
                            
                            // 如果有地图数据，加载到画布
                            if (freshParkData.mapJson && this.canvas) {
                                console.log('在编辑模式下尝试加载现有平面图数据');
                                try {
                                    // 尝试解析mapJson
                                    let mapData;
                                    if (typeof freshParkData.mapJson === 'string') {
                                        console.log('解析mapJson字符串');
                                        mapData = JSON.parse(freshParkData.mapJson);
                                    } else {
                                        console.log('mapJson已经是对象');
                                        mapData = freshParkData.mapJson;
                                    }
                                    
                                    // 手动创建对象
                                    if (mapData && typeof mapData === 'object' && Array.isArray(mapData.objects)) {
                                        console.log('创建对象: 发现', mapData.objects.length, '个形状');
                                        
                                        // 为所有对象应用通用属性
                                        mapData.objects.forEach(obj => {
                                            const commonProps = {
                                                left: obj.left || 0,
                                                top: obj.top || 0,
                                                fill: (obj._fillEnabled === false) ? 'transparent' : (obj._fillColor || obj.fill || 'rgba(0, 123, 255, 0.2)'),
                                                stroke: obj._strokeColor || obj.stroke || '#007bff',
                                                strokeWidth: obj._strokeWidth || obj.strokeWidth || 2,
                                                scaleX: obj.scaleX || 1,
                                                scaleY: obj.scaleY || 1,
                                                angle: obj.angle || 0,
                                                selectable: true,
                                                _fillEnabled: obj._fillEnabled,
                                                _fillColor: obj._fillColor,
                                                _strokeColor: obj._strokeColor,
                                                _strokeWidth: obj._strokeWidth
                                            };
                                            
                                            let shape = null;
                                        
                                            if (obj._fftype === 'rect') {
                                                // 创建矩形
                                                shape = new fabric.Rect({
                                                    ...commonProps,
                                                    width: obj.width || 100,
                                                    height: obj.height || 100,
                                                    _fftype: 'rect'
                                                });
                                                this.canvas.add(shape);
                                                
                                                // 添加到shapes数组，方便以后引用
                                                this.shapes.push(shape);
                                            } else if (obj._fftype === 'polygon' && obj.points) {
                                                // 创建多边形
                                                const points = obj.points.map(p => ({ x: p.x, y: p.y }));
                                                shape = new fabric.Polygon(points, {
                                                    ...commonProps,
                                                    _fftype: 'polygon'
                                                });
                                                this.canvas.add(shape);
                                                
                                                // 添加到shapes数组
                                                this.shapes.push(shape);
                                            } else if (obj._fftype === 'line') {
                                                // 创建线段
                                                shape = new fabric.Line(
                                                    [obj.x1 || 0, obj.y1 || 0, obj.x2 || 100, obj.y2 || 100], 
                                                    {
                                                        ...commonProps,
                                                        _fftype: 'line'
                                                    }
                                                );
                                                this.canvas.add(shape);
                                                
                                                // 添加到shapes数组
                                                this.shapes.push(shape);
                                            }
                                        });
                                        
                                        this.canvas.renderAll();
                                        console.log('编辑模式: 成功加载', this.shapes.length, '个形状到画布');
                                        
                                        // 同步样式设置 - 从第一个对象中恢复全局样式设置
                                        this.updateGlobalStylesFromObjects(mapData.objects);
                                    } else {
                                        console.warn('无法解析JSON数据或数据格式不正确');
                                        this.drawGrid();
                                    }
                                } catch (error) {
                                    console.error('编辑模式下加载园区地图数据失败:', error);
                                    console.log('尝试使用图像作为背景');
                                    
                                    // 尝试加载图像作为背景
                                    if (freshParkData.map_data && freshParkData.map_data.startsWith('data:image')) {
                                        fabric.Image.fromURL(freshParkData.map_data, (img) => {
                                            img.set({
                                                scaleX: this.canvas.width / img.width,
                                                scaleY: this.canvas.height / img.height,
                                                selectable: false
                                            });
                                            this.canvas.setBackgroundImage(img, this.canvas.renderAll.bind(this.canvas));
                                            console.log('加载图像作为编辑背景');
                                        });
                                    } else {
                                        // 如果JSON加载失败，重新绘制网格
                                        this.drawGrid();
                                    }
                                }
                            } else {
                                console.log('没有现有平面图数据，绘制空白网格');
                                // 没有地图数据，只绘制网格
                                this.shapes = [];
                                this.drawGrid();
                            }
                        });
                        
                        console.log('编辑园区平面图事件设置完成');
                    } else {
                        console.error('获取园区数据失败:', response.data.message);
                        alert('获取园区数据失败，无法编辑平面图');
                    }
                })
                .catch(error => {
                    console.error('获取园区数据失败:', error);
                    alert('获取园区数据失败，无法编辑平面图');
                });
            },
            
            // 显示添加建筑模态框
            showAddBuildingModal() {
                this.buildingForm = {
                    name: '',
                    code: '',
                    description: '',
                    is_multi_floor: false,
                    floor_count: 1
                };
                $('#addBuildingModal').modal('show');
            },
            
            // 保存建筑
            saveBuilding() {
                // TODO: 验证表单
                // TODO: 调用API保存建筑
                
                // 暂时使用模拟数据
                const newBuilding = {
                    id: Date.now(),
                    name: this.buildingForm.name,
                    code: this.buildingForm.code,
                    description: this.buildingForm.description,
                    is_multi_floor: this.buildingForm.is_multi_floor,
                    floor_count: this.buildingForm.floor_count,
                    map_data: null,
                    floors: []
                };
                
                // 如果是多层建筑，初始化楼层
                if (newBuilding.is_multi_floor) {
                    for (let i = 0; i < newBuilding.floor_count; i++) {
                        newBuilding.floors.push({
                            id: Date.now() + i,
                            name: `F${i+1}`,
                            map_data: null
                        });
                    }
                }
                
                // 添加到园区的建筑列表
                if (!this.selectedPark.buildings) {
                    this.selectedPark.buildings = [];
                }
                this.selectedPark.buildings.push(newBuilding);
                
                // 选中新建筑
                this.selectedBuilding = newBuilding;
                $('#addBuildingModal').modal('hide');
            },
            
            // 编辑建筑平面图
            editBuildingMap() {
                // TODO: 实现平面图编辑器
                alert('建筑平面图编辑功能即将开发');
            },
            
            // 管理楼层
            manageFloors() {
                if (this.selectedBuilding && this.selectedBuilding.is_multi_floor) {
                    this.floorCount = this.selectedBuilding.floor_count || 1;
                    this.floors = [];
                    
                    // 如果已有楼层数据，则加载
                    if (this.selectedBuilding.floors && this.selectedBuilding.floors.length > 0) {
                        this.floors = [...this.selectedBuilding.floors];
                    } else {
                        // 否则创建默认楼层
                        for (let i = 0; i < this.floorCount; i++) {
                            this.floors.push({
                                name: `F${i+1}`
                            });
                        }
                    }
                    
                    $('#manageFloorsModal').modal('show');
                }
            },
            
            // 监听楼层数量变化
            watchFloorCount() {
                // 当楼层数量变化时，动态调整楼层列表
                const newCount = parseInt(this.floorCount) || 1;
                const currentCount = this.floors.length;
                
                if (newCount > currentCount) {
                    // 增加楼层
                    for (let i = currentCount; i < newCount; i++) {
                        this.floors.push({
                            name: `F${i+1}`
                        });
                    }
                } else if (newCount < currentCount) {
                    // 减少楼层
                    this.floors = this.floors.slice(0, newCount);
                }
            },
            
            // 保存楼层设置
            saveFloors() {
                if (this.selectedBuilding) {
                    this.selectedBuilding.floor_count = this.floorCount;
                    this.selectedBuilding.floors = [...this.floors];
                    $('#manageFloorsModal').modal('hide');
                }
            },
            
            // 显示添加子建筑模态框
            showAddSubBuildingModal() {
                // 与添加建筑类似，但父级为当前选中的建筑
                this.buildingForm = {
                    name: '',
                    code: '',
                    description: '',
                    is_multi_floor: false,
                    floor_count: 1
                };
                $('#addBuildingModal').modal('show');
            },
            
            // 添加位置标记
            addLocationMarker() {
                this.locationForm = {
                    code: '',
                    description: ''
                };
                $('#addLocationModal').modal('show');
            },
            
            // 保存位置
            saveLocation() {
                // TODO: 验证表单
                // TODO: 调用API保存位置
                
                // 暂时使用模拟数据
                const newLocation = {
                    id: Date.now(),
                    code: this.locationForm.code,
                    description: this.locationForm.description,
                    x: 100, // 默认位置
                    y: 100,
                    width: 50,
                    height: 50
                };
                
                // 添加到当前容器的位置列表
                let container = this.selectedFloor || this.selectedBuilding;
                if (!container.locations) {
                    container.locations = [];
                }
                container.locations.push(newLocation);
                
                $('#addLocationModal').modal('hide');
                
                // TODO: 在平面图上添加位置方块
            },
            
            // 搜索设备
            searchDevices() {
                // 筛选设备列表
                if (this.deviceSearchQuery) {
                    const query = this.deviceSearchQuery.toLowerCase();
                    this.filteredDevices = this.devices.filter(device => {
                        return device.asset_number.toLowerCase().includes(query) || 
                               (device.name && device.name.toLowerCase().includes(query));
                    });
                } else {
                    this.filteredDevices = [...this.devices];
                }
            },
            
            // 绑定设备
            bindDevice(device) {
                // TODO: 调用API绑定设备到位置
                
                // 暂时模拟绑定逻辑
                if (this.selectedLocation) {
                    this.selectedLocation.device_id = device.id;
                    this.selectedLocation.device = {
                        asset_number: device.asset_number,
                        name: device.name
                    };
                }
                
                $('#bindDeviceModal').modal('hide');
            },
            
            // 窗口大小改变处理
            handleResize() {
                // 重新计算和调整适应窗口大小变化的布局
                if (this.parkCanvas) {
                    // 调整画布大小
                    const container = document.getElementById('parkMapCanvas');
                    if (container) {
                        const width = container.parentElement.clientWidth;
                        const height = container.parentElement.clientHeight;
                        container.width = width;
                        container.height = height;
                        
                        this.parkCanvas.setWidth(width);
                        this.parkCanvas.setHeight(height);
                        this.parkCanvas.renderAll();
                    }
                }
                
                // 如果canvas存在，也调整它的尺寸
                if (this.canvas) {
                    const container = document.getElementById('editParkMapEditor');
                    if (container) {
                        const width = container.parentElement.clientWidth;
                        // 使用offsetHeight更可靠地获取实际高度
                        const height = container.parentElement.offsetHeight - 10; // 减去拖动手柄的高度
                        
                        container.width = width;
                        container.height = height;
                        
                        this.canvas.setWidth(width);
                        this.canvas.setHeight(height);
                        this.canvas.renderAll();
                        console.log('Canvas调整为:', width, 'x', height);
                    }
                }
            },
            
            // 初始化编辑器大小调整功能
            initResizableEditor() {
                this.$nextTick(() => {
                    console.log('Initializing resizable editor');
                    
                    // 直接在Vue监听器中添加事件处理
                    // 不需要在这里添加事件监听器，因为我们使用了@mousedown指令
                    
                    // 添加调试信息，帮助排查问题
                    document.addEventListener('mousedown', (e) => {
                        if (e.target.closest('.resize-handle-vertical') || e.target.closest('.resize-handle-horizontal')) {
                            console.log('直接在document上捕获到resize-handle mousedown事件');
                        }
                    }, true);
                    
                    // 调整模态框显示后的行为
                    $('#editParkModal').off('shown.bs.modal').on('shown.bs.modal', () => {
                        console.log('模态框显示，重新初始化canvas');
                        
                        // 确保此时canvas已经初始化，否则再次初始化
                        if (!this.canvas) {
                            this.$nextTick(() => {
                                this.initMapEditor();
                            });
                        }
                    });
                });
            },
            
            // 鼠标按下拖动手柄的事件处理
            onResizeMouseDown(e, direction) {
                e.preventDefault();
                e.stopPropagation();
                console.log('Resize handle mousedown', direction, e.clientX, e.clientY);
                
                // 获取要调整大小的容器
                const container = e.target.closest('.resizable');
                if (!container) {
                    console.error('No resizable container found');
                    return;
                }
                
                // 显示正在尝试调整大小的容器
                console.log('调整容器:', container);
                console.log('起始尺寸:', container.offsetWidth, 'x', container.offsetHeight);
                
                // 记录初始位置和尺寸
                this.resizing = {
                    container: container,
                    startX: e.clientX,
                    startY: e.clientY,
                    startWidth: container.offsetWidth,
                    startHeight: container.offsetHeight,
                    direction: direction // 记录调整方向
                };
                
                // 保存对方法的引用，以便移除时使用相同的引用
                this.boundResizeMouseMove = (moveEvent) => {
                    this.onResizeMouseMove(moveEvent);
                };
                
                this.boundResizeMouseUp = (upEvent) => {
                    this.onResizeMouseUp(upEvent);
                };
                
                // 添加鼠标移动和释放事件
                document.addEventListener('mousemove', this.boundResizeMouseMove);
                document.addEventListener('mouseup', this.boundResizeMouseUp);
                
                // 防止其他元素接收事件
                document.body.style.userSelect = 'none';
                document.body.style.cursor = direction === 'vertical' ? 'ns-resize' : 'ew-resize';
            },
            
            // 鼠标移动事件处理
            onResizeMouseMove(e) {
                if (!this.resizing) {
                    console.log('No resizing object found');
                    return;
                }
                
                if (this.resizing.direction === 'vertical') {
                    // 垂直方向调整 - 高度
                    const deltaY = e.clientY - this.resizing.startY;
                    let newHeight = this.resizing.startHeight + deltaY;
                    
                    // 确保高度不低于最小值
                    const minHeight = parseInt(this.resizing.container.style.minHeight) || 400;
                    if (newHeight < minHeight) newHeight = minHeight;
                    
                    // 确保高度不超过最大值
                    const maxHeight = parseInt(this.resizing.container.style.maxHeight) || 1200;
                    if (newHeight > maxHeight) newHeight = maxHeight;
                    
                    console.log('设置新高度:', newHeight);
                    
                    // 设置新高度
                    this.resizing.container.style.height = `${newHeight}px`;
                    
                    // 如果canvas存在，也调整它的尺寸
                    if (this.canvas) {
                        const container = document.getElementById('editParkMapEditor');
                        if (container) {
                            const width = container.parentElement.clientWidth;
                            // 直接使用新设置的容器高度减去拖动手柄高度
                            const height = newHeight - 10; // 减去拖动手柄的高度
                            
                            container.width = width;
                            container.height = height;
                            
                            this.canvas.setWidth(width);
                            this.canvas.setHeight(height);
                            this.canvas.renderAll();
                            console.log('Canvas调整为:', width, 'x', height);
                        }
                    }
                } else if (this.resizing.direction === 'horizontal') {
                    // 水平方向调整 - 宽度
                    const deltaX = e.clientX - this.resizing.startX;
                    let newWidth = this.resizing.startWidth + deltaX;
                    
                    // 确保宽度不低于最小值
                    const minWidth = 400;
                    if (newWidth < minWidth) newWidth = minWidth;
                    
                    // 确保宽度不超过窗口宽度的95%
                    const maxWidth = window.innerWidth * 0.95;
                    if (newWidth > maxWidth) newWidth = maxWidth;
                    
                    console.log('设置新宽度:', newWidth);
                    
                    // 设置新宽度
                    this.resizing.container.style.width = `${newWidth}px`;
                    
                    // 如果canvas存在，也调整它的尺寸
                    if (this.canvas) {
                        const container = document.getElementById('editParkMapEditor');
                        if (container) {
                            // 直接使用新设置的容器宽度
                            const width = newWidth - 20; // 减去padding
                            const height = this.resizing.container.offsetHeight - 10; // 减去拖动手柄的高度
                            
                            container.width = width;
                            container.height = height; // 保持高度不变
                            
                            this.canvas.setWidth(width);
                            this.canvas.setHeight(height); // 同时设置高度以保持比例
                            this.canvas.renderAll();
                            console.log('Canvas调整为:', width, 'x', height);
                        }
                    }
                }
            },
            
            // 鼠标释放事件处理
            onResizeMouseUp(e) {
                console.log('Resize mouseup', e.clientX, e.clientY);
                
                if (this.resizing) {
                    // 移除调试类
                    this.resizing.container.classList.remove('is-resizing');
                    
                    this.resizing = null;
                    
                    // 使用保存的引用移除事件监听器
                    document.removeEventListener('mousemove', this.boundResizeMouseMove);
                    document.removeEventListener('mouseup', this.boundResizeMouseUp);
                    
                    // 恢复正常状态
                    document.body.style.userSelect = '';
                    document.body.style.cursor = '';
                    
                    console.log('拖动结束，移除事件监听器');
                }
            },
            
            // 处理平移功能
            handlePanning(opt) {
                if (!this.isPanning) return;
                
                const e = opt.e;
                const vpt = this.canvas.viewportTransform;
                vpt[4] += e.clientX - this.lastX;
                vpt[5] += e.clientY - this.lastY;
                this.canvas.requestRenderAll();
                this.lastX = e.clientX;
                this.lastY = e.clientY;
            },
            
            // 关闭编辑园区模态框
            closeEditParkModal() {
                $('#editParkModal').modal('hide');
                console.log('关闭编辑园区模态框');
            },
            
            // 开始线段绘制
            startLineDrawing(pointer) {
                this.isDrawing = true;
                this.startPosition = pointer;
                
                // 创建新线段
                this.drawingShape = new fabric.Line([pointer.x, pointer.y, pointer.x, pointer.y], {
                    stroke: this.strokeColor,
                    strokeWidth: parseInt(this.strokeWidth),
                    selectable: true,
                    type: 'park_shape',
                    _fftype: 'line'
                });
                
                this.canvas.add(this.drawingShape);
            },
            
            // 继续线段绘制
            continueLineDrawing(pointer) {
                if (!this.startPosition) return;
                
                this.drawingShape.set({
                    x2: pointer.x,
                    y2: pointer.y
                });
                
                this.canvas.renderAll();
            },
            
            // 完成线段绘制
            finishLineDrawing() {
                this.isDrawing = false;
                
                // 判断线段长度，如果太短就删除
                const line = this.drawingShape;
                const length = Math.sqrt(
                    Math.pow(line.x2 - line.x1, 2) + 
                    Math.pow(line.y2 - line.y1, 2)
                );
                
                if (length < 5) {
                    this.canvas.remove(line);
                } else {
                    // 将绘制的线段添加到shapes数组
                    this.shapes.push(line);
                }
                
                this.startPosition = null;
                this.drawingShape = null;
                this.canvas.renderAll();
            },
            
            // 删除选中的对象
            deleteSelectedObjects() {
                const activeObject = this.canvas.getActiveObject();
                if (activeObject) {
                    if (activeObject.type === 'activeSelection') {
                        // 删除多个选中的对象
                        activeObject.forEachObject((obj) => {
                            this.canvas.remove(obj);
                            // 从shapes数组中移除
                            const index = this.shapes.indexOf(obj);
                            if (index !== -1) {
                                this.shapes.splice(index, 1);
                            }
                        });
                        this.canvas.discardActiveObject();
                    } else {
                        // 删除单个选中对象
                        this.canvas.remove(activeObject);
                        // 从shapes数组中移除
                        const index = this.shapes.indexOf(activeObject);
                        if (index !== -1) {
                            this.shapes.splice(index, 1);
                        }
                    }
                    this.canvas.renderAll();
                    console.log('删除选中对象');
                } else {
                    alert('请先选择要删除的对象');
                }
            },
            
            // 更新选中对象的样式
            updateSelectedObjectStyles() {
                if (!this.canvas) return;
                
                const activeObject = this.canvas.getActiveObject();
                if (activeObject) {
                    // 应用样式到选中的对象
                    if (activeObject.type === 'activeSelection') {
                        // 多个对象被选中
                        activeObject.forEachObject((obj) => {
                            this.applyStyleToObject(obj);
                        });
                    } else {
                        // 单个对象被选中
                        this.applyStyleToObject(activeObject);
                    }
                    
                    this.canvas.renderAll();
                    console.log('更新选中对象的样式');
                }
            },
            
            // 应用样式到对象
            applyStyleToObject(obj) {
                // 对于所有对象设置线条样式
                obj.set({
                    stroke: this.strokeColor,
                    strokeWidth: parseInt(this.strokeWidth)
                });
                
                // 对于支持填充的对象设置填充样式
                if (obj.type !== 'line' && obj._fftype !== 'line') {
                    obj.set({
                        fill: this.fillEnabled ? this.fillColor : 'transparent'
                    });
                }
            },
            
            // 从加载的对象中更新全局样式设置
            updateGlobalStylesFromObjects(objects) {
                if (!objects || objects.length === 0) return;
                
                // 找到第一个非网格线的对象
                const firstObj = objects.find(obj => !obj.isGridLine);
                if (firstObj) {
                    console.log('从对象恢复全局样式设置:', firstObj);
                    
                    // 更新填充样式
                    if (firstObj._fillEnabled !== undefined) {
                        this.fillEnabled = firstObj._fillEnabled;
                    }
                    if (firstObj._fillColor) {
                        this.fillColor = firstObj._fillColor;
                    }
                    
                    // 更新线条样式
                    if (firstObj._strokeColor) {
                        this.strokeColor = firstObj._strokeColor;
                    }
                    if (firstObj._strokeWidth) {
                        this.strokeWidth = firstObj._strokeWidth;
                    }
                    
                    console.log('样式设置已更新:', 
                        '填充:', this.fillEnabled ? '开启' : '关闭',
                        '填充颜色:', this.fillColor,
                        '线条颜色:', this.strokeColor,
                        '线条宽度:', this.strokeWidth);
                }
            }
        },
        watch: {
            floorCount: function() {
                this.watchFloorCount();
            }
        },
        mounted() {
            // 页面加载完成后执行
            this.loadParks();
            
            // 加载设备列表（用于绑定设备）
            axios.get('/api/devices')
                .then(response => {
                    if (response.data.success) {
                        this.devices = response.data.data || [];
                        this.filteredDevices = [...this.devices];
                    } else {
                        console.error('加载设备列表失败:', response.data.message);
                    }
                })
                .catch(error => {
                    console.error('加载设备列表失败:', error);
                });
            
            // 初始化拖拽功能
            this.initDraggable();
            
            // 初始化编辑器大小调整功能
            this.initResizableEditor();
            
            // 添加窗口大小改变事件监听
            window.addEventListener('resize', this.handleResize);
        },
        
        // 在组件销毁前清理事件监听器
        beforeDestroy() {
            window.removeEventListener('resize', this.handleResize);
            
            // 确保移除任何可能存在的引用事件监听器
            if (this.boundResizeMouseMove) {
                document.removeEventListener('mousemove', this.boundResizeMouseMove);
            }
            if (this.boundResizeMouseUp) {
                document.removeEventListener('mouseup', this.boundResizeMouseUp);
            }
            
            // 清除模态框事件监听器
            $('#editParkModal').off('shown.bs.modal');
        }
    });
</script>
{% endblock %}
