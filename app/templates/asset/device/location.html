{% extends "base.html" %}
{% block title %}设备位置管理{% endblock %}

{% block content %}
<div class="container-fluid" id="locationApp">
    <div class="card shadow mb-4">
        <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
            <h6 class="m-0 font-weight-bold text-primary">设备位置管理</h6>
            <div>
                <a href="/devices/settings" class="btn btn-sm btn-light">
                    <i class="fas fa-arrow-left"></i> 返回设置
                </a>
            </div>
        </div>
        <div class="card-body">
            <div class="mb-4">
                <h4>园区管理</h4>
                <div id="parkCardContainer" class="park-cards d-flex flex-row flex-wrap mb-3">
                    <!-- 使用draggable实现拖拽排序 -->
                    <div v-for="(park, index) in parks" :key="park.id" class="park-card mr-3 mb-3" :data-id="park.id" draggable="true" 
                         @dragstart="dragStart($event, index)" @dragover.prevent @dragenter.prevent 
                         @drop="onDrop($event, index)" @dragend="saveParksOrder">
                        <div class="card" style="width: 200px; cursor: move;" :class="{'border-primary': selectedPark && selectedPark.id === park.id}">
                            <div class="card-img-top bg-light d-flex align-items-center justify-content-center" style="height: 120px;" @click="selectPark(park)">
                                <i class="fas fa-map-marked-alt fa-3x text-primary" v-if="!park.map_data"></i>
                                <img v-else :src="park.map_data" style="max-width: 100%; max-height: 100%;" alt="">
                            </div>
                            <div class="card-body" @click="selectPark(park)">
                                <h5 class="card-title">[[ park.name ]]</h5>
                                <p class="card-text text-muted small">[[ park.code ]]</p>
                            </div>
                            <div class="card-footer p-2 bg-light">
                                <div class="btn-group btn-group-sm w-100">
                                    <button type="button" class="btn btn-outline-primary" @click.stop="editPark(park)">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button type="button" class="btn btn-outline-danger" @click.stop="confirmDeletePark(park)">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 添加园区卡片 -->
                    <div class="park-card mr-3 mb-3">
                        <div class="card" style="width: 200px; cursor: pointer;" @click="showAddParkModal()">
                            <div class="card-img-top bg-light d-flex align-items-center justify-content-center" style="height: 120px;">
                                <i class="fas fa-plus fa-3x text-secondary"></i>
                            </div>
                            <div class="card-body text-center">
                                <h5 class="card-title">添加园区</h5>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 园区详情视图 -->
            <div v-if="selectedPark" class="park-detail mb-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4>[[ selectedPark.name ]] 平面图</h4>
                    <div>
                        <button class="btn btn-primary mr-2" @click="editParkMap()">
                            <i class="fas fa-edit"></i> 编辑平面图
                        </button>
                        <button class="btn btn-success" @click="showAddBuildingModal()">
                            <i class="fas fa-plus"></i> 添加建筑
                        </button>
                    </div>
                </div>
                
                <!-- 园区平面图 -->
                <div class="park-map-container border p-2 mb-3" style="position: relative; min-height: 400px;">
                    <div v-if="!selectedPark.map_data" class="d-flex align-items-center justify-content-center h-100" style="min-height: 400px;">
                        <div class="text-center">
                            <i class="fas fa-draw-polygon fa-3x mb-3 text-muted"></i>
                            <p>暂无平面图，请点击"编辑平面图"进行绘制</p>
                        </div>
                    </div>
                    <div v-else id="parkMapCanvas" style="width: 100%; height: 100%; min-height: 400px;">
                        <!-- 平面图将在JS中渲染 -->
                    </div>
                </div>
            </div>
            
            <!-- 建筑详情视图 -->
            <div v-if="selectedBuilding" class="building-detail">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4>[[ selectedBuilding.name ]] 平面图</h4>
                    <div>
                        <button class="btn btn-primary mr-2" @click="editBuildingMap()">
                            <i class="fas fa-edit"></i> 编辑平面图
                        </button>
                        <button v-if="selectedBuilding.is_multi_floor" class="btn btn-info mr-2" @click="manageFloors()">
                            <i class="fas fa-layer-group"></i> 管理楼层
                        </button>
                        <button class="btn btn-success mr-2" @click="showAddSubBuildingModal()">
                            <i class="fas fa-plus"></i> 添加子建筑
                        </button>
                        <button class="btn btn-warning" @click="addLocationMarker()">
                            <i class="fas fa-map-marker-alt"></i> 添加位置
                        </button>
                    </div>
                </div>
                
                <!-- 建筑平面图 -->
                <div class="building-map-container border p-2" style="position: relative; min-height: 400px;">
                    <div v-if="!selectedBuilding.map_data" class="d-flex align-items-center justify-content-center h-100" style="min-height: 400px;">
                        <div class="text-center">
                            <i class="fas fa-draw-polygon fa-3x mb-3 text-muted"></i>
                            <p>暂无平面图，请点击"编辑平面图"进行绘制</p>
                        </div>
                    </div>
                    <div v-else id="buildingMapCanvas" style="width: 100%; height: 100%; min-height: 400px;">
                        <!-- 平面图将在JS中渲染 -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 添加园区模态框 -->
    <div class="modal fade" id="addParkModal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">添加园区</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <form>
                                <div class="form-group">
                                    <label>园区名称 <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" v-model="parkForm.name" required>
                                </div>
                                <div class="form-group">
                                    <label>园区编码 <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" v-model="parkForm.code" required>
                                </div>
                                <div class="form-group">
                                    <label>描述</label>
                                    <textarea class="form-control" v-model="parkForm.description" rows="3"></textarea>
                                </div>
                            </form>
                        </div>
                        <div class="col-md-6">
                            <h6 class="mb-3">园区平面图</h6>
                            <div class="map-editor-container border p-2 mb-3" style="position: relative; height: 300px; background-color: #f8f9fa;">
                                <div id="parkMapEditor" style="width: 100%; height: 100%;">
                                    <!-- 平面图编辑器将在JS中初始化 -->
                                </div>
                                <div class="map-tools position-absolute" style="top: 10px; right: 10px; z-index: 100;">
                                    <div class="btn-group-vertical">
                                        <button type="button" class="btn btn-sm btn-light" title="矩形工具" @click="activateRectangleTool()">
                                            <i class="fas fa-square"></i>
                                        </button>
                                        <button type="button" class="btn btn-sm btn-light" title="多边形工具" @click="activatePolygonTool()">
                                            <i class="fas fa-draw-polygon"></i>
                                        </button>
                                        <button type="button" class="btn btn-sm btn-light" title="移动工具" @click="activateMoveTool()">
                                            <i class="fas fa-arrows-alt"></i>
                                        </button>
                                        <button type="button" class="btn btn-sm btn-light" title="清除画布" @click="clearCanvas()">
                                            <i class="fas fa-trash-alt"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" @click="savePark()">保存</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 编辑园区模态框 -->
    <div class="modal fade" id="editParkModal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">编辑园区</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <form>
                                <div class="form-group">
                                    <label>园区名称 <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" v-model="editParkForm.name" required>
                                </div>
                                <div class="form-group">
                                    <label>园区编码 <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" v-model="editParkForm.code" required>
                                </div>
                                <div class="form-group">
                                    <label>描述</label>
                                    <textarea class="form-control" v-model="editParkForm.description" rows="3"></textarea>
                                </div>
                            </form>
                        </div>
                        <div class="col-md-6">
                            <h6 class="mb-3">园区平面图</h6>
                            <div class="map-editor-container border p-2 mb-3" style="position: relative; height: 300px; background-color: #f8f9fa;">
                                <div id="editParkMapEditor" style="width: 100%; height: 100%;">
                                    <!-- 平面图编辑器将在JS中初始化 -->
                                </div>
                                <div class="map-tools position-absolute" style="top: 10px; right: 10px; z-index: 100;">
                                    <div class="btn-group-vertical">
                                        <button type="button" class="btn btn-sm btn-light" title="矩形工具" @click="activateRectangleTool()">
                                            <i class="fas fa-square"></i>
                                        </button>
                                        <button type="button" class="btn btn-sm btn-light" title="多边形工具" @click="activatePolygonTool()">
                                            <i class="fas fa-draw-polygon"></i>
                                        </button>
                                        <button type="button" class="btn btn-sm btn-light" title="移动工具" @click="activateMoveTool()">
                                            <i class="fas fa-arrows-alt"></i>
                                        </button>
                                        <button type="button" class="btn btn-sm btn-light" title="清除画布" @click="clearCanvas()">
                                            <i class="fas fa-trash-alt"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" @click="updatePark()">保存修改</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 删除园区确认模态框 -->
    <div class="modal fade" id="deleteParkModal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">确认删除</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p v-if="parkToDelete">您确定要删除园区 "[[ parkToDelete.name ]]" 吗？</p>
                    <p v-else>您确定要删除所选园区吗？</p>
                    <p class="text-danger">此操作不可逆，请谨慎操作。</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-danger" @click="deletePark()">确认删除</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 添加建筑模态框 -->
    <div class="modal fade" id="addBuildingModal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">添加建筑</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form>
                        <div class="form-group">
                            <label>建筑名称 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" v-model="buildingForm.name" required>
                        </div>
                        <div class="form-group">
                            <label>建筑编码 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" v-model="buildingForm.code" required>
                        </div>
                        <div class="form-group">
                            <div class="custom-control custom-checkbox">
                                <input type="checkbox" class="custom-control-input" id="isMultiFloor" v-model="buildingForm.is_multi_floor">
                                <label class="custom-control-label" for="isMultiFloor">多层建筑</label>
                            </div>
                        </div>
                        <div class="form-group" v-if="buildingForm.is_multi_floor">
                            <label>楼层数</label>
                            <input type="number" class="form-control" v-model="buildingForm.floor_count" min="1">
                        </div>
                        <div class="form-group">
                            <label>描述</label>
                            <textarea class="form-control" v-model="buildingForm.description" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" @click="saveBuilding()">保存</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 管理楼层模态框 -->
    <div class="modal fade" id="manageFloorsModal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">管理楼层</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>楼层数</label>
                        <input type="number" class="form-control" v-model="floorCount" min="1">
                    </div>
                    <div v-for="(floor, index) in floors" :key="index" class="form-group">
                        <label>楼层 #[[ index + 1 ]] 名称</label>
                        <input type="text" class="form-control" v-model="floor.name">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" @click="saveFloors()">保存</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 添加位置模态框 -->
    <div class="modal fade" id="addLocationModal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">添加位置</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form>
                        <div class="form-group">
                            <label>位置编码 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" v-model="locationForm.code" required>
                        </div>
                        <div class="form-group">
                            <label>描述</label>
                            <textarea class="form-control" v-model="locationForm.description" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" @click="saveLocation()">保存</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 绑定设备模态框 -->
    <div class="modal fade" id="bindDeviceModal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">绑定设备</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <input type="text" class="form-control" v-model="deviceSearchQuery" placeholder="输入设备资产编号或名称搜索..." @input="searchDevices">
                    </div>
                    <div class="device-list mb-3">
                        <table class="table table-bordered table-hover">
                            <thead>
                                <tr>
                                    <th>资产编号</th>
                                    <th>名称</th>
                                    <th>型号</th>
                                    <th>当前位置</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="device in filteredDevices" :key="device.id">
                                    <td>[[ device.asset_number ]]</td>
                                    <td>[[ device.name ]]</td>
                                    <td>[[ device.model ]]</td>
                                    <td>[[ device.location ? device.location.name : '未设置' ]]</td>
                                    <td>
                                        <button class="btn btn-sm btn-primary" @click="bindDevice(device)">选择</button>
                                    </td>
                                </tr>
                                <tr v-if="filteredDevices.length === 0">
                                    <td colspan="5" class="text-center">无匹配设备</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- 引入绘图相关的库 -->
<script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fabric@5.2.1/dist/fabric.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.14.0/Sortable.min.js"></script>

<script>
    const locationApp = new Vue({
        el: '#locationApp',
        delimiters: ['[[', ']]'],
        data: {
            // 数据模型
            parks: [],
            selectedPark: null,
            selectedBuilding: null,
            parkForm: {
                name: '',
                code: '',
                description: '',
                type: 'park',
                level: 1,
                parent_id: null,
                map_data: null
            },
            editParkForm: {
                id: null,
                name: '',
                code: '',
                description: '',
                type: 'park',
                map_data: null
            },
            parkToDelete: null, // 添加缺失的parkToDelete属性
            deleteParkId: null,
            buildingForm: {
                name: '',
                code: '',
                description: '',
                type: 'building',
                level: 2,
                parent_id: null,
                is_multi_floor: false,
                floor_count: 1,
                floor_names: [],
                map_data: null
            },
            floorForm: {
                floor_count: 1,
                floor_names: []
            },
            locationForm: {
                code: '',
                description: '',
                type: 'location',
                level: 5,
                parent_id: null,
                coordinate_x: null,
                coordinate_y: null,
                width: null,
                height: null
            },
            searchQuery: '',
            deviceSearchResults: [],
            selectedDevice: null,
            
            // 添加缺少的属性
            floorCount: 1,
            floors: [],
            deviceSearchQuery: '',
            filteredDevices: [],
            devices: [], // 添加devices属性用于存储设备列表
            
            // 绘图相关
            parkCanvas: null,     // 园区画布
            buildingCanvas: null, // 建筑画布
            currentTool: null,    // 当前激活的工具
            drawingMode: false,   // 是否处于绘图模式
            tempPoints: []        // 临时点存储（用于多边形绘制）
        },
        methods: {
            // 加载园区列表
            loadParks() {
                // 这里应该调用API获取园区列表
                // 加载园区列表数据
                axios.get('/api/asset/locations', { params: { type: 'park', parent_id: 'root' } })
                    .then(response => {
                        if (response.data.success) {
                            this.parks = response.data.data;
                        } else {
                            console.error('加载园区列表失败:', response.data.message);
                        }
                    })
                    .catch(error => {
                        console.error('加载园区列表失败:', error);
                    });       
            },
            
            // 选择园区
            selectPark(park) {
                this.selectedPark = park;
                this.selectedBuilding = null;
                
                // 加载园区平面图
                this.$nextTick(() => {
                    this.loadParkMap();
                });
            },
            
            // 加载园区平面图
            loadParkMap() {
                if (!this.selectedPark || !this.selectedPark.map_data) return;
                
                const container = document.getElementById('parkMapCanvas');
                if (!container) return;
                
                // 创建画布对象
                this.parkCanvas = new fabric.Canvas('parkMapCanvas', {
                    width: container.offsetWidth,
                    height: container.offsetHeight,
                    selection: false
                });
                
                // 加载地图数据
                try {
                    const mapData = JSON.parse(this.selectedPark.map_data);
                    this.parkCanvas.loadFromJSON(mapData, () => {
                        this.parkCanvas.renderAll();
                        
                        // 加载建筑物
                        this.loadBuildings();
                    });
                } catch (e) {
                    console.error('解析地图数据失败:', e);
                }
            },
            
            // 加载建筑物
            loadBuildings() {
                if (!this.selectedPark) return;
                
                axios.get('/api/asset/locations', { params: { type: 'building', parent_id: this.selectedPark.id } })
                    .then(response => {
                        if (response.data.success) {
                            const buildings = response.data.data;
                            
                            // 在园区平面图上显示建筑物
                            buildings.forEach(building => {
                                if (building.coordinate_x !== null && building.coordinate_y !== null) {
                                    this.renderBuildingOnParkMap(building);
                                }
                            });
                        }
                    })
                    .catch(error => {
                        console.error('加载建筑物失败:', error);
                    });
            },
            
            // 渲染建筑物到园区平面图
            renderBuildingOnParkMap(building) {
                if (!this.parkCanvas) return;
                
                // 创建建筑物表示
                const buildingRect = new fabric.Rect({
                    left: building.coordinate_x,
                    top: building.coordinate_y,
                    width: building.width || 100,
                    height: building.height || 100,
                    fill: '#b3e5fc',
                    stroke: '#29b6f6',
                    strokeWidth: 2,
                    rx: 5,
                    ry: 5,
                    objectCaching: false,
                    buildingId: building.id
                });
                
                // 添加建筑物名称标签
                const buildingLabel = new fabric.Text(building.name, {
                    left: building.coordinate_x + 5,
                    top: building.coordinate_y + 5,
                    fontSize: 14,
                    fill: '#01579b'
                });
                
                // 添加到画布
                this.parkCanvas.add(buildingRect, buildingLabel);
                
                // 点击事件
                buildingRect.on('mousedown', () => {
                    // 打开该建筑物
                    axios.get(`/api/asset/locations/${building.id}`)
                        .then(response => {
                            if (response.data.success) {
                                this.selectedBuilding = response.data.data;
                                this.selectedPark = null;
                                this.loadBuildingMap();
                            }
                        })
                        .catch(error => {
                            console.error('加载建筑物详情失败:', error);
                        });
                });
            },
            
            // 拖拽相关方法 - 开始拖拽
            dragStart(event, index) {
                event.dataTransfer.effectAllowed = 'move';
                event.dataTransfer.setData('parkId', this.parks[index].id);
            },
            
            // 在另一个项上放下
            onDrop(event, index) {
                const draggedParkId = event.dataTransfer.getData('parkId');
                const draggedIndex = this.parks.findIndex(p => p.id.toString() === draggedParkId);
                
                if (draggedIndex === -1 || draggedIndex === index) {
                    return;
                }
                
                // 移动元素
                const movedItem = this.parks.splice(draggedIndex, 1)[0];
                this.parks.splice(index, 0, movedItem);
            },
            
            // 保存园区排序
            saveParksOrder() {
                const orderedIds = this.parks.map(park => park.id);
                
                axios.post('/api/asset/locations/update-order', { ordered_ids: orderedIds })
                    .then(response => {
                        if (!response.data.success) {
                            console.error('保存排序失败:', response.data.message);
                        }
                    })
                    .catch(error => {
                        console.error('保存排序失败:', error);
                    });
            },
            
            // 确认删除园区
            confirmDeletePark(park) {
                this.parkToDelete = park;
                $('#deleteParkModal').modal('show');
            },
            
            // 删除园区
            deletePark() {
                if (!this.parkToDelete || !this.parkToDelete.id) {
                    console.error('需要删除的园区不存在');
                    return;
                }
                
                axios.delete(`/api/asset/locations/${this.parkToDelete.id}`)
                    .then(response => {
                        if (response.data.success) {
                            // 关闭模态框
                            $('#deleteParkModal').modal('hide');
                            
                            // 重新加载园区列表
                            this.loadParks();
                            
                            // 如果当前选中的是要删除的园区，则清除选中状态
                            if (this.selectedPark && this.selectedPark.id === this.parkToDelete.id) {
                                this.selectedPark = null;
                            }
                            
                            // 清除待删除对象
                            this.parkToDelete = null;
                        } else {
                            alert('删除失败: ' + response.data.message);
                        }
                    })
                    .catch(error => {
                        console.error('删除园区失败:', error);
                        alert('删除失败: ' + error.response?.data?.message || error.message);
                    });
            },
            
            // 编辑园区
            editPark(park) {
                // 复制园区数据到编辑表单
                this.editParkForm = {
                    id: park.id,
                    name: park.name,
                    code: park.code,
                    description: park.description || '',
                    type: park.type || 'park',
                    map_data: park.map_data
                };
                
                // 显示编辑模态框
                $('#editParkModal').modal('show');
                
                // 如果有地图数据，初始化地图编辑器
                this.$nextTick(() => {
                    const container = document.getElementById('editParkMapEditor');
                    if (!container) return;
                    
                    // 创建地图编辑器
                    this.parkCanvas = new fabric.Canvas('editParkMapEditor', {
                        width: container.offsetWidth,
                        height: container.offsetHeight,
                        selection: false,
                        backgroundColor: '#f8f9fa'
                    });
                    
                    // 添加网格背景
                    this.drawGrid(this.parkCanvas, 20, '#e0e0e0');
                    
                    // 加载现有地图数据
                    if (park.map_data) {
                        try {
                            const mapData = JSON.parse(park.map_data);
                            this.parkCanvas.loadFromJSON(mapData, () => {
                                this.parkCanvas.renderAll();
                            });
                        } catch (e) {
                            console.error('解析地图数据失败:', e);
                        }
                    }
                });
            },
            
            // 更新园区
            updatePark() {
                // 校验
                if (!this.editParkForm.name) {
                    alert('请输入园区名称');
                    return;
                }
                
                if (!this.editParkForm.code) {
                    alert('请输入园区编码');
                    return;
                }
                
                // 保存绘图数据
                if (this.parkCanvas) {
                    this.editParkForm.map_data = JSON.stringify(this.parkCanvas.toJSON());
                }
                
                // 发送请求
                axios.post('/api/asset/locations', this.editParkForm)
                    .then(response => {
                        if (response.data.success) {
                            // 关闭模态框
                            $('#editParkModal').modal('hide');
                            
                            // 重新加载园区列表
                            this.loadParks();
                            
                            // 如果当前选中的是编辑的园区，则更新选中对象
                            if (this.selectedPark && this.selectedPark.id === this.editParkForm.id) {
                                axios.get(`/api/asset/locations/${this.editParkForm.id}`)
                                    .then(response => {
                                        if (response.data.success) {
                                            this.selectedPark = response.data.data;
                                            this.loadParkMap();
                                        }
                                    })
                                    .catch(error => {
                                        console.error('获取更新后的园区失败:', error);
                                    });
                            }
                        } else {
                            alert('保存失败: ' + response.data.message);
                        }
                    })
                    .catch(error => {
                        console.error('更新园区失败:', error);
                        alert('更新失败: ' + error.response?.data?.message || error.message);
                    });
            },
            
            // 初始化绘图画布
            initMapEditor() {
                // 初始化园区编辑器
                const container = document.getElementById('parkMapEditor');
                if (!container) return;
                
                this.parkCanvas = new fabric.Canvas('parkMapEditor', {
                    width: container.offsetWidth,
                    height: container.offsetHeight,
                    selection: false,
                    backgroundColor: '#f8f9fa'
                });
                
                // 添加网格背景
                this.drawGrid(this.parkCanvas, 20, '#e0e0e0');
            },
            
            // 绘制网格背景
            drawGrid(canvas, gridSize, lineColor) {
                const width = canvas.getWidth();
                const height = canvas.getHeight();
                
                // 创建网格线
                for (let i = 0; i < width/gridSize; i++) {
                    canvas.add(new fabric.Line([i * gridSize, 0, i * gridSize, height], {
                        stroke: lineColor,
                        selectable: false,
                        evented: false,
                        strokeWidth: 0.5
                    }));
                }
                
                for (let i = 0; i < height/gridSize; i++) {
                    canvas.add(new fabric.Line([0, i * gridSize, width, i * gridSize], {
                        stroke: lineColor,
                        selectable: false,
                        evented: false,
                        strokeWidth: 0.5
                    }));
                }
                
                canvas.renderAll();
            },
            
            // 激活矩形工具
            activateRectangleTool() {
                this.currentTool = 'rectangle';
                this.drawingMode = true;
                
                if (!this.parkCanvas) return;
                
                let rect, isDown, origX, origY;
                
                this.parkCanvas.off('mouse:down');
                this.parkCanvas.off('mouse:move');
                this.parkCanvas.off('mouse:up');
                
                this.parkCanvas.on('mouse:down', (o) => {
                    if (!this.drawingMode) return;
                    isDown = true;
                    const pointer = this.parkCanvas.getPointer(o.e);
                    origX = pointer.x;
                    origY = pointer.y;
                    rect = new fabric.Rect({
                        left: origX,
                        top: origY,
                        width: 0,
                        height: 0,
                        fill: '#e3f2fd',
                        stroke: '#1976d2',
                        strokeWidth: 2,
                        selectable: true
                    });
                    this.parkCanvas.add(rect);
                });
                
                this.parkCanvas.on('mouse:move', (o) => {
                    if (!isDown) return;
                    const pointer = this.parkCanvas.getPointer(o.e);
                    
                    if (origX > pointer.x) {
                        rect.set({ left: pointer.x });
                    }
                    if (origY > pointer.y) {
                        rect.set({ top: pointer.y });
                    }
                    
                    rect.set({ width: Math.abs(origX - pointer.x) });
                    rect.set({ height: Math.abs(origY - pointer.y) });
                    
                    this.parkCanvas.renderAll();
                });
                
                this.parkCanvas.on('mouse:up', () => {
                    isDown = false;
                });
            },
            
            // 激活多边形工具
            activatePolygonTool() {
                this.currentTool = 'polygon';
                this.drawingMode = true;
                this.tempPoints = [];
                
                if (!this.parkCanvas) return;
                
                this.parkCanvas.off('mouse:down');
                this.parkCanvas.off('mouse:move');
                this.parkCanvas.off('mouse:up');
                
                this.parkCanvas.on('mouse:down', (o) => {
                    if (!this.drawingMode) return;
                    const pointer = this.parkCanvas.getPointer(o.e);
                    
                    // 检查是否是双击(结束多边形绘制)
                    if (o.e.detail === 2 && this.tempPoints.length >= 3) {
                        // 创建多边形
                        const polygon = new fabric.Polygon(this.tempPoints, {
                            fill: '#e3f2fd',
                            stroke: '#1976d2',
                            strokeWidth: 2,
                            selectable: true
                        });
                        this.parkCanvas.add(polygon);
                        
                        // 清除临时点和线
                        this.tempPoints = [];
                        this.parkCanvas.getObjects().forEach(obj => {
                            if (obj.type === 'circle' || obj.id === 'tempLine') {
                                this.parkCanvas.remove(obj);
                            }
                        });
                        
                        this.parkCanvas.renderAll();
                        return;
                    }
                    
                    // 添加点
                    this.tempPoints.push({ x: pointer.x, y: pointer.y });
                    
                    // 显示点
                    const circle = new fabric.Circle({
                        radius: 5,
                        fill: '#2196f3',
                        left: pointer.x - 5,
                        top: pointer.y - 5,
                        selectable: false
                    });
                    this.parkCanvas.add(circle);
                    
                    // 如果有多个点，画线
                    if (this.tempPoints.length > 1) {
                        const p1 = this.tempPoints[this.tempPoints.length - 2];
                        const p2 = this.tempPoints[this.tempPoints.length - 1];
                        
                        const line = new fabric.Line([p1.x, p1.y, p2.x, p2.y], {
                            stroke: '#2196f3',
                            strokeWidth: 2,
                            selectable: false
                        });
                        this.parkCanvas.add(line);
                    }
                    
                    this.parkCanvas.renderAll();
                });
            },
            
            // 激活移动工具
            activateMoveTool() {
                this.currentTool = 'move';
                this.drawingMode = false;
                
                if (!this.parkCanvas) return;
                
                this.parkCanvas.off('mouse:down');
                this.parkCanvas.off('mouse:move');
                this.parkCanvas.off('mouse:up');
                
                // 启用对象选择和移动
                this.parkCanvas.selection = true;
                this.parkCanvas.getObjects().forEach(obj => {
                    if (obj.type !== 'line' && !obj.isGridLine) {
                        obj.selectable = true;
                        obj.evented = true;
                    }
                });
            },
            
            // 清除画布
            clearCanvas() {
                if (confirm('确定要清除当前绘图吗？')) {
                    if (this.parkCanvas) {
                        this.parkCanvas.clear();
                        this.drawGrid(this.parkCanvas, 20, '#e0e0e0');
                    }
                }
            },
            
            // 显示添加园区模态框
            showAddParkModal() {
                // 重置表单
                this.parkForm = {
                    name: '',
                    code: '',
                    description: '',
                    type: 'park',
                    level: 1,
                    parent_id: null,
                    map_data: null
                };
                
                $('#addParkModal').modal('show');
                
                // 模态框显示后初始化园区编辑器
                this.$nextTick(() => {
                    this.initMapEditor();
                });
            },
            
            // 保存园区
            savePark() {
                // 校验
                if (!this.parkForm.name) {
                    alert('请输入园区名称');
                    return;
                }
                
                if (!this.parkForm.code) {
                    alert('请输入园区编码');
                    return;
                }
                
                // 保存绘图数据
                if (this.parkCanvas) {
                    this.parkForm.map_data = JSON.stringify(this.parkCanvas.toJSON());
                }
                
                // 发送请求
                axios.post('/api/asset/locations', this.parkForm)
                    .then(response => {
                        if (response.data.success) {
                            // 关闭模态框
                            $('#addParkModal').modal('hide');
                            
                            // 重新加载园区列表
                            this.loadParks();
                        } else {
                            alert('保存失败: ' + response.data.message);
                        }
                    })
                    .catch(error => {
                        console.error('保存园区失败:', error);
                        alert('保存失败: ' + error.response?.data?.message || error.message);
                    });
            },
            
            // 编辑园区
            editPark(park) {
                this.editParkForm = {
                    id: park.id,
                    name: park.name,
                    code: park.code,
                    description: park.description || ''
                };
                $('#editParkModal').modal('show');
            },
            
            // 更新园区
            updatePark() {
                // 表单验证
                if (!this.editParkForm.name || !this.editParkForm.code) {
                    alert('请填写园区名称和编码');
                    return;
                }
                
                // TODO: 调用API更新园区
                
                // 在前端更新园区数据
                const parkIndex = this.parks.findIndex(p => p.id === this.editParkForm.id);
                if (parkIndex !== -1) {
                    // 保持原有属性不变
                    const updatedPark = {
                        ...this.parks[parkIndex],
                        name: this.editParkForm.name,
                        code: this.editParkForm.code,
                        description: this.editParkForm.description
                    };
                    
                    this.$set(this.parks, parkIndex, updatedPark);
                    
                    // 如果当前选中的园区就是被编辑的园区，也需要更新 selectedPark
                    if (this.selectedPark && this.selectedPark.id === updatedPark.id) {
                        this.selectedPark = updatedPark;
                    }
                }
                
                $('#editParkModal').modal('hide');
            },
            
            // 确认删除园区
            confirmDeletePark(park) {
                this.parkToDelete = park;
                $('#deleteParkModal').modal('show');
            },
            
            // 删除园区
            deletePark() {
                if (!this.parkToDelete || !this.parkToDelete.id) {
                    return;
                }
                
                // TODO: 调用API删除园区
                
                // 前端删除园区
                const parkIndex = this.parks.findIndex(p => p.id === this.parkToDelete.id);
                if (parkIndex !== -1) {
                    this.parks.splice(parkIndex, 1);
                    
                    // 重新排序
                    this.parks.forEach((park, idx) => {
                        park.sort_order = idx + 1;
                    });
                    
                    // 如果当前选中的园区是被删除的园区，清除选中状态
                    if (this.selectedPark && this.selectedPark.id === this.parkToDelete.id) {
                        this.selectedPark = null;
                    }
                }
                
                $('#deleteParkModal').modal('hide');
            },
            
            // 编辑园区平面图
            editParkMap() {
                // TODO: 实现平面图编辑器
                alert('平面图编辑功能即将开发');
            },
            
            // 显示添加建筑模态框
            showAddBuildingModal() {
                this.buildingForm = {
                    name: '',
                    code: '',
                    description: '',
                    is_multi_floor: false,
                    floor_count: 1
                };
                $('#addBuildingModal').modal('show');
            },
            
            // 保存建筑
            saveBuilding() {
                // TODO: 验证表单
                // TODO: 调用API保存建筑
                
                // 暂时使用模拟数据
                const newBuilding = {
                    id: Date.now(),
                    name: this.buildingForm.name,
                    code: this.buildingForm.code,
                    description: this.buildingForm.description,
                    is_multi_floor: this.buildingForm.is_multi_floor,
                    floor_count: this.buildingForm.floor_count,
                    map_data: null,
                    floors: []
                };
                
                // 如果是多层建筑，初始化楼层
                if (newBuilding.is_multi_floor) {
                    for (let i = 0; i < newBuilding.floor_count; i++) {
                        newBuilding.floors.push({
                            id: Date.now() + i,
                            name: `F${i+1}`,
                            map_data: null
                        });
                    }
                }
                
                // 添加到园区的建筑列表
                if (!this.selectedPark.buildings) {
                    this.selectedPark.buildings = [];
                }
                this.selectedPark.buildings.push(newBuilding);
                
                // 选中新建筑
                this.selectedBuilding = newBuilding;
                $('#addBuildingModal').modal('hide');
            },
            
            // 编辑建筑平面图
            editBuildingMap() {
                // TODO: 实现平面图编辑器
                alert('建筑平面图编辑功能即将开发');
            },
            
            // 管理楼层
            manageFloors() {
                if (this.selectedBuilding && this.selectedBuilding.is_multi_floor) {
                    this.floorCount = this.selectedBuilding.floor_count || 1;
                    this.floors = [];
                    
                    // 如果已有楼层数据，则加载
                    if (this.selectedBuilding.floors && this.selectedBuilding.floors.length > 0) {
                        this.floors = [...this.selectedBuilding.floors];
                    } else {
                        // 否则创建默认楼层
                        for (let i = 0; i < this.floorCount; i++) {
                            this.floors.push({
                                name: `F${i+1}`
                            });
                        }
                    }
                    
                    $('#manageFloorsModal').modal('show');
                }
            },
            
            // 监听楼层数量变化
            watchFloorCount() {
                // 当楼层数量变化时，动态调整楼层列表
                const newCount = parseInt(this.floorCount) || 1;
                const currentCount = this.floors.length;
                
                if (newCount > currentCount) {
                    // 增加楼层
                    for (let i = currentCount; i < newCount; i++) {
                        this.floors.push({
                            name: `F${i+1}`
                        });
                    }
                } else if (newCount < currentCount) {
                    // 减少楼层
                    this.floors = this.floors.slice(0, newCount);
                }
            },
            
            // 保存楼层设置
            saveFloors() {
                if (this.selectedBuilding) {
                    this.selectedBuilding.floor_count = this.floorCount;
                    this.selectedBuilding.floors = [...this.floors];
                    $('#manageFloorsModal').modal('hide');
                }
            },
            
            // 显示添加子建筑模态框
            showAddSubBuildingModal() {
                // 与添加建筑类似，但父级为当前选中的建筑
                this.buildingForm = {
                    name: '',
                    code: '',
                    description: '',
                    is_multi_floor: false,
                    floor_count: 1
                };
                $('#addBuildingModal').modal('show');
            },
            
            // 添加位置标记
            addLocationMarker() {
                this.locationForm = {
                    code: '',
                    description: ''
                };
                $('#addLocationModal').modal('show');
            },
            
            // 保存位置
            saveLocation() {
                // TODO: 验证表单
                // TODO: 调用API保存位置
                
                // 暂时使用模拟数据
                const newLocation = {
                    id: Date.now(),
                    code: this.locationForm.code,
                    description: this.locationForm.description,
                    x: 100, // 默认位置
                    y: 100,
                    width: 50,
                    height: 50
                };
                
                // 添加到当前容器的位置列表
                let container = this.selectedFloor || this.selectedBuilding;
                if (!container.locations) {
                    container.locations = [];
                }
                container.locations.push(newLocation);
                
                $('#addLocationModal').modal('hide');
                
                // TODO: 在平面图上添加位置方块
            },
            
            // 搜索设备
            searchDevices() {
                // 筛选设备列表
                if (this.deviceSearchQuery) {
                    const query = this.deviceSearchQuery.toLowerCase();
                    this.filteredDevices = this.devices.filter(device => {
                        return device.asset_number.toLowerCase().includes(query) || 
                               (device.name && device.name.toLowerCase().includes(query));
                    });
                } else {
                    this.filteredDevices = [...this.devices];
                }
            },
            
            // 绑定设备
            bindDevice(device) {
                // TODO: 调用API绑定设备到位置
                
                // 暂时模拟绑定逻辑
                if (this.selectedLocation) {
                    this.selectedLocation.device_id = device.id;
                    this.selectedLocation.device = {
                        asset_number: device.asset_number,
                        name: device.name
                    };
                }
                
                $('#bindDeviceModal').modal('hide');
            }
        },
        watch: {
            floorCount: function() {
                this.watchFloorCount();
            }
        },
        mounted() {
            // 加载园区列表
            this.loadParks();
            
            // 加载设备列表（用于绑定设备）
            // TODO: 调用API加载设备列表
            axios.get('/api/devices')
                .then(response => {
                    if (response.data.success) {
                        this.devices = response.data.data || [];
                        this.filteredDevices = [...this.devices];
                    } else {
                        console.error('加载设备列表失败:', response.data.message);
                    }
                })
                .catch(error => {
                    console.error('加载设备列表失败:', error);
                });
        }
    });
</script>
{% endblock %}
