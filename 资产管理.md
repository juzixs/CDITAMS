# 资产管理模块

## 概述

资产管理模块是CDITAMS系统的核心功能之一，用于管理企业的设备资产。该模块提供完整的资产管理功能，包括设备基本信息管理和资产分类管理等功能。

---

## 资产分类管理

### 功能概述

资产分类管理用于建立设备的分类体系，支持多级分类（最多4级），便于对设备进行归类和统计。

### 分类层级设计

- **一级分类**: 如 IT设备、办公设备、生产设备
- **二级分类**: 如 IT设备 → 计算机、服务器、网络设备
- **三级分类**: 如 计算机 → 台式机、笔记本、平板
- **四级分类**: 如 台式机 → 品牌台式机、组装台式机

### 当前分类数据

系统当前共 **46** 条分类数据，按层级展示如下：

#### 一级分类（2条）

| ID | 名称 | 编码 | 描述 |
|----|------|------|------|
| 1 | 西安驰达 | XACD | 西安驰达飞机零部件制造股份有限公司 |
| 3 | 西安优盛 | XAYS | 西安优盛航空科技有限公司 |

#### 二级分类（2条）

| ID | 名称 | 编码 | 父分类 |
|----|------|------|--------|
| 2 | 总经办 | Z | 西安驰达 (ID:1) |
| 25 | 总经办 | Z | 西安优盛 (ID:3) |

#### 三级分类（6条）

| ID | 名称 | 编码 | 父分类 |
|----|------|------|--------|
| 4 | 计算机 | 001 | 总经办 (ID:2) |
| 26 | 计算机 | 001 | 总经办 (ID:25) |
| 9 | 办公设备 | 002 | 总经办 (ID:2) |
| 27 | 办公设备 | 002 | 总经办 (ID:25) |
| 19 | 信息设备 | 003 | 总经办 (ID:2) |
| 28 | 信息设备 | 003 | 总经办 (ID:25) |

#### 四级分类（36条）

**计算机类别下：**

| ID | 名称 | 编码 | 父分类 |
|----|------|------|--------|
| 5 | 台式机 | 001 | 计算机 (ID:4) |
| 6 | 笔记本 | 002 | 计算机 (ID:4) |
| 7 | 显示器 | 003 | 计算机 (ID:4) |
| 8 | 其他 | 004 | 计算机 (ID:4) |
| 29 | 台式机 | 001 | 计算机 (ID:26) |
| 30 | 笔记本 | 002 | 计算机 (ID:26) |
| 31 | 显示器 | 003 | 计算机 (ID:26) |
| 32 | 其他 | 004 | 计算机 (ID:26) |

**办公设备类别下：**

| ID | 名称 | 编码 | 父分类 |
|----|------|------|--------|
| 10 | 空调 | 001 | 办公设备 (ID:9) |
| 11 | 打印机 | 002 | 办公设备 (ID:9) |
| 12 | 扫描仪 | 003 | 办公设备 (ID:9) |
| 13 | 传真机 | 004 | 办公设备 (ID:9) |
| 14 | 投影仪 | 005 | 办公设备 (ID:9) |
| 15 | 交换机 | 006 | 办公设备 (ID:9) |
| 16 | 平板一体机 | 007 | 办公设备 (ID:9) |
| 17 | 照相机 | 008 | 办公设备 (ID:9) |
| 18 | 其他 | 009 | 办公设备 (ID:9) |
| 33 | 空调 | 001 | 办公设备 (ID:27) |
| 34 | 打印机 | 002 | 办公设备 (ID:27) |
| 35 | 扫描仪 | 003 | 办公设备 (ID:27) |
| 36 | 传真机 | 004 | 办公设备 (ID:27) |
| 37 | 投影仪 | 005 | 办公设备 (ID:27) |
| 38 | 交换机 | 006 | 办公设备 (ID:27) |
| 39 | 平板一体机 | 007 | 办公设备 (ID:27) |
| 40 | 照相机 | 008 | 办公设备 (ID:27) |
| 41 | 其他 | 009 | 办公设备 (ID:27) |

**信息设备类别下：**

| ID | 名称 | 编码 | 父分类 |
|----|------|------|--------|
| 20 | 服务器 | 001 | 信息设备 (ID:19) |
| 21 | 存储器 | 002 | 信息设备 (ID:19) |
| 22 | 监控设备 | 003 | 信息设备 (ID:19) |
| 23 | 监控系统 | 004 | 信息设备 (ID:19) |
| 24 | 其他 | 005 | 信息设备 (ID:19) |
| 42 | 服务器 | 001 | 信息设备 (ID:28) |
| 43 | 存储器 | 002 | 信息设备 (ID:28) |
| 44 | 监控设备 | 003 | 信息设备 (ID:28) |
| 45 | 监控系统 | 004 | 信息设备 (ID:28) |
| 46 | 其他 | 005 | 信息设备 (ID:28) |

### 分类结构图

```
西安驰达 (XACD)
└── 总经办 (Z)
    ├── 计算机 (001)
    │   ├── 台式机 (001)
    │   ├── 笔记本 (002)
    │   ├── 显示器 (003)
    │   └── 其他 (004)
    ├── 办公设备 (002)
    │   ├── 空调 (001)
    │   ├── 打印机 (002)
    │   ├── 扫描仪 (003)
    │   ├── 传真机 (004)
    │   ├── 投影仪 (005)
    │   ├── 交换机 (006)
    │   ├── 平板一体机 (007)
    │   ├── 照相机 (008)
    │   └── 其他 (009)
    └── 信息设备 (003)
        ├── 服务器 (001)
        ├── 存储器 (002)
        ├── 监控设备 (003)
        ├── 监控系统 (004)
        └── 其他 (005)

西安优盛 (XAYS)
└── 总经办 (Z)
    ├── 计算机 (001)
    │   ├── 台式机 (001)
    │   ├── 笔记本 (002)
    │   ├── 显示器 (003)
    │   └── 其他 (004)
    ├── 办公设备 (002)
    │   ├── 空调 (001)
    │   ├── 打印机 (002)
    │   ├── 扫描仪 (003)
    │   ├── 传真机 (004)
    │   ├── 投影仪 (005)
    │   ├── 交换机 (006)
    │   ├── 平板一体机 (007)
    │   ├── 照相机 (008)
    │   └── 其他 (009)
    └── 信息设备 (003)
        ├── 服务器 (001)
        ├── 存储器 (002)
        ├── 监控设备 (003)
        ├── 监控系统 (004)
        └── 其他 (005)
```

---

### 详细实现

#### 1. 获取分类列表

- **路由:** `GET /api/asset/categories`
- **权限:** 需要登录 (`@login_required`)
- **功能:** 获取所有资产分类，按层级和ID排序

**实现逻辑:**

```python
@asset.route('/api/asset/categories', methods=['GET'])
@login_required
def get_categories():
    # 按level和id排序，确保层级顺序
    categories = AssetCategory.query.order_by(AssetCategory.level, AssetCategory.id).all()
    
    result = []
    for category in categories:
        result.append({
            'id': category.id,
            'name': category.name,
            'level': category.level,
            'parent_id': category.parent_id,
            'code': category.code,
            'description': category.description
        })
    
    return jsonify({'success': True, 'data': result})
```

**返回数据示例:**
```json
{
  "success": true,
  "data": [
    {
      "id": 1,
      "name": "西安驰达",
      "level": 1,
      "parent_id": null,
      "code": "XACD",
      "description": "西安驰达飞机零部件制造股份有限公司"
    },
    {
      "id": 2,
      "name": "总经办",
      "level": 2,
      "parent_id": 1,
      "code": "Z",
      "description": ""
    }
  ]
}
```

---

#### 2. 保存分类

- **路由:** `POST /api/asset/categories`
- **权限:** 需要登录 (`@login_required`)
- **功能:** 新增或编辑资产分类

**实现逻辑:**

```python
@asset.route('/api/asset/categories', methods=['POST'])
@login_required
def save_category():
    data = request.json
    
    # 判断是新增还是编辑
    category_id = data.get('id')
    if category_id:
        # 编辑模式：获取现有分类
        category = AssetCategory.query.get_or_404(category_id)
    else:
        # 新增模式：创建新对象
        category = AssetCategory()
    
    # 必填项验证
    if not data.get('name'):
        return jsonify({'success': False, 'message': '分类名称不能为空'}), 400
    
    if not data.get('code'):
        return jsonify({'success': False, 'message': '分类编码不能为空'}), 400
    
    # 设置属性值
    for key, value in data.items():
        if key != 'id' and hasattr(category, key):
            setattr(category, key, value)
    
    # 自动计算分类级别
    if category.parent_id:
        parent = AssetCategory.query.get(category.parent_id)
        if parent:
            category.level = parent.level + 1
            # 级别校验：最高4级
            if category.level > 4:
                return jsonify({'success': False, 'message': '分类最多支持4级'}), 400
        else:
            category.level = 1
    else:
        category.level = 1
    
    # 保存到数据库
    try:
        if not category_id:
            db.session.add(category)
        db.session.commit()
        return jsonify({'success': True, 'message': '保存成功', 'id': category.id})
    except Exception as e:
        db.session.rollback()
        return jsonify({'success': False, 'message': f'保存失败: {str(e)}'}), 500
```

**请求数据示例:**
```json
{
  "name": "服务器",
  "code": "IT-SERVER",
  "parent_id": 1,
  "description": "服务器设备分类"
}
```

**关键逻辑说明:**

1. **ID判断编辑/新增**: 通过传入的 `id` 字段判断是新增还是编辑操作

2. **必填验证**: 分类名称 (name) 和分类编码 (code) 为必填项

3. **自动计算层级**: 根据父分类的级别自动计算当前分类的级别
   - 无父分类：level = 1
   - 有父分类：level = 父分类.level + 1
   - 最高支持4级分类

4. **异常处理**: 使用事务处理，失败时回滚

---

#### 3. 删除分类

- **路由:** `DELETE /api/asset/categories/<id>`
- **权限:** 需要登录 (`@login_required`)
- **功能:** 删除资产分类

**实现逻辑:**

```python
@asset.route('/api/asset/categories/<int:id>', methods=['DELETE'])
@login_required
def delete_category(id):
    category = AssetCategory.query.get_or_404(id)
    
    # 检查是否有子分类
    if AssetCategory.query.filter_by(parent_id=id).first():
        return jsonify({'success': False, 'message': '该分类下有子分类，无法删除'}), 400
    
    # 检查是否有设备使用该分类
    if Device.query.filter_by(category_id=id).first():
        return jsonify({'success': False, 'message': '该分类下有设备，无法删除'}), 400
    
    try:
        db.session.delete(category)
        db.session.commit()
        return jsonify({'success': True, 'message': '删除成功'})
    except Exception as e:
        db.session.rollback()
        return jsonify({'success': False, 'message': f'删除失败: {str(e)}'}), 500
```

**删除条件检查:**

1. **子分类检查**: 查询是否存在 `parent_id` 指向当前分类的记录
2. **设备检查**: 查询是否有设备关联到该分类 (通过 `category_id`)
3. **只有通过两项检查才能删除**

**返回数据示例:**
```json
{
  "success": true,
  "message": "删除成功"
}
```

---

## 资产编号自动生成

### 功能概述

资产编号自动生成功能根据资产分类自动生成唯一的资产编号，编号格式为 `{分类编码序列}-{序号}`，序号自动递增。

### 编号规则

- **格式**: `{一级分类编码}-{二级分类编码}-{...}-{三级分类编码}-{序号}`
- **序号**: 3位数字，不足补零 (001, 002, ..., 999)
- **示例**: 
  - 西安驰达 → 总经办 → 计算机 → 台式机
  - 分类编码: XACD-Z-001-001
  - 生成的资产编号: XACD-Z-001-001-001

### 详细实现

#### 核心代码

```python
@asset.route('/api/devices/generate-asset-number', methods=['POST'])
@login_required
def generate_asset_number():
    category_id = request.json.get('category_id')
    
    if not category_id:
        return jsonify({'success': False, 'message': '请选择分类'}), 400
    
    try:
        # 1. 获取分类信息
        category = AssetCategory.query.get_or_404(category_id)
        
        # 2. 从当前分类回溯到顶级分类，收集所有编码
        parent_codes = []
        current = category
        
        while current:
            # 将当前分类编码插入到列表开头
            parent_codes.insert(0, current.code)
            # 如果有父分类，继续回溯
            if current.parent_id:
                current = AssetCategory.query.get(current.parent_id)
            else:
                break
        
        # 3. 构建基础资产编号前缀
        asset_number_prefix = '-'.join(parent_codes)
        
        # 4. 查找同前缀的最大编号
        max_device = Device.query.filter(
            Device.asset_number.like(f"{asset_number_prefix}-%")
        ).order_by(Device.asset_number.desc()).first()
        
        # 5. 生成新序号
        if max_device:
            # 提取最后一个序号并递增
            last_part = max_device.asset_number.split('-')[-1]
            try:
                new_seq = int(last_part) + 1
                new_seq_str = f"{new_seq:03d}"  # 格式化为3位数字
            except ValueError:
                new_seq_str = "001"
        else:
            new_seq_str = "001"
        
        # 6. 构建完整的资产编号
        new_asset_number = f"{asset_number_prefix}-{new_seq_str}"
        
        return jsonify({
            'success': True,
            'asset_number': new_asset_number
        })
    except Exception as e:
        return jsonify({'success': False, 'message': f'生成资产编号失败: {str(e)}'}), 500
```

---

#### 逻辑详解

**Step 1: 参数验证**
- 验证 `category_id` 是否存在
- 如果未选择分类，返回错误信息

**Step 2: 分类编码回溯**
- 从当前分类开始，向上追溯到顶级分类
- 使用 `while` 循环 + `parent_id` 实现
- 使用 `insert(0, code)` 保证编码顺序正确
- 最终得到编码列表: `[一级编码, 二级编码, 三级编码, ...]`

**示例:**
```
当前分类: "台式机" (code: 001, parent_id: 指向 "计算机")
 ↓
"计算机" (code: 001, parent_id: 指向 "总经办")
 ↓
"总经办" (code: Z, parent_id: 指向 "西安驰达")
 ↓
"西安驰达" (code: XACD, parent_id: null)

parent_codes = ['XACD', 'Z', '001', '001']
```

**Step 3: 构建前缀**
- 使用 `-` 连接所有分类编码
- `asset_number_prefix = 'XACD-Z-001-001'`

**Step 4: 查询最大序号**
- 使用 `LIKE` 查询匹配前缀的所有设备
- 按资产编号降序排列，获取最大的那个
- SQL: `SELECT * FROM devices WHERE asset_number LIKE 'XACD-Z-001-001-%' ORDER BY asset_number DESC LIMIT 1`

**Step 5: 序号生成**
- 如果存在最大编号:
  - 提取最后一段（序号部分）
  - 转换为整数 + 1
  - 格式化为3位数字 (不足补零)
- 如果不存在（首个设备）:
  - 序号设为 "001"

**示例:**
```
最大资产编号: XACD-Z-001-001-005
last_part = "005" → int("005") = 5 → 5 + 1 = 6 → "006"

新资产编号: XACD-Z-001-001-006
```

**Step 6: 返回结果**
- 返回完整的资产编号
- 前端可自动填充到表单

---

#### 请求响应示例

**请求:**
```json
{
  "category_id": 5
}
```

**响应:**
```json
{
  "success": true,
  "asset_number": "XACD-Z-001-001-001"
}
```

---

## 设备管理

### 功能概述

设备管理是资产管理的核心功能，包括设备的增删改查、批量操作等。

---

### 1. 设备列表

- **路由:** `GET /api/devices`
- **功能:** 分页展示设备列表，支持搜索

**请求参数:**

| 参数 | 类型 | 说明 |
|------|------|------|
| page | Integer | 页码 (默认: 1) |
| size | Integer | 每页数量 (默认: 10) |
| search | String | 搜索关键词 |

**搜索字段:** 资产编号、设备编号、设备名称、型号、序列号

---

### 2. 保存设备

- **路由:** `POST /api/devices`
- **功能:** 新增或编辑设备

**验证规则:**
- category_id: 必填
- asset_number: 必填，需唯一

**逻辑:**
1. 判断新增或编辑（通过id字段）
2. 分离自定义字段（设备模型没有的属性）
3. 保存设备基本信息
4. 保存自定义字段值

---

### 3. 删除设备

- **路由:** `DELETE /api/devices/<id>`
- **功能:** 删除单个设备

- **路由:** `DELETE /api/devices/batch`
- **功能:** 批量删除设备

---

## 权限控制

所有资产管理相关路由都需要用户登录后才能访问，使用 `@login_required` 装饰器进行保护。
